

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyaerocom.io.readgridded &mdash; pyaerocom  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> pyaerocom
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#aerocom">AeroCom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#citation">Citation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#website-and-code-documentation">Website and code documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#requirements">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#installation-of-pyaerocom">Installation of pyaerocom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#access-to-users-database">Access to users database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#getting-started">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyaerocom</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyaerocom.io.readgridded</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyaerocom.io.readgridded</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1">################################################################</span>
<span class="c1"># readgridded.py</span>
<span class="c1">#</span>
<span class="c1"># model data reading class</span>
<span class="c1">#</span>
<span class="c1"># this file is part of the aerocom_pt package</span>
<span class="c1">#</span>
<span class="c1">#################################################################</span>
<span class="c1"># Created 20171030 by Jan Griesfeller for Met Norway</span>
<span class="c1">#</span>
<span class="c1"># Last changed: See git log</span>
<span class="c1">#################################################################</span>

<span class="c1">#Copyright (C) 2017 met.no</span>
<span class="c1">#Contact information:</span>
<span class="c1">#Norwegian Meteorological Institute</span>
<span class="c1">#Box 43 Blindern</span>
<span class="c1">#0313 OSLO</span>
<span class="c1">#NORWAY</span>
<span class="c1">#E-mail: jan.griesfeller@met.no</span>
<span class="c1">#This program is free software; you can redistribute it and/or modify</span>
<span class="c1">#it under the terms of the GNU General Public License as published by</span>
<span class="c1">#the Free Software Foundation; either version 3 of the License, or</span>
<span class="c1">#(at your option) any later version.</span>
<span class="c1">#This program is distributed in the hope that it will be useful,</span>
<span class="c1">#but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1">#GNU General Public License for more details.</span>
<span class="c1">#You should have received a copy of the GNU General Public License</span>
<span class="c1">#along with this program; if not, write to the Free Software</span>
<span class="c1">#Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,</span>
<span class="c1">#MA 02110-1301, USA</span>

<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span> <span class="k">as</span> <span class="n">od</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">iris</span>

<span class="kn">from</span> <span class="nn">pyaerocom</span> <span class="kn">import</span> <span class="n">const</span><span class="p">,</span> <span class="n">print_log</span><span class="p">,</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">pyaerocom.metastandards</span> <span class="kn">import</span> <span class="n">AerocomDataID</span>
<span class="kn">from</span> <span class="nn">pyaerocom.variable</span> <span class="kn">import</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">is_3d</span>
<span class="kn">from</span> <span class="nn">pyaerocom.tstype</span> <span class="kn">import</span> <span class="n">TsType</span>
<span class="kn">from</span> <span class="nn">pyaerocom.io.aux_read_cubes</span> <span class="kn">import</span> <span class="p">(</span><span class="n">compute_angstrom_coeff_cubes</span><span class="p">,</span>
                                         <span class="n">multiply_cubes</span><span class="p">,</span>
                                         <span class="n">subtract_cubes</span><span class="p">,</span>
                                         <span class="n">add_cubes</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyaerocom.helpers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">to_pandas_timestamp</span><span class="p">,</span>
                               <span class="n">sort_ts_types</span><span class="p">,</span>
                               <span class="n">get_highest_resolution</span><span class="p">,</span>
                               <span class="n">isnumeric</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyaerocom.exceptions</span> <span class="kn">import</span> <span class="p">(</span><span class="n">DataCoverageError</span><span class="p">,</span>
                                  <span class="n">DataQueryError</span><span class="p">,</span>
                                  <span class="n">DataSourceError</span><span class="p">,</span>
                                  <span class="n">FileConventionError</span><span class="p">,</span>
                                  <span class="n">IllegalArgumentError</span><span class="p">,</span>
                                  <span class="n">TemporalResolutionError</span><span class="p">,</span>
                                  <span class="n">VarNotAvailableError</span><span class="p">,</span>
                                  <span class="n">VariableDefinitionError</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyaerocom.io.fileconventions</span> <span class="kn">import</span> <span class="n">FileConventionRead</span>
<span class="kn">from</span> <span class="nn">pyaerocom.io</span> <span class="kn">import</span> <span class="n">AerocomBrowser</span>
<span class="kn">from</span> <span class="nn">pyaerocom.io.iris_io</span> <span class="kn">import</span> <span class="n">load_cubes_custom</span><span class="p">,</span> <span class="n">concatenate_iris_cubes</span>
<span class="kn">from</span> <span class="nn">pyaerocom.io.helpers</span> <span class="kn">import</span> <span class="n">add_file_to_log</span>
<span class="kn">from</span> <span class="nn">pyaerocom.griddeddata</span> <span class="kn">import</span> <span class="n">GriddedData</span>

<div class="viewcode-block" id="ReadGridded"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded">[docs]</a><span class="k">class</span> <span class="nc">ReadGridded</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for reading gridded files based on network or model ID</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The reading only works if files are stored using a valid file naming</span>
<span class="sd">    convention. See package data file `file_conventions.ini &lt;http://</span>
<span class="sd">    aerocom.met.no/pyaerocom/config_files.html#file-conventions&gt;`__ for valid</span>
<span class="sd">    keys. You may define your own fileconvention in this file, if you wish.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    data_id : str</span>
<span class="sd">        string ID for model or obsdata network (see e.g. Aerocom interface map</span>
<span class="sd">        plots lower left corner)</span>
<span class="sd">    data : GriddedData</span>
<span class="sd">        imported data object</span>
<span class="sd">    data_dir : str</span>
<span class="sd">        directory containing result files for this model</span>
<span class="sd">    start : pandas.Timestamp</span>
<span class="sd">        start time for data import</span>
<span class="sd">    stop : pandas.Timestamp</span>
<span class="sd">        stop time for data import</span>
<span class="sd">    file_convention : FileConventionRead</span>
<span class="sd">        class specifying details of the file naming convention for the model</span>
<span class="sd">    files : list</span>
<span class="sd">        list containing all filenames that were found.</span>
<span class="sd">        Filled, e.g. in :func:`ReadGridded.get_model_files`</span>
<span class="sd">    from_files : list</span>
<span class="sd">        List of all netCDF files that were used to concatenate the current</span>
<span class="sd">        data cube (i.e. that can be based on certain matching settings such as</span>
<span class="sd">        var_name or time interval).</span>
<span class="sd">    ts_types : list</span>
<span class="sd">        list of all sampling frequencies (e.g. hourly, daily, monthly) that</span>
<span class="sd">        were inferred from filenames (based on Aerocom file naming convention)</span>
<span class="sd">        of all files that were found</span>
<span class="sd">    vars : list</span>
<span class="sd">        list containing all variable names (e.g. od550aer) that were inferred</span>
<span class="sd">        from filenames based on Aerocom model file naming convention</span>
<span class="sd">    years : list</span>
<span class="sd">        list of available years as inferred from the filenames in the data</span>
<span class="sd">        directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_id : str</span>
<span class="sd">        string ID of model (e.g. &quot;AATSR_SU_v4.3&quot;,&quot;CAM5.3-Oslo_CTRL2016&quot;)</span>
<span class="sd">    data_dir : str, optional</span>
<span class="sd">        directory containing data files. If provided, only this directory is</span>
<span class="sd">        considered for data files, else the input `data_id` is used to search</span>
<span class="sd">        for the corresponding directory.</span>
<span class="sd">    file_convention : str</span>
<span class="sd">        string ID specifying the file convention of this model (cf.</span>
<span class="sd">        installation file `file_conventions.ini &lt;https://github.com/metno/</span>
<span class="sd">        pyaerocom/blob/master/pyaerocom/data/file_conventions.ini&gt;`__)</span>
<span class="sd">    init : bool</span>
<span class="sd">        if True, the model directory is searched (:func:`search_data_dir`) on</span>
<span class="sd">        instantiation and if it is found, all valid files for this model are</span>
<span class="sd">        searched using :func:`search_all_files`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CONSTRAINT_OPERATORS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;==&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">,</span>
                            <span class="s1">&#39;&lt;&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">,</span>
                            <span class="s1">&#39;&lt;=&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">less_equal</span><span class="p">,</span>
                            <span class="s1">&#39;&gt;&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">,</span>
                            <span class="s1">&#39;&gt;=&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">}</span>


    <span class="n">AUX_REQUIRES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ang4487aer&#39;</span>    <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;od440aer&#39;</span><span class="p">,</span> <span class="s1">&#39;od870aer&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;od550gt1aer&#39;</span>   <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;od550aer&#39;</span><span class="p">,</span> <span class="s1">&#39;od550lt1aer&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;wetoa&#39;</span>         <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;wetpoa&#39;</span><span class="p">,</span> <span class="s1">&#39;wetsoa&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;dryoa&#39;</span>         <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;drypoa&#39;</span><span class="p">,</span> <span class="s1">&#39;drysoa&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;conc*&#39;</span>         <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;mmr*&#39;</span><span class="p">,</span> <span class="s1">&#39;rho&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sc550dryaer&#39;</span>   <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;ec550dryaer&#39;</span><span class="p">,</span> <span class="s1">&#39;ac550dryaer&#39;</span><span class="p">),</span>
                    <span class="c1">#&#39;mec550*&#39;       : [&#39;od550*&#39;, &#39;load*&#39;],</span>
                    <span class="c1">#&#39;tau*&#39;          : [&#39;load*&#39;, &#39;wet*&#39;, &#39;dry*&#39;] #DOES NOT WORK POINT BY POINT</span>
                    <span class="p">}</span>

    <span class="n">AUX_ALT_VARS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;od440aer&#39;</span>      <span class="p">:</span>   <span class="p">[</span><span class="s1">&#39;od443aer&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;od870aer&#39;</span>      <span class="p">:</span>   <span class="p">[</span><span class="s1">&#39;od865aer&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;ac550dryaer&#39;</span>   <span class="p">:</span>   <span class="p">[</span><span class="s1">&#39;ac550aer&#39;</span><span class="p">]}</span>

    <span class="n">AUX_FUNS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ang4487aer&#39;</span>   <span class="p">:</span>    <span class="n">compute_angstrom_coeff_cubes</span><span class="p">,</span>
                <span class="s1">&#39;od550gt1aer&#39;</span>  <span class="p">:</span>    <span class="n">subtract_cubes</span><span class="p">,</span>
                <span class="s1">&#39;wetoa&#39;</span>        <span class="p">:</span>    <span class="n">add_cubes</span><span class="p">,</span>
                <span class="s1">&#39;dryoa&#39;</span>        <span class="p">:</span>    <span class="n">add_cubes</span><span class="p">,</span>
                <span class="s1">&#39;sc550dryaer&#39;</span>  <span class="p">:</span>    <span class="n">subtract_cubes</span><span class="p">,</span>
                <span class="s1">&#39;conc*&#39;</span>        <span class="p">:</span>    <span class="n">multiply_cubes</span><span class="p">,</span>
                <span class="c1">#&#39;mec550*&#39;      :    divide_cubes,</span>
                <span class="c1">#&#39;tau*&#39;         :    lifetime_from_load_and_dep</span>
                <span class="p">}</span>

    <span class="n">_data_dir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">VERT_ALT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Surface&#39;</span> <span class="p">:</span> <span class="s1">&#39;ModelLevel&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_convention</span><span class="o">=</span><span class="s2">&quot;aerocom3&quot;</span><span class="p">,</span>
                 <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#: data_id of gridded dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_id</span> <span class="o">=</span> <span class="n">data_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>

        <span class="c1"># file naming convention. Default is aerocom3 file convention, change</span>
        <span class="c1"># using self.file_convention.import_default(&quot;aerocom2&quot;). Is</span>
        <span class="c1"># automatically updated in class ReadGridded</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_convention</span> <span class="o">=</span> <span class="n">FileConventionRead</span><span class="p">(</span><span class="n">file_convention</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#: List of unique Aerocom variable names that were identified from</span>
        <span class="c1">#: the filenames in the data directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vars_2d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vars_3d</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#: This object can be used to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">AerocomBrowser</span><span class="p">()</span>

        <span class="c1"># these can be filled using method add_aux_compute and they will not</span>
        <span class="c1"># affect global settings of the reader class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aux_requires</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aux_funs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">#: quick access to variables that can be computed (will be filled and</span>
        <span class="c1">#: handles automatically)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aux_avail</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_vert_code</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">data_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
        <span class="k">elif</span> <span class="n">data_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_data_dir</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">search_all_files</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">DataCoverageError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">print_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data ID of dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_id</span>

    <span class="nd">@data_id</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">data_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for data_id, need str&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_id</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Directory where data files are located</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span>

    <span class="nd">@data_dir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">data_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Input data directory </span><span class="si">{}</span><span class="s1"> does not exist&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reinit</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">years_avail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Years available in dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_all_files</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">years</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for :attr:`years_available`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">print_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s1">&#39;Attr. &quot;years&quot; is deprecated &#39;</span>
                                             <span class="s1">&#39;(but still works). Please use &#39;</span>
                                             <span class="s1">&#39;&quot;years_avail&quot; instead.&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">years_avail</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of all experiments that are available in this dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_all_files</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of data files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_all_files</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ts_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Available frequencies&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="o">.</span><span class="n">ts_type</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vars_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vars_2d</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars_3d</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pyaerocom.exceptions</span> <span class="kn">import</span> <span class="n">DeprecationError</span>
        <span class="k">raise</span> <span class="n">DeprecationError</span><span class="p">(</span><span class="s1">&#39;Attribute vars is deprecated in ReadGridded. &#39;</span>
                               <span class="s1">&#39;Please use vars_filename instead&#39;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vars_provided</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Variables provided by this dataset&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vars_provided</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">file_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;File type of data files&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">const</span><span class="o">.</span><span class="n">GRID_IO</span><span class="o">.</span><span class="n">FILE_TYPE</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">TS_TYPES</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List with valid filename encryptions specifying temporal resolution</span>

<span class="sd">        Update 7.11.2019: not in use anymore due to improved handling of</span>
<span class="sd">        all possible frequencies now using TsType class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">const</span><span class="o">.</span><span class="n">GRID_IO</span><span class="o">.</span><span class="n">TS_TYPES</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;First available year in the dataset (inferred from filenames)</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        This is not variable or ts_type specific, so it is not necessarily</span>
<span class="sd">        given that data from this year is available for all variables in</span>
<span class="sd">        :attr:`vars` or all frequencies liste in :attr:`ts_types`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">years_avail</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;No information about available years accessible&#39;</span>
                                 <span class="s1">&#39;please run method search_all_files first&#39;</span><span class="p">)</span>
        <span class="n">yr</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">years_avail</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">yr</span> <span class="o">==</span> <span class="mi">9999</span><span class="p">:</span>
            <span class="n">yr</span> <span class="o">=</span> <span class="mi">2222</span>
        <span class="k">return</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Last available year in the dataset (inferred from filenames)</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        This is not variable or ts_type specific, so it is not necessarily</span>
<span class="sd">        given that data from this year is available for all variables in</span>
<span class="sd">        :attr:`vars` or all frequencies liste in :attr:`ts_types`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">years_avail</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;No information about available years accessible&#39;</span>
                                 <span class="s1">&#39;please run method search_all_files first&#39;</span><span class="p">)</span>
        <span class="n">years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">years_avail</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">year</span> <span class="o">==</span> <span class="mi">9999</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Data contains climatology. Will be ignored &#39;</span>
                                <span class="s1">&#39;as stop time, using last year&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">year</span> <span class="o">=</span> <span class="mi">2222</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-12-31 23:59:59&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>

<div class="viewcode-block" id="ReadGridded.reinit"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.reinit">[docs]</a>    <span class="k">def</span> <span class="nf">reinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reinit everything that is loaded specific to data_dir&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vars_2d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vars_3d</span> <span class="o">=</span><span class="p">[]</span></div>

    <span class="k">def</span> <span class="nf">_get_vars_provided</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_vars</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vars_filename</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">aux_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUX_REQUIRES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">aux_var</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">aux_var</span> <span class="ow">in</span> <span class="n">_vars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compute_var</span><span class="p">(</span><span class="n">aux_var</span><span class="p">):</span>
                <span class="n">_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux_var</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">aux_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aux_requires</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">aux_var</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">aux_var</span> <span class="ow">in</span> <span class="n">_vars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compute_var</span><span class="p">(</span><span class="n">aux_var</span><span class="p">):</span>
                <span class="n">_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux_var</span><span class="p">)</span>

        <span class="c1">#also add standard names of 3D variables if not already in list</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars_3d</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;3d&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">_vars</span><span class="p">:</span>
                <span class="n">_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_vars</span>

    <span class="k">def</span> <span class="nf">_check_aux_compute_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if input var_name can be computed</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Does not check variable families (e.g. conc*) which is done via</span>
<span class="sd">        :func:`_check_var_match_pattern`. Only checks entries in</span>
<span class="sd">        :attr:`AUX_REQUIRES` and :attr:`aux_requires`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str</span>
<span class="sd">            input variable name that is supposed to be checked</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True, if variable can be computed, else False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aux_requires</span> <span class="ow">and</span>
            <span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aux_funs</span><span class="p">):</span>
            <span class="n">vars_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aux_requires</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aux_funs</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUX_REQUIRES</span> <span class="ow">and</span>
              <span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUX_FUNS</span><span class="p">):</span>
            <span class="n">vars_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUX_REQUIRES</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUX_FUNS</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">vars_to_read</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vars_req</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># the variable might be updated in _check_var_avail</span>
                <span class="n">vars_to_read</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_var_avail</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">VarNotAvailableError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_to_read</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_req</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aux_avail</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vars_to_read</span><span class="p">,</span> <span class="n">fun</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_check_var_match_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
        <span class="n">vars_found</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registered_var_patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
                <span class="n">vars_required</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUX_REQUIRES</span><span class="p">[</span><span class="n">pattern</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">addvar</span> <span class="ow">in</span> <span class="n">vars_required</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">addvar</span><span class="p">:</span>
                        <span class="n">vars_found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">addvar</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_addvar</span> <span class="o">=</span> <span class="n">var_name</span>
                        <span class="n">spl1</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
                        <span class="n">spl2</span> <span class="o">=</span> <span class="n">addvar</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spl1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spl2</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;variable patterns in &#39;</span>
                                                 <span class="s1">&#39;AUX_REQUIRES and corresponding &#39;</span>
                                                 <span class="s1">&#39;values (with * in name) need &#39;</span>
                                                 <span class="s1">&#39;to have the same number of &#39;</span>
                                                 <span class="s1">&#39;wildcard delimiters&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">substr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spl1</span><span class="p">):</span>
                            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">substr</span><span class="p">):</span>
                                <span class="n">_addvar</span> <span class="o">=</span> <span class="n">_addvar</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">substr</span><span class="p">,</span> <span class="n">spl2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">vars_found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_addvar</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_found</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_required</span><span class="p">):</span>
                    <span class="n">all_ok</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">vars_to_read</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_found</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">vars_to_read</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_var_avail</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
                        <span class="k">except</span> <span class="n">VarNotAvailableError</span><span class="p">:</span>
                            <span class="n">all_ok</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>

                    <span class="k">if</span> <span class="n">all_ok</span><span class="p">:</span>
                        <span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUX_FUNS</span><span class="p">[</span><span class="n">pattern</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_aux_compute</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span>
                                             <span class="n">vars_required</span><span class="o">=</span><span class="n">vars_to_read</span><span class="p">,</span>
                                             <span class="n">fun</span><span class="o">=</span><span class="n">fun</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_aux_avail</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vars_to_read</span><span class="p">,</span> <span class="n">fun</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_get_aux_vars_and_fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_to_compute</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper that searches auxiliary variables for computation of input var</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_to_compute : str</span>
<span class="sd">            one of the auxiliary variables that is supported by this interface</span>
<span class="sd">            (cf. :attr:`AUX_REQUIRES`)</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        VarNotAvailableError</span>
<span class="sd">            if one of the required variables for computation is not available</span>
<span class="sd">            in the data</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list of variables that are used as input for computation method</span>
<span class="sd">            of input variable</span>
<span class="sd">        callable</span>
<span class="sd">            function that is used to compute input variable</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">var_to_compute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aux_avail</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compute_var</span><span class="p">(</span><span class="n">var_to_compute</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">VarNotAvailableError</span><span class="p">(</span><span class="s1">&#39;Variable </span><span class="si">{}</span><span class="s1"> cannot be computed&#39;</span>
                                           <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_to_compute</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aux_avail</span><span class="p">[</span><span class="n">var_to_compute</span><span class="p">]</span>

<div class="viewcode-block" id="ReadGridded.check_compute_var"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.check_compute_var">[docs]</a>    <span class="k">def</span> <span class="nf">check_compute_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if variable name belongs to family that can be computed</span>

<span class="sd">        For instance, if input var_name is `concdust` this method will check</span>
<span class="sd">        :attr:`AUX_REQUIRES` to see if there is a variable family pattern</span>
<span class="sd">        (`conc*`) defined that specifies how to compute these variables. If</span>
<span class="sd">        a match is found, the required variables and computation method is</span>
<span class="sd">        added via :func:`add_aux_compute`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        var_name : str</span>
<span class="sd">            variable name to be checked</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if match is found, else False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">var_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VariableDefinitionError</span><span class="p">(</span><span class="s1">&#39;Invalid variable name </span><span class="si">{}</span><span class="s1">. Must not &#39;</span>
                                          <span class="s1">&#39;contain *&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aux_avail</span><span class="p">:</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_aux_compute_access</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_var_match_pattern</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_check_var_avail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span>

        <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUX_ALT_VARS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">alt_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUX_ALT_VARS</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">alt_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_filename</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">alt_var</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">VARS</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_filename</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">alias</span>
        <span class="k">raise</span> <span class="n">VarNotAvailableError</span><span class="p">(</span><span class="s1">&#39;Var </span><span class="si">{}</span><span class="s1"> is not available in data...&#39;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>

<div class="viewcode-block" id="ReadGridded.has_var"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.has_var">[docs]</a>    <span class="k">def</span> <span class="nf">has_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if variable is available</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str</span>
<span class="sd">            variable to be checked</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># vars_provided includes variables that can be read and variables that</span>
        <span class="c1"># can be computed. It does not consider variable families that may be</span>
        <span class="c1"># able to be computed or alias matches</span>
        <span class="n">avail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_provided</span>
        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">avail</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">VARS</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">VariableDefinitionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compute_var</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">avail</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">is_alias</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">var_name_aerocom</span> <span class="ow">in</span> <span class="n">avail</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_get_years_to_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Array containing year numbers that are supposed to be loaded</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            all years to be loaded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_provided</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
            <span class="k">if</span> <span class="n">start</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2222</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">9999</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_provided</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="mi">9999</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">9999</span><span class="p">])</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start_provided</span><span class="p">:</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
            <span class="n">stop</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="c1">#subtract one second to end up at the end of previous year</span>
        <span class="k">if</span> <span class="n">const</span><span class="o">.</span><span class="n">MIN_YEAR</span> <span class="o">&gt;</span> <span class="n">start</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
            <span class="n">print_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;First available year </span><span class="si">{}</span><span class="s1"> of data </span><span class="si">{}</span><span class="s1"> is smaller &#39;</span>
                              <span class="s1">&#39;than supported first year </span><span class="si">{}</span><span class="s1">.&#39;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span>
                                             <span class="n">const</span><span class="o">.</span><span class="n">MIN_YEAR</span><span class="p">))</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">MIN_YEAR</span>
        <span class="k">if</span> <span class="n">const</span><span class="o">.</span><span class="n">MAX_YEAR</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Last available year </span><span class="si">{}</span><span class="s1"> of data </span><span class="si">{}</span><span class="s1"> is larger &#39;</span>
                             <span class="s1">&#39;than supported last year </span><span class="si">{}</span><span class="s1">.&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">MAX_YEAR</span><span class="p">))</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">MAX_YEAR</span>

        <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">stop</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">stop</span><span class="o">.</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">years_avail</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No information available for available &quot;</span>
                                 <span class="s2">&quot;years. Please run method &quot;</span>
                                 <span class="s2">&quot;search_all_files first&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">years_avail</span><span class="p">)</span>

<div class="viewcode-block" id="ReadGridded.search_data_dir"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.search_data_dir">[docs]</a>    <span class="k">def</span> <span class="nf">search_data_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Search data directory based on model ID</span>

<span class="sd">        Wrapper for method :func:`search_data_dir_aerocom`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            data directory</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IOError</span>
<span class="sd">            if directory cannot be found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_data_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">_dir</span>
        <span class="k">return</span> <span class="n">_dir</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_eval_data_id</span><span class="p">(</span><span class="n">data_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract meta information from data_id</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_id : str</span>
<span class="sd">            string specifying model and other relevant information. In the</span>
<span class="sd">            best case following AeroCom Phase III conventions, that is,</span>
<span class="sd">            following the template specified in :class:`AerocomDataID`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vals : list</span>
<span class="sd">            list containing successfully extracted information from data_id</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">AerocomDataID</span><span class="p">(</span><span class="n">data_id</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="n">vals</span>
<span class="c1"># =============================================================================</span>
<span class="c1">#         spl = data_id.split(&#39;_&#39;)</span>
<span class="c1">#         name, meteo = &#39;&#39;,&#39;&#39;</span>
<span class="c1">#         experiment = spl[-1]</span>
<span class="c1">#         if len(spl) &gt; 1:</span>
<span class="c1">#             sspl = spl[0].split(&#39;-&#39;)</span>
<span class="c1">#             if len(sspl) &gt; 1:</span>
<span class="c1">#                 name = sspl[0]</span>
<span class="c1">#                 meteo = sspl[-1]</span>
<span class="c1">#         return (name, meteo, experiment)</span>
<span class="c1"># =============================================================================</span>

    <span class="k">def</span> <span class="nf">_update_file_convention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update current file convention based on input files</span>

<span class="sd">        Loops over all files in input list and as updates the file convention</span>
<span class="sd">        based on the first file in list that matches one of the registered</span>
<span class="sd">        conventions.</span>

<span class="sd">        Updates class :attr:`file_convention`</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        FileNotFoundError</span>
<span class="sd">            if none of the input files matches a registered convention.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_convention</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;None of the available files in </span><span class="si">{}</span><span class="s1"> matches a &#39;</span>
                                <span class="s1">&#39;registered pyaerocom file convention&#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">))</span>

<div class="viewcode-block" id="ReadGridded.search_all_files"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.search_all_files">[docs]</a>    <span class="k">def</span> <span class="nf">search_all_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_file_convention</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Search all valid model files for this model</span>

<span class="sd">        This method browses the data directory and finds all valid files, that</span>
<span class="sd">        is, file that are named according to one of the aerocom file naming</span>
<span class="sd">        conventions. The file list is stored in :attr:`files`.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        It is presumed, that naming conventions of files in</span>
<span class="sd">        the data directory are not mixed but all correspond to either of the</span>
<span class="sd">        conventions defined in</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        update_file_convention : bool</span>
<span class="sd">            if True, the first file in `data_dir` is used to identify the</span>
<span class="sd">            file naming convention (cf. :class:`FileConventionRead`)</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        DataCoverageError</span>
<span class="sd">            if no valid files could be found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Cannot search files since :attr:`data_dir` &#39;</span>
                                 <span class="s1">&#39;is not assigned&#39;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files_ignored</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># get all netcdf files in folder</span>
        <span class="n">nc_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">+</span> <span class="s1">&#39;/*</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_type</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nc_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">print_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No files of type </span><span class="si">{}</span><span class="s1"> could be found in current &#39;</span>
                              <span class="s1">&#39;data_dir=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_type</span><span class="p">,</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">update_file_convention</span><span class="p">:</span>
            <span class="c1"># Check if the found file has a naming according the aerocom conventions</span>
            <span class="c1"># and set the convention for all files (maybe this need to be</span>
            <span class="c1"># updated in case there can be more than one file naming convention</span>
            <span class="c1"># within one model directory)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_file_convention</span><span class="p">(</span><span class="n">nc_files</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">print_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">return</span>

        <span class="n">_vars_temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_vars_temp_3d</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">_file</span> <span class="ow">in</span> <span class="n">nc_files</span><span class="p">:</span>
            <span class="c1"># TODO: resolve this in a more general way...</span>
            <span class="k">if</span> <span class="s1">&#39;ModelLevelAtStations&#39;</span> <span class="ow">in</span> <span class="n">_file</span><span class="p">:</span>
                <span class="n">const</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ignoring file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_file</span><span class="p">))</span>
                <span class="n">files_ignored</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">_file</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_convention</span><span class="o">.</span><span class="n">get_info_from_file</span><span class="p">(</span><span class="n">_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;data_id&#39;</span><span class="p">]</span>
                <span class="n">var_name</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">]</span>
                <span class="n">_is_3d</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">is_3d</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
                    <span class="n">_vars_temp_3d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
                    <span class="n">_is_3d</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_vars_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">TsType</span><span class="o">.</span><span class="n">valid</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;ts_type&quot;</span><span class="p">]):</span><span class="c1"># in self.TS_TYPES:</span>
                    <span class="k">raise</span> <span class="n">TemporalResolutionError</span><span class="p">(</span><span class="s1">&#39;Invalid frequency </span><span class="si">{}</span><span class="s1">&#39;</span>
                                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;ts_type&quot;</span><span class="p">]))</span>

                <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">meteo</span><span class="p">,</span>
                 <span class="n">experiment</span><span class="p">,</span> <span class="n">pert</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_data_id</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data_id&#39;</span><span class="p">])</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">var_name</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ts_type&#39;</span><span class="p">],</span>
                               <span class="n">info</span><span class="p">[</span><span class="s1">&#39;vert_code&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span>
                               <span class="n">model</span><span class="p">,</span> <span class="n">meteo</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">pert</span><span class="p">,</span>
                               <span class="n">info</span><span class="p">[</span><span class="s1">&#39;is_at_stations&#39;</span><span class="p">],</span>
                               <span class="n">_is_3d</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">_file</span><span class="p">)])</span>

            <span class="k">except</span> <span class="p">(</span><span class="n">FileConventionError</span><span class="p">,</span> <span class="n">DataSourceError</span><span class="p">,</span>
                    <span class="n">TemporalResolutionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Failed to import file </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Model: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">_file</span><span class="p">),</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">const</span><span class="o">.</span><span class="n">WRITE_FILEIO_ERR_LOG</span><span class="p">:</span>
                    <span class="n">add_file_to_log</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_vars_temp</span> <span class="o">+</span> <span class="n">_vars_temp_3d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Failed to extract information from filenames&quot;</span><span class="p">)</span>
        <span class="c1"># make sorted list of unique vars</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vars_2d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">od</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">_vars_temp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vars_3d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">od</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">_vars_temp_3d</span><span class="p">))</span>

        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ts_type&#39;</span><span class="p">,</span> <span class="s1">&#39;vert_code&#39;</span><span class="p">,</span> <span class="s1">&#39;data_id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;meteo&#39;</span><span class="p">,</span> <span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;perturbation&#39;</span><span class="p">,</span> <span class="s1">&#39;is_at_stations&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;3D&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;var_name&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ts_type&#39;</span><span class="p">,</span> <span class="s1">&#39;data_id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;meteo&#39;</span><span class="p">,</span> <span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;perturbation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;is_at_stations&#39;</span><span class="p">,</span> <span class="s1">&#39;3D&#39;</span><span class="p">],</span>
                        <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">uv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">vert_code</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">uv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore_vert_code</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span> <span class="o">=</span> <span class="n">df</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;No files could be found for data </span><span class="si">{}</span><span class="s1"> and &#39;</span>
                                    <span class="s1">&#39;years range </span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">))</span></div>

<div class="viewcode-block" id="ReadGridded.filter_files"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.filter_files">[docs]</a>    <span class="k">def</span> <span class="nf">filter_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ts_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vert_which</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_at_stations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filter file database</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str</span>
<span class="sd">            variable that are supposed to be read</span>
<span class="sd">        ts_type : str</span>
<span class="sd">            string specifying temporal resolution (choose from</span>
<span class="sd">            &quot;hourly&quot;, &quot;3hourly&quot;, &quot;daily&quot;, &quot;monthly&quot;). If None, prioritised</span>
<span class="sd">            of the available resolutions is used</span>
<span class="sd">        start : Timestamp or str, optional</span>
<span class="sd">            start time of data import</span>
<span class="sd">        stop : Timestamp or str, optional</span>
<span class="sd">            stop time of data import</span>
<span class="sd">        experiment : str</span>
<span class="sd">            name of experiment (only relevant if this dataset contains more</span>
<span class="sd">            than one experiment)</span>
<span class="sd">        vert_which : str or dict, optional</span>
<span class="sd">            valid AeroCom vertical info string encoded in name (e.g. Column,</span>
<span class="sd">            ModelLevel) or dictionary containing var_name as key and vertical</span>
<span class="sd">            coded string as value, accordingly</span>
<span class="sd">        flex_ts_type : bool</span>
<span class="sd">            if True and if applicable, then another ts_type is used in case</span>
<span class="sd">            the input ts_type is not available for this variable</span>
<span class="sd">        prefer_longer : bool</span>
<span class="sd">            if True and applicable, the ts_type resulting in the longer time</span>
<span class="sd">            coverage will be preferred over other possible frequencies that</span>
<span class="sd">            match the query.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span>

        <span class="n">yrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_years_to_load</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
        <span class="n">year_cond</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">yrs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var_cond</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">var_name</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">var_name</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var_cond</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">var_name</span> <span class="o">==</span> <span class="n">var_name</span>
        <span class="k">if</span> <span class="n">vert_which</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vert_cond</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">vert_code</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">vert_code</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vert_cond</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">vert_code</span> <span class="o">==</span> <span class="n">vert_which</span>
        <span class="k">if</span> <span class="n">ts_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freq_cond</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ts_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ts_type</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freq_cond</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ts_type</span> <span class="o">==</span> <span class="n">ts_type</span>
        <span class="k">if</span> <span class="n">experiment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exp_cond</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exp_cond</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">experiment</span> <span class="o">==</span> <span class="n">experiment</span>

        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">var_cond</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="n">year_cond</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="n">freq_cond</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="n">exp_cond</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="n">vert_cond</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">is_at_stations</span><span class="o">==</span><span class="n">is_at_stations</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">_infer_ts_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">ts_type</span><span class="p">,</span> <span class="n">flex_ts_type</span><span class="p">,</span>
                       <span class="n">prefer_longer</span><span class="p">):</span>
        <span class="n">ts_types</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ts_type</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># only one frequency available</span>
            <span class="k">if</span> <span class="n">flex_ts_type</span> <span class="ow">or</span> <span class="n">ts_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ts_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ts_type</span><span class="p">:</span>
                <span class="c1"># all good</span>
                <span class="k">return</span> <span class="n">ts_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;No files could be found for ts_type </span><span class="si">{}</span><span class="s1">&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts_type</span><span class="p">))</span>
        <span class="n">highest_avail</span> <span class="o">=</span> <span class="n">get_highest_resolution</span><span class="p">(</span><span class="o">*</span><span class="n">ts_types</span><span class="p">)</span>
        <span class="c1"># there is more than one frequency available -&gt; decision making</span>
        <span class="c1"># gets more complicated</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flex_ts_type</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ts_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">highest_avail</span>
            <span class="k">elif</span> <span class="n">ts_type</span> <span class="ow">in</span> <span class="n">ts_types</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ts_type</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;Failed to infer ts_type&#39;</span><span class="p">)</span>

        <span class="c1"># ts_type is flexible</span>
        <span class="k">if</span> <span class="n">ts_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># initiate with highest available</span>
            <span class="n">ts_type</span> <span class="o">=</span> <span class="n">highest_avail</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">prefer_longer</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ts_type</span>

        <span class="c1"># ts_type is flexible and user prefers the longer period over</span>
        <span class="c1"># higher resolution</span>
        <span class="n">ts_type</span> <span class="o">=</span> <span class="n">ts_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_files</span><span class="p">(</span><span class="n">ts_type</span><span class="o">=</span><span class="n">ts_type</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_ts_type</span> <span class="ow">in</span> <span class="n">ts_types</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">_subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_files</span><span class="p">(</span><span class="n">ts_type</span><span class="o">=</span><span class="n">_ts_type</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_subset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">):</span>
                <span class="n">subset</span> <span class="o">=</span> <span class="n">_subset</span>
                <span class="n">ts_type</span> <span class="o">=</span> <span class="n">_ts_type</span>
        <span class="k">return</span> <span class="n">ts_type</span>

<div class="viewcode-block" id="ReadGridded.filter_query"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.filter_query">[docs]</a>    <span class="k">def</span> <span class="nf">filter_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">ts_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vert_which</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">is_at_stations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">flex_ts_type</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">prefer_longer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filter files for read query based on input specs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataFrame</span>
<span class="sd">            dataframe containing filtered dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="o">.</span><span class="n">var_name</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;Variable </span><span class="si">{}</span><span class="s1"> is not available in dataset &#39;</span>
                                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">))</span>

        <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_files</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                                   <span class="n">ts_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># disregard ts_type in 1. iteration</span>
                                   <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                                   <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                                   <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">,</span>
                                   <span class="n">is_at_stations</span><span class="o">=</span><span class="n">is_at_stations</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vert_which</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">VERT_ALT</span><span class="p">:</span>
                <span class="n">vc</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VERT_ALT</span><span class="p">[</span><span class="n">vert_which</span><span class="p">]</span>
                <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No files could be found for var </span><span class="si">{}</span><span class="s1"> and &#39;</span>
                                        <span class="s1">&#39;vert_which </span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1">. Trying to find &#39;</span>
                                        <span class="s1">&#39;alternative options&#39;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">vert_which</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_query</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">ts_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
                                             <span class="n">experiment</span><span class="p">,</span> <span class="n">vert_which</span><span class="o">=</span><span class="n">vc</span><span class="p">,</span>
                                             <span class="n">is_at_stations</span><span class="o">=</span><span class="n">is_at_stations</span><span class="p">,</span>
                                             <span class="n">flex_ts_type</span><span class="o">=</span><span class="n">flex_ts_type</span><span class="p">,</span>
                                             <span class="n">prefer_longer</span><span class="o">=</span><span class="n">prefer_longer</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;No files could be found&#39;</span><span class="p">)</span>
        <span class="n">ts_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_ts_type</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">ts_type</span><span class="p">,</span> <span class="n">flex_ts_type</span><span class="p">,</span>
                                      <span class="n">prefer_longer</span><span class="p">)</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_files</span><span class="p">(</span><span class="n">ts_type</span><span class="o">=</span><span class="n">ts_type</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                                   <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">subset</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
            <span class="k">return</span> <span class="n">subset</span>

        <span class="c1"># File request could not be resolved such that every year only occurs</span>
        <span class="c1"># once</span>
        <span class="n">msg</span> <span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">exps</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">verts</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">vert_code</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;Found multiple experiments. Choose from: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exps</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dvc</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">VARS</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_default_vert_code</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dvc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dvc</span> <span class="ow">in</span> <span class="n">verts</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_query</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">ts_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
                                         <span class="n">experiment</span><span class="p">,</span> <span class="n">vert_which</span><span class="o">=</span><span class="n">dvc</span><span class="p">,</span>
                                         <span class="n">is_at_stations</span><span class="o">=</span><span class="n">is_at_stations</span><span class="p">,</span>
                                         <span class="n">flex_ts_type</span><span class="o">=</span><span class="n">flex_ts_type</span><span class="p">,</span>
                                         <span class="n">prefer_longer</span><span class="o">=</span><span class="n">prefer_longer</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;; &#39;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;Found multiple vertical codes. Choose from: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DataQueryError</span><span class="p">(</span><span class="s1">&#39;Failed to uniquely identify data files for input &#39;</span>
                             <span class="s1">&#39;query. Reason: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span></div>

<div class="viewcode-block" id="ReadGridded.get_files"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.get_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">ts_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vert_which</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">is_at_stations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">flex_ts_type</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">prefer_longer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get data files based on input specs&quot;&quot;&quot;</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_query</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">ts_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
                                       <span class="n">experiment</span><span class="p">,</span> <span class="n">vert_which</span><span class="p">,</span>
                                       <span class="n">is_at_stations</span><span class="p">,</span> <span class="n">flex_ts_type</span><span class="p">,</span>
                                       <span class="n">prefer_longer</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_file_paths</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_generate_file_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>

<div class="viewcode-block" id="ReadGridded.get_var_info_from_files"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.get_var_info_from_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_var_info_from_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates dicitonary that contains variable specific meta information</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        OrderedDict</span>
<span class="sd">            dictionary where keys are available variables and values (for each</span>
<span class="sd">            variable) contain information about available ts_types, years, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">od</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">finfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_convention</span><span class="o">.</span><span class="n">get_info_from_file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">var_name</span> <span class="o">=</span> <span class="n">finfo</span><span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_info</span> <span class="o">=</span> <span class="n">od</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">finfo</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;var_name&#39;</span><span class="p">:</span>
                        <span class="n">var_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">var_info</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">finfo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;var_name&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">var_info</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">var_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="c1"># now check auxiliary variables</span>
        <span class="k">for</span> <span class="n">var_to_compute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUX_REQUIRES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">var_to_compute</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vars_to_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_aux_vars_and_fun</span><span class="p">(</span><span class="n">var_to_compute</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="n">VarNotAvailableError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># init result info dict for aux variable</span>
                <span class="n">result</span><span class="p">[</span><span class="n">var_to_compute</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_info</span> <span class="o">=</span> <span class="n">od</span><span class="p">()</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">vars_to_read</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="c1"># init with results from first required variable</span>
                <span class="n">var_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">first</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_to_read</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">info_other</span> <span class="ow">in</span> <span class="n">vars_to_read</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                        <span class="n">other</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">info_other</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">var_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="c1"># compute match with other variable</span>
                            <span class="n">var_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
                                                               <span class="n">other</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                <span class="n">var_info</span><span class="p">[</span><span class="s1">&#39;aux_vars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vars_to_read</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="ReadGridded.update"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update one or more valid parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs</span>
<span class="sd">            keyword args that will be used to update (overwrite) valid class</span>
<span class="sd">            attributes such as `data, data_dir, files`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating </span><span class="si">%s</span><span class="s2"> in ModelImportResult for model </span><span class="si">%s</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;New value: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ignoring key </span><span class="si">%s</span><span class="s2"> in ModelImportResult.update()&quot;</span> <span class="o">%</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReadGridded.concatenate_cubes"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.concatenate_cubes">[docs]</a>    <span class="k">def</span> <span class="nf">concatenate_cubes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cubes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Concatenate list of cubes into one cube</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        CubeList</span>
<span class="sd">            list of individual cubes</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Cube</span>
<span class="sd">            Single cube that contains concatenated cubes from input list</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        iris.exceptions.ConcatenateError</span>
<span class="sd">            if concatenation of all cubes failed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">concatenate_iris_cubes</span><span class="p">(</span><span class="n">cubes</span><span class="p">,</span> <span class="n">error_on_mismatch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReadGridded.compute_var"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.compute_var">[docs]</a>    <span class="k">def</span> <span class="nf">compute_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ts_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vert_which</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flex_ts_type</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">prefer_longer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vars_to_read</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aux_fun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute auxiliary variable</span>

<span class="sd">        Like :func:`read_var` but for auxiliary variables</span>
<span class="sd">        (cf. AUX_REQUIRES)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str</span>
<span class="sd">            variable that are supposed to be read</span>
<span class="sd">        start : Timestamp or str, optional</span>
<span class="sd">            start time of data import (if valid input, then the current</span>
<span class="sd">            :attr:`start` will be overwritten)</span>
<span class="sd">        stop : Timestamp or str, optional</span>
<span class="sd">            stop time of data import</span>
<span class="sd">        ts_type : str</span>
<span class="sd">            string specifying temporal resolution (choose from</span>
<span class="sd">            hourly, 3hourly, daily, monthly). If None, prioritised</span>
<span class="sd">            of the available resolutions is used</span>
<span class="sd">        experiment : str</span>
<span class="sd">            name of experiment (only relevant if this dataset contains more</span>
<span class="sd">            than one experiment)</span>
<span class="sd">        vert_which : str</span>
<span class="sd">            valid AeroCom vertical info string encoded in name (e.g. Column,</span>
<span class="sd">            ModelLevel)</span>
<span class="sd">        flex_ts_type : bool</span>
<span class="sd">            if True and if applicable, then another ts_type is used in case</span>
<span class="sd">            the input ts_type is not available for this variable</span>
<span class="sd">        prefer_longer : bool</span>
<span class="sd">            if True and applicable, the ts_type resulting in the longer time</span>
<span class="sd">            coverage will be preferred over other possible frequencies that</span>
<span class="sd">            match the query.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            additional keyword args passed to :func:`_load_var`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        GriddedData</span>
<span class="sd">            loaded data object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">vars_to_read</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_aux_compute</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">vars_to_read</span><span class="p">,</span> <span class="n">aux_fun</span><span class="p">)</span>
        <span class="n">vars_to_read</span><span class="p">,</span> <span class="n">aux_fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_aux_vars_and_fun</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># all variables that are required need to be in the same temporal</span>
        <span class="c1"># resolution</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ts_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_common_ts_type</span><span class="p">(</span><span class="n">vars_to_read</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
                                               <span class="n">ts_type</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span>
                                               <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">,</span>
                                               <span class="n">flex_ts_type</span><span class="o">=</span><span class="n">flex_ts_type</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">DataCoverageError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">vert_which</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">VERT_ALT</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="n">vert_which</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VERT_ALT</span><span class="p">[</span><span class="n">vert_which</span><span class="p">]</span>

            <span class="n">ts_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_common_ts_type</span><span class="p">(</span><span class="n">vars_to_read</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
                                               <span class="n">ts_type</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span>
                                               <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">,</span>
                                               <span class="n">flex_ts_type</span><span class="o">=</span><span class="n">flex_ts_type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_to_read</span><span class="p">:</span>
            <span class="n">aux_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_var</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                                      <span class="n">ts_type</span><span class="o">=</span><span class="n">ts_type</span><span class="p">,</span>
                                      <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                                      <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                                      <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">,</span>
                                      <span class="n">flex_ts_type</span><span class="o">=</span><span class="n">flex_ts_type</span><span class="p">,</span>
                                      <span class="n">prefer_longer</span><span class="o">=</span><span class="n">prefer_longer</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux_data</span><span class="p">)</span>

        <span class="n">cube</span> <span class="o">=</span> <span class="n">aux_fun</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)</span>
        <span class="n">cube</span><span class="o">.</span><span class="n">var_name</span> <span class="o">=</span> <span class="n">var_name</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">GriddedData</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">data_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span>
                           <span class="c1">#ts_type=data[0].ts_type,</span>
                           <span class="n">computed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="ReadGridded.find_common_ts_type"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.find_common_ts_type">[docs]</a>    <span class="k">def</span> <span class="nf">find_common_ts_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vars_to_read</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">ts_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vert_which</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">flex_ts_type</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find common ts_type for list of variables to be read</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vars_to_read : list</span>
<span class="sd">            list of variables that is supposed to be read</span>
<span class="sd">        start : Timestamp or str, optional</span>
<span class="sd">            start time of data import (if valid input, then the current</span>
<span class="sd">            start will be overwritten)</span>
<span class="sd">        stop : Timestamp or str, optional</span>
<span class="sd">            stop time of data import (if valid input, then the current</span>
<span class="sd">            :attr:`start` will be overwritten)</span>
<span class="sd">        ts_type : str</span>
<span class="sd">            string specifying temporal resolution (choose from</span>
<span class="sd">            hourly, 3hourly, daily, monthly). If None, prioritised</span>
<span class="sd">            of the available resolutions is used</span>
<span class="sd">        experiment : str</span>
<span class="sd">            name of experiment (only relevant if this dataset contains more</span>
<span class="sd">            than one experiment)</span>
<span class="sd">        vert_which : str</span>
<span class="sd">            valid AeroCom vertical info string encoded in name (e.g. Column,</span>
<span class="sd">            ModelLevel)</span>
<span class="sd">        flex_ts_type : bool</span>
<span class="sd">            if True and if applicable, then another ts_type is used in case</span>
<span class="sd">            the input ts_type is not available for this variable</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            common ts_type for input variable</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        DataCoverageError</span>
<span class="sd">            if no match can be found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vars_to_read</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">vars_to_read</span> <span class="o">=</span> <span class="p">[</span><span class="n">vars_to_read</span><span class="p">]</span>

        <span class="n">common</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_files</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="n">vars_to_read</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                                   <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                                   <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                                   <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">)</span><span class="o">.</span><span class="n">ts_type</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">common</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;Could not find any file matches for query &#39;</span>
                                    <span class="s1">&#39;and variable </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vars_to_read</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_to_read</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">_tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_files</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                                    <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                                    <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                                    <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                                    <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">)</span>
            <span class="n">common</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">_tt</span><span class="o">.</span><span class="n">ts_type</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">common</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;Could not find common ts_type for &#39;</span>
                                    <span class="s1">&#39;variables </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vars_to_read</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">common</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ts_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">flex_ts_type</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">common</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">ts_type</span> <span class="o">==</span> <span class="n">common</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">ts_type</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;Could not find files with ts_type=</span><span class="si">{}</span><span class="s1"> for &#39;</span>
                                    <span class="s1">&#39;all input variables: </span><span class="si">{}</span><span class="s1">&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts_type</span><span class="p">,</span> <span class="n">vars_to_read</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ts_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ts_type</span> <span class="ow">in</span> <span class="n">common</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ts_type</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">flex_ts_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;Could not find files with ts_type=</span><span class="si">{}</span><span class="s1"> for &#39;</span>
                                    <span class="s1">&#39;all input variables: </span><span class="si">{}</span><span class="s1">&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts_type</span><span class="p">,</span> <span class="n">vars_to_read</span><span class="p">))</span>

        <span class="c1"># NOTE: Changed by jgliss on 7.11.2019 for more flexibility</span>
        <span class="c1">#common_sorted = [x for x in const.GRID_IO.TS_TYPES if x in common]</span>
        <span class="n">common_sorted</span> <span class="o">=</span> <span class="n">sort_ts_types</span><span class="p">(</span><span class="n">common</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">common_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="ReadGridded.add_aux_compute"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.add_aux_compute">[docs]</a>    <span class="k">def</span> <span class="nf">add_aux_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">vars_required</span><span class="p">,</span> <span class="n">fun</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register new variable to be computed</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str</span>
<span class="sd">            variable name to be computed</span>
<span class="sd">        vars_required : list</span>
<span class="sd">            list of variables to read, that are required to compute `var_name`</span>
<span class="sd">        fun : callable</span>
<span class="sd">            function that takes a list of `GriddedData` objects as input and</span>
<span class="sd">            that are read using variable names specified by `vars_required`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vars_required</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">vars_required</span> <span class="o">=</span> <span class="p">[</span><span class="n">vars_required</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vars_required</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for vars_required. Need str or list. &#39;</span>
                             <span class="s1">&#39;Got: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vars_required</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for fun. Input is not a callable &#39;</span>
                             <span class="s1">&#39;object&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aux_requires</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vars_required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aux_funs</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fun</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_aux_compute_access</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;Failed to confirm access to auxiliary &#39;</span>
                                    <span class="s1">&#39;variable </span><span class="si">{}</span><span class="s1"> from </span><span class="si">{}</span><span class="s1">&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">vars_required</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">registered_var_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of string patterns for computation of variables</span>

<span class="sd">        The information is extracted from :attr:`AUX_REQUIRES`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list of variable patterns</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUX_REQUIRES</span> <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_var_to_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get variable to read</span>

<span class="sd">        The logical order of inferring the variable to read is:</span>

<span class="sd">            1. Check if input variable name as is, is available in filename</span>
<span class="sd">            2. If not, check if an old version of that name is available</span>
<span class="sd">            3. If not, check if an alias name of input name is available</span>
<span class="sd">            4. If not, check if input variable is an alias and if AeroCom \</span>
<span class="sd">                variable name is available instead (e.g. input od550csaer \</span>
<span class="sd">                not available, but od550aer is available)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str</span>
<span class="sd">            name of variable that is supposed to be read</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        VarNotAvailableError</span>
<span class="sd">            if no match can be found</span>
<span class="sd">        VariableDefinitionError</span>
<span class="sd">            if input variable is not defined</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            name of variable match found</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var_name</span>

        <span class="c1"># e.g. user asks for od550aer but files contain only 3d var od5503daer</span>
        <span class="c1"># if not var_to_read in self.vars_filename:</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars_3d</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Variable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">var_name</span> <span class="o">==</span> <span class="n">var_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">var</span>

        <span class="c1"># get instance of Variable class</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">VARS</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>

        <span class="c1"># If the input variable has aliases, check if one of these aliases is</span>
        <span class="c1"># provided in the dataset</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_filename</span><span class="p">:</span>
                <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Did not find </span><span class="si">{}</span><span class="s1"> field but </span><span class="si">{}</span><span class="s1">. &#39;</span>
                                     <span class="s1">&#39;Using the latter instead&#39;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">alias</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">alias</span>

        <span class="c1"># Finally, if still no match could be found, check if input variable</span>
        <span class="c1"># is an alias and see if the corresponding AeroCom variable name is</span>
        <span class="c1"># available in dataset</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">is_alias</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">var_name_aerocom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span><span class="o">.</span><span class="n">var_name_aerocom</span>

        <span class="k">raise</span> <span class="n">VarNotAvailableError</span><span class="p">(</span><span class="s1">&#39;Variable </span><span class="si">{}</span><span class="s1"> could not be found&#39;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_eval_vert_which_and_ts_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">vert_which</span><span class="p">,</span> <span class="n">ts_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="o">.</span><span class="n">vert_code</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deactivating file search by vertical &#39;</span>
                               <span class="s1">&#39;code for </span><span class="si">{}</span><span class="s1">, since filenames do not include &#39;</span>
                               <span class="s1">&#39;information about vertical code (probably &#39;</span>
                               <span class="s1">&#39;AeroCom 2 convention)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">))</span>
                <span class="n">vert_which</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vert_which</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vert_which</span> <span class="o">=</span> <span class="n">vert_which</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting vert_which to None, since input &#39;</span>
                                     <span class="s1">&#39;dict </span><span class="si">{}</span><span class="s1"> does not contain input variable &#39;</span>
                                     <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vert_which</span><span class="p">,</span> <span class="n">var_name</span><span class="p">))</span>
                <span class="n">vert_which</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ts_type</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ts_type</span> <span class="o">=</span> <span class="n">ts_type</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting ts_type to None, since input &#39;</span>
                                     <span class="s1">&#39;dict </span><span class="si">{}</span><span class="s1"> does not contain specification &#39;</span>
                                     <span class="s1">&#39;variable to read </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts_type</span><span class="p">,</span>
                                                                  <span class="n">var_name</span><span class="p">))</span>
                <span class="n">ts_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">vert_which</span><span class="p">,</span> <span class="n">ts_type</span>

    <span class="c1"># TODO: add from_vars input arg for computation and corresponding method</span>
<div class="viewcode-block" id="ReadGridded.read_var"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.read_var">[docs]</a>    <span class="k">def</span> <span class="nf">read_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ts_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vert_which</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">flex_ts_type</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefer_longer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">aux_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aux_fun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read model data for a specific variable</span>

<span class="sd">        This method searches all valid files for a given variable and for a</span>
<span class="sd">        provided temporal resolution (e.g. *daily, monthly*), optionally</span>
<span class="sd">        within a certain time window, that may be specified on class</span>
<span class="sd">        instantiation or using the corresponding input parameters provided in</span>
<span class="sd">        this method.</span>

<span class="sd">        The individual NetCDF files for a given temporal period are loaded as</span>
<span class="sd">        instances of the :class:`iris.Cube` object and appended to an instance</span>
<span class="sd">        of the :class:`iris.cube.CubeList` object. The latter is then used to</span>
<span class="sd">        concatenate the individual cubes in time into a single instance of the</span>
<span class="sd">        :class:`pyaerocom.GriddedData` class. In order to ensure that this</span>
<span class="sd">        works, several things need to be ensured, which are listed in the</span>
<span class="sd">        following and which may be controlled within the global settings for</span>
<span class="sd">        NetCDF import using the attribute :attr:`GRID_IO` (instance of</span>
<span class="sd">        :class:`OnLoad`) in the default instance of the</span>
<span class="sd">        :class:`pyaerocom.config.Config` object accessible via</span>
<span class="sd">        ``pyaerocom.const``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str</span>
<span class="sd">            variable that are supposed to be read</span>
<span class="sd">        start : Timestamp or str, optional</span>
<span class="sd">            start time of data import</span>
<span class="sd">        stop : Timestamp or str, optional</span>
<span class="sd">            stop time of data import</span>
<span class="sd">        ts_type : str</span>
<span class="sd">            string specifying temporal resolution (choose from</span>
<span class="sd">            &quot;hourly&quot;, &quot;3hourly&quot;, &quot;daily&quot;, &quot;monthly&quot;). If None, prioritised</span>
<span class="sd">            of the available resolutions is used</span>
<span class="sd">        experiment : str</span>
<span class="sd">            name of experiment (only relevant if this dataset contains more</span>
<span class="sd">            than one experiment)</span>
<span class="sd">        vert_which : str or dict, optional</span>
<span class="sd">            valid AeroCom vertical info string encoded in name (e.g. Column,</span>
<span class="sd">            ModelLevel) or dictionary containing var_name as key and vertical</span>
<span class="sd">            coded string as value, accordingly</span>
<span class="sd">        flex_ts_type : bool</span>
<span class="sd">            if True and if applicable, then another ts_type is used in case</span>
<span class="sd">            the input ts_type is not available for this variable</span>
<span class="sd">        prefer_longer : bool</span>
<span class="sd">            if True and applicable, the ts_type resulting in the longer time</span>
<span class="sd">            coverage will be preferred over other possible frequencies that</span>
<span class="sd">            match the query.</span>
<span class="sd">        aux_vars : list</span>
<span class="sd">            only relevant if `var_name` is not available for reading but needs</span>
<span class="sd">            to be computed: list of variables that are required to compute</span>
<span class="sd">            `var_name`</span>
<span class="sd">        aux_fun : callable</span>
<span class="sd">            only relevant if `var_name` is not available for reading but needs</span>
<span class="sd">            to be computed: custom method for computation (cf.</span>
<span class="sd">            :func:`add_aux_compute` for details)</span>
<span class="sd">        constraints : list, optional</span>
<span class="sd">            list of reading constraints (dict type). See</span>
<span class="sd">            :func:`check_constraint_valid` and :func:`apply_read_constraint`</span>
<span class="sd">            for details related to format of the individual constraints.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            additional keyword args parsed to :func:`_load_var`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        GriddedData</span>
<span class="sd">            loaded data object</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError</span>
<span class="sd">            if none of the ts_types identified from file names is valid</span>
<span class="sd">        VarNotAvailableError</span>
<span class="sd">            if specified ts_type is not supported</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># user has provided input that specified how the input variable</span>
        <span class="c1"># is supposed to be computed. In this case, the variable will be</span>
        <span class="c1"># computed even if it is directly available in a file, i.e. it</span>
        <span class="c1"># could be read.</span>
        <span class="k">if</span> <span class="n">aux_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_aux_compute</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">aux_vars</span><span class="p">,</span> <span class="n">aux_fun</span><span class="p">)</span>

        <span class="n">vert_which</span><span class="p">,</span> <span class="n">ts_type</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_eval_vert_which_and_ts_type</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span>
                                                                 <span class="n">vert_which</span><span class="p">,</span>
                                                                 <span class="n">ts_type</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_read_var</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
                                  <span class="n">ts_type</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">vert_which</span><span class="p">,</span>
                                  <span class="n">flex_ts_type</span><span class="p">,</span> <span class="n">prefer_longer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">constraints</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_read_constraint</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span>
                                                  <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                                                  <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                                                  <span class="n">ts_type</span><span class="o">=</span><span class="n">ts_type</span><span class="p">,</span>
                                                  <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                                                  <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">,</span>
                                                  <span class="n">flex_ts_type</span><span class="o">=</span><span class="n">flex_ts_type</span><span class="p">,</span>
                                                  <span class="n">prefer_longer</span><span class="o">=</span><span class="n">prefer_longer</span><span class="p">,</span>
                                                  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="ReadGridded.check_constraint_valid"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.check_constraint_valid">[docs]</a>    <span class="k">def</span> <span class="nf">check_constraint_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if reading constraint is valid</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraint : dict</span>
<span class="sd">            reading constraint. Requires at lest entries for following keys:</span>
<span class="sd">            - operator (str): for valid operators see :attr:`CONSTRAINT_OPERATORS`</span>
<span class="sd">            - filter_val (float): value against which data is evaluated wrt to \</span>
<span class="sd">                operator</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If constraint is invalid</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Read constraint needs to be dict&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="s1">&#39;operator&#39;</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Constraint requires specification of operator. &#39;</span>
                             <span class="s1">&#39;Valid operators: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINT_OPERATORS</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">constraint</span><span class="p">[</span><span class="s1">&#39;operator&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINT_OPERATORS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid constraint operator. Choose from: </span><span class="si">{}</span><span class="s1">&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINT_OPERATORS</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="s1">&#39;filter_val&#39;</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;constraint needs specification of filter_val&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">isnumeric</span><span class="p">(</span><span class="n">constraint</span><span class="p">[</span><span class="s1">&#39;filter_val&#39;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need numerical filter value&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReadGridded.apply_read_constraint"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.apply_read_constraint">[docs]</a>    <span class="k">def</span> <span class="nf">apply_read_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter a `GriddeData` object by value in another variable</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        BETA version, that was hacked down in a rush to be able to apply</span>
<span class="sd">        AOD&gt;0.1 threshold when reading AE.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : GriddedData</span>
<span class="sd">            data object to which constraint is applied</span>
<span class="sd">        constraint : dict</span>
<span class="sd">            dictionary defining read constraint (see</span>
<span class="sd">            :func:`check_constraint_valid` for minimum requirement). If</span>
<span class="sd">            constraint contains key var_name (not mandatory), then the</span>
<span class="sd">            corresponding variable is attemted to be read and is used to</span>
<span class="sd">            evaluate constraint and the corresponding boolean mask is then</span>
<span class="sd">            applied to input `data`. Wherever this mask is True (i.e. constraint</span>
<span class="sd">            is met), the current value in input `data` will be replaced with</span>
<span class="sd">            `numpy.ma.masked` or, if specified, with entry `new_val` in input</span>
<span class="sd">            constraint dict.</span>
<span class="sd">        **kwargs : TYPE</span>
<span class="sd">            reading arguments in case additional variable data needs to be</span>
<span class="sd">            loaded, to determine filter mask (i.e. if `var_name` is specified</span>
<span class="sd">            in input constraint). Parse to :func:`read_var`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If constraint is invalid (cf. :func:`check_constraint_valid` for</span>
<span class="sd">            details).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        GriddedData</span>
<span class="sd">            modified data objects (all grid-points that met constraint</span>
<span class="sd">            are replaced with either `numpy.ma.masked` or with a</span>
<span class="sd">            value that can be specified via key `new_val` in input constraint).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_constraint_valid</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;new_val&#39;</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
            <span class="n">new_val</span> <span class="o">=</span> <span class="n">constraint</span><span class="p">[</span><span class="s1">&#39;new_val&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>

        <span class="n">operator_fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINT_OPERATORS</span><span class="p">[</span><span class="n">constraint</span><span class="p">[</span><span class="s1">&#39;operator&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="s1">&#39;var_name&#39;</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
            <span class="n">other_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_var</span><span class="p">(</span><span class="n">constraint</span><span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">],</span>
                                       <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other_data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">other_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Failed to apply filter. Shape mismatch&#39;</span><span class="p">)</span>

        <span class="c1"># needs both data objects to be loaded into memory</span>
        <span class="n">other_data</span><span class="o">.</span><span class="n">_ensure_is_masked_array</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">_ensure_is_masked_array</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">operator_fun</span><span class="p">(</span><span class="n">other_data</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                            <span class="n">constraint</span><span class="p">[</span><span class="s1">&#39;filter_val&#39;</span><span class="p">])</span>

        <span class="n">data</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
        <span class="k">return</span> <span class="n">data</span></div>

    <span class="k">def</span> <span class="nf">_try_read_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
                  <span class="n">ts_type</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">vert_which</span><span class="p">,</span>
                  <span class="n">flex_ts_type</span><span class="p">,</span> <span class="n">prefer_longer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method used in :func:`read_var`</span>

<span class="sd">        See :func:`read_var` for description of input arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aux_requires</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compute_var</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_var</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                                    <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                                    <span class="n">ts_type</span><span class="o">=</span><span class="n">ts_type</span><span class="p">,</span>
                                    <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                                    <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">,</span>
                                    <span class="n">flex_ts_type</span><span class="o">=</span><span class="n">flex_ts_type</span><span class="p">,</span>
                                    <span class="n">prefer_longer</span><span class="o">=</span><span class="n">prefer_longer</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">var_to_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_var_to_read</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_var</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="n">var_to_read</span><span class="p">,</span>
                                  <span class="n">ts_type</span><span class="o">=</span><span class="n">ts_type</span><span class="p">,</span>
                                  <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                                  <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                                  <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">,</span>
                                  <span class="n">flex_ts_type</span><span class="o">=</span><span class="n">flex_ts_type</span><span class="p">,</span>
                                  <span class="n">prefer_longer</span><span class="o">=</span><span class="n">prefer_longer</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">VarNotAvailableError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compute_var</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_var</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                                        <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                                        <span class="n">ts_type</span><span class="o">=</span><span class="n">ts_type</span><span class="p">,</span>
                                        <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                                        <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">,</span>
                                        <span class="n">flex_ts_type</span><span class="o">=</span><span class="n">flex_ts_type</span><span class="p">,</span>
                                        <span class="n">prefer_longer</span><span class="o">=</span><span class="n">prefer_longer</span><span class="p">)</span>
        <span class="c1"># this input variable was explicitely set to be computed, in which</span>
        <span class="c1"># case reading of that variable is ignored even if a file exists for</span>
        <span class="c1"># that</span>
        <span class="k">raise</span> <span class="n">VarNotAvailableError</span><span class="p">(</span><span class="s2">&quot;Error: variable </span><span class="si">{}</span><span class="s2"> not available in &quot;</span>
                                    <span class="s2">&quot;files and can also not be computed.&quot;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">))</span>

<div class="viewcode-block" id="ReadGridded.read"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGridded.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vars_to_retrieve</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ts_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vert_which</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flex_ts_type</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">prefer_longer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">require_all_vars_avail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read all variables that could be found</span>

<span class="sd">        Reads all variables that are available (i.e. in :attr:`vars_filename`)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vars_to_retrieve : list or str, optional</span>
<span class="sd">            variables that are supposed to be read. If None, all variables</span>
<span class="sd">            that are available are read.</span>
<span class="sd">        start : Timestamp or str, optional</span>
<span class="sd">            start time of data import</span>
<span class="sd">        stop : Timestamp or str, optional</span>
<span class="sd">            stop time of data import</span>
<span class="sd">        ts_type : str, optional</span>
<span class="sd">            string specifying temporal resolution (choose from</span>
<span class="sd">            &quot;hourly&quot;, &quot;3hourly&quot;, &quot;daily&quot;, &quot;monthly&quot;). If None, prioritised</span>
<span class="sd">            of the available resolutions is used</span>
<span class="sd">        experiment : str</span>
<span class="sd">            name of experiment (only relevant if this dataset contains more</span>
<span class="sd">            than one experiment)</span>
<span class="sd">        vert_which : str or dict, optional</span>
<span class="sd">            valid AeroCom vertical info string encoded in name (e.g. Column,</span>
<span class="sd">            ModelLevel) or dictionary containing var_name as key and vertical</span>
<span class="sd">            coded string as value, accordingly</span>
<span class="sd">        flex_ts_type : bool</span>
<span class="sd">            if True and if applicable, then another ts_type is used in case</span>
<span class="sd">            the input ts_type is not available for this variable</span>
<span class="sd">        prefer_longer : bool</span>
<span class="sd">            if True and applicable, the ts_type resulting in the longer time</span>
<span class="sd">            coverage will be preferred over other possible frequencies that</span>
<span class="sd">            match the query.</span>
<span class="sd">        require_all_vars_avail : bool</span>
<span class="sd">            if True, it is strictly required that all input variables are</span>
<span class="sd">            available.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            optional and support for deprecated input args</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            loaded data objects (type :class:`GriddedData`)</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IOError</span>
<span class="sd">            if input variable names is not list or string</span>
<span class="sd">        VarNotAvailableError</span>
<span class="sd">            1. if ``require_all_vars_avail=True`` and one or more of the</span>
<span class="sd">            desired variables is not available in this class</span>
<span class="sd">            2. if ``require_all_vars_avail=True`` and if none of the input</span>
<span class="sd">            variables is available in this object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">vars_to_retrieve</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;var_names&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s1">&#39;Input arg var_names &#39;</span>
                                                       <span class="s1">&#39;is deprecated (but &#39;</span>
                                                       <span class="s1">&#39;still works). Please &#39;</span>
                                                       <span class="s1">&#39;use vars_to_retrieve &#39;</span>
                                                       <span class="s1">&#39;instead&#39;</span><span class="p">))</span>
            <span class="n">vars_to_retrieve</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;var_names&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vars_to_retrieve</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vars_to_retrieve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_filename</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vars_to_retrieve</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">vars_to_retrieve</span> <span class="o">=</span> <span class="p">[</span><span class="n">vars_to_retrieve</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vars_to_retrieve</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Invalid input for vars_to_retrieve </span><span class="si">{}</span><span class="s1">. Need string &#39;</span>
                          <span class="s1">&#39;or list of strings specifying var_names to load. &#39;</span>
                          <span class="s1">&#39;You may also leave it empty (None) in which case all &#39;</span>
                          <span class="s1">&#39;available variables are loaded&#39;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vars_to_retrieve</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">require_all_vars_avail</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars_provided</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_to_retrieve</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">VarNotAvailableError</span><span class="p">(</span><span class="s1">&#39;One or more of the specified vars &#39;</span>
                                        <span class="s1">&#39;(</span><span class="si">{}</span><span class="s1">) is not available in </span><span class="si">{}</span><span class="s1"> database. &#39;</span>
                                        <span class="s1">&#39;Available vars: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">vars_to_retrieve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">vars_provided</span><span class="p">))</span>
        <span class="n">var_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vars_provided</span><span class="p">,</span> <span class="n">vars_to_retrieve</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VarNotAvailableError</span><span class="p">(</span><span class="s1">&#39;None of the desired variables is &#39;</span>
                                        <span class="s1">&#39;available in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_var</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                                          <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                                          <span class="n">ts_type</span><span class="o">=</span><span class="n">ts_type</span><span class="p">,</span>
                                          <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                                          <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">,</span>
                                          <span class="n">flex_ts_type</span><span class="o">=</span><span class="n">flex_ts_type</span><span class="p">,</span>
                                          <span class="n">prefer_longer</span><span class="o">=</span><span class="n">prefer_longer</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">VarNotAvailableError</span><span class="p">,</span> <span class="n">DataCoverageError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_check_correct_units_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;invalid_units&#39;</span> <span class="ow">in</span> <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;invalid_units&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">const</span><span class="o">.</span><span class="n">GRID_IO</span><span class="o">.</span><span class="n">UNITS_ALIASES</span><span class="p">):</span>

            <span class="n">from_unit</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;invalid_units&#39;</span><span class="p">]</span>
            <span class="n">to_unit</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">GRID_IO</span><span class="o">.</span><span class="n">UNITS_ALIASES</span><span class="p">[</span><span class="n">from_unit</span><span class="p">]</span>
            <span class="n">const</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updating invalid unit in </span><span class="si">{}</span><span class="s1"> from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">cube</span><span class="p">),</span> <span class="n">from_unit</span><span class="p">,</span> <span class="n">to_unit</span><span class="p">))</span>

            <span class="n">cube</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">to_unit</span>
        <span class="k">return</span> <span class="n">cube</span>

    <span class="k">def</span> <span class="nf">_load_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">perform_fmt_checks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load list of files containing variable to read into Cube instances</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : list</span>
<span class="sd">            list of netcdf file</span>
<span class="sd">        var_name : str</span>
<span class="sd">            name of variable to read</span>
<span class="sd">        perform_fmt_checks : bool</span>
<span class="sd">            if True, the loaded data is checked for consistency with</span>
<span class="sd">            AeroCom default requirements.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            additional keyword args parsed to :func:`load_cubes_custom`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CubeList</span>
<span class="sd">            list of loaded Cube instances</span>
<span class="sd">        list</span>
<span class="sd">            list containing corresponding filenames of loaded cubes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cubes</span><span class="p">,</span> <span class="n">loaded_files</span> <span class="o">=</span> <span class="n">load_cubes_custom</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span>
                                                <span class="n">perform_fmt_checks</span><span class="o">=</span><span class="n">perform_fmt_checks</span><span class="p">,</span>
                                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cube</span> <span class="ow">in</span> <span class="n">cubes</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_correct_units_cube</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;None of the input files could be loaded in </span><span class="si">{}</span><span class="s2">&quot;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">))</span>

        <span class="c1">#self.loaded_cubes[var_name] = cubes</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">cubes</span><span class="p">,</span> <span class="n">loaded_files</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_meta_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract relevant meta information from file_info dataframe</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        subset : pd.DataFrame</span>
<span class="sd">            subset of, or :attr:`file_info`</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        DataQueryError</span>
<span class="sd">            if more than one time frequency is available in the dataframe</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># check additional metadata</span>
        <span class="n">ts_types</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">ts_type</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="c1"># sanity check</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataQueryError</span><span class="p">(</span><span class="s1">&#39;Fatal: subset contains more than one ts_type&#39;</span><span class="p">)</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;ts_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">mets</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">meteo</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;meteo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">mets</span><span class="p">)</span>

        <span class="n">exps</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">exps</span><span class="p">)</span>

        <span class="n">perts</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">perturbation</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;perturbation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">perts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">perts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">perts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">meta</span>

    <span class="k">def</span> <span class="nf">_load_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">ts_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
                  <span class="n">experiment</span><span class="p">,</span> <span class="n">vert_which</span><span class="p">,</span> <span class="n">flex_ts_type</span><span class="p">,</span>
                  <span class="n">prefer_longer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find files corresponding to input specs and load into GriddedData</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        See :func:`read_var` for I/O info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_vert_code</span><span class="p">:</span>
            <span class="n">vert_which</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_query</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">ts_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
                                   <span class="n">experiment</span><span class="p">,</span> <span class="n">vert_which</span><span class="p">,</span>
                                   <span class="n">is_at_stations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">flex_ts_type</span><span class="o">=</span><span class="n">flex_ts_type</span><span class="p">,</span>
                                   <span class="n">prefer_longer</span><span class="o">=</span><span class="n">prefer_longer</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataQueryError</span><span class="p">(</span><span class="s1">&#39;Could not find file match for query&#39;</span><span class="p">)</span>

        <span class="n">match_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_file_paths</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
        <span class="p">(</span><span class="n">cube_list</span><span class="p">,</span>
         <span class="n">from_files</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_files</span><span class="p">(</span><span class="n">match_files</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">is_concat</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cube_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenate_cubes</span><span class="p">(</span><span class="n">cube_list</span><span class="p">)</span>
                <span class="n">is_concat</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">iris</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConcatenateError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Failed to concatenate cubes: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span>
                                          <span class="s1">&#39;Error: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_list</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">cube_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_df</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">GriddedData</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">cube</span><span class="p">,</span>
                           <span class="n">from_files</span><span class="o">=</span><span class="n">from_files</span><span class="p">,</span>
                           <span class="n">data_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span>
                           <span class="n">concatenated</span><span class="o">=</span><span class="n">is_concat</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">meta</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c1"># crop cube in time (if applicable)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">start</span> <span class="o">==</span> <span class="mi">9999</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_crop_time</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Failed to crop time dimension in </span><span class="si">{}</span><span class="s1">. &#39;</span>
                                          <span class="s1">&#39;(start: </span><span class="si">{}</span><span class="s1">, stop: </span><span class="si">{}</span><span class="s1">)&#39;</span>
                                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_check_crop_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="n">crop_time</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">crop_time_range</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">crop_time</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">crop_time_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">crop_time</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">crop_time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crop_time</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applying temporal cropping of result cube&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">time_range</span><span class="o">=</span><span class="n">crop_time_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_check_ts_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check and, if applicable, update ts_type</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            valid ts_type</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ts_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Apparently no files with a valid ts_type &#39;</span>
                                     <span class="s1">&#39;entry in their filename could be found&#39;</span><span class="p">)</span>

            <span class="n">ts_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">TsType</span><span class="o">.</span><span class="n">valid</span><span class="p">(</span><span class="n">ts_type</span><span class="p">):</span><span class="c1"># in self.TS_TYPES:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid input for ts_type: </span><span class="si">{}</span><span class="s2">&quot;</span>
                             <span class="s2">&quot;allowed values: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ts_type</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ts_type</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try access import result for one of the models</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str</span>
<span class="sd">            string specifying variable that is supposed to be extracted</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        GriddedData</span>
<span class="sd">            the corresponding read class for this model</span>

<span class="sd">        Raises</span>
<span class="sd">        -------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if results for ``var_name`` are not available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_var</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
        <span class="c1">#return self.data[var_name]</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">head</span> <span class="o">=</span> <span class="s2">&quot;Pyaerocom </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;Data ID: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;Data directory: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;Available experiments: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;Available years: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;Available frequencies </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;Available variables: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">head</span><span class="p">,</span>
                                                <span class="nb">len</span><span class="p">(</span><span class="n">head</span><span class="p">)</span><span class="o">*</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">years_avail</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">ts_types</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">vars_provided</span><span class="p">))</span>
<span class="c1"># =============================================================================</span>
<span class="c1">#         if self.data:</span>
<span class="c1">#             s += &quot;\nLoaded GriddedData objects:\n&quot;</span>
<span class="c1">#             for var_name, data in self.data.items():</span>
<span class="c1">#                 s += &quot;{}\n&quot;.format(data.short_str())</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># =============================================================================</span>
<span class="c1">#         if self.data_yearly:</span>
<span class="c1">#             s += &quot;\nLoaded GriddedData objects (individual years):\n&quot;</span>
<span class="c1">#             for var_name, yearly_data in self.data_yearly.items():</span>
<span class="c1">#                 if yearly_data:</span>
<span class="c1">#                     for year, data in yearly_data.items():</span>
<span class="c1">#                         s += &quot;{}\n&quot;.format(data.short_str())</span>
<span class="c1"># =============================================================================</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

    <span class="c1">### DEPRECATED STUFF</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deprecated name of attribute data_id&quot;&quot;&quot;</span>
        <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s2">&quot;Please use data_id&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span></div>

<div class="viewcode-block" id="ReadGriddedMulti"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGriddedMulti">[docs]</a><span class="k">class</span> <span class="nc">ReadGriddedMulti</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for import of AEROCOM model data from multiple models</span>

<span class="sd">    This class provides an interface to import model results from an arbitrary</span>
<span class="sd">    number of models and specific for a certain time interval (that can be</span>
<span class="sd">    defined, but must not be defined). Largely based on</span>
<span class="sd">    :class:`ReadGridded`.</span>

<span class="sd">    ToDo</span>
<span class="sd">    ----</span>

<span class="sd">    Sub-class from ReadGridded</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The reading only works if files are stored using a valid file naming</span>
<span class="sd">    convention. See package data file `file_conventions.ini &lt;http://</span>
<span class="sd">    aerocom.met.no/pyaerocom/config_files.html#file-conventions&gt;`__ for valid</span>
<span class="sd">    keys. You may define your own fileconvention in this file, if you wish.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    data_ids : list</span>
<span class="sd">        list containing string IDs of all models that should be imported</span>
<span class="sd">    results : dict</span>
<span class="sd">        dictionary containing :class:`ReadGridded` instances for each</span>
<span class="sd">        name</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pyaerocom, pandas</span>
<span class="sd">    &gt;&gt;&gt; start, stop = pandas.Timestamp(&quot;2012-1-1&quot;), pandas.Timestamp(&quot;2012-5-1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; models = [&quot;AATSR_SU_v4.3&quot;, &quot;CAM5.3-Oslo_CTRL2016&quot;]</span>
<span class="sd">    &gt;&gt;&gt; read = pyaerocom.io.ReadGriddedMulti(models, start, stop)</span>
<span class="sd">    &gt;&gt;&gt; print(read.data_ids)</span>
<span class="sd">    [&#39;AATSR_SU_v4.3&#39;, &#39;CAM5.3-Oslo_CTRL2016&#39;]</span>
<span class="sd">    &gt;&gt;&gt; read_cam = read[&#39;CAM5.3-Oslo_CTRL2016&#39;]</span>
<span class="sd">    &gt;&gt;&gt; assert type(read_cam) == pyaerocom.io.ReadGridded</span>
<span class="sd">    &gt;&gt;&gt; for var in read_cam.vars: print(var)</span>
<span class="sd">    abs550aer</span>
<span class="sd">    deltaz3d</span>
<span class="sd">    humidity3d</span>
<span class="sd">    od440aer</span>
<span class="sd">    od550aer</span>
<span class="sd">    od550aer3d</span>
<span class="sd">    od550aerh2o</span>
<span class="sd">    od550dryaer</span>
<span class="sd">    od550dust</span>
<span class="sd">    od550lt1aer</span>
<span class="sd">    od870aer</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_ids</span><span class="p">):</span>
        <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s1">&#39;ReadGriddedMulti class is &#39;</span>
                                                   <span class="s1">&#39;deprecated and will not &#39;</span>
                                                   <span class="s1">&#39;be further developed. &#39;</span>
                                                   <span class="s1">&#39;Please use ReadGridded.&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_ids</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">data_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_ids</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">IllegalArgumentError</span><span class="p">(</span><span class="s2">&quot;Please provide string or list of strings&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_ids</span> <span class="o">=</span> <span class="n">data_ids</span>
        <span class="c1">#: dictionary containing instances of :class:`ReadGridded` for each</span>
        <span class="c1">#: datset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">readers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#self.data = {}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_readers</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_readers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">data_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">data_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReadGridded</span><span class="p">(</span><span class="n">data_id</span><span class="p">)</span>

<div class="viewcode-block" id="ReadGriddedMulti.read"><a class="viewcode-back" href="../../../api.html#pyaerocom.io.readgridded.ReadGriddedMulti.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vars_to_retrieve</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">ts_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;High level method to import data for multiple variables and models</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_names : :obj:`str` or :obj:`list`</span>
<span class="sd">            string IDs of all variables that are supposed to be imported</span>
<span class="sd">        start : :obj:`Timestamp` or :obj:`str`, optional</span>
<span class="sd">            start time of data import (if valid input, then the current</span>
<span class="sd">            :attr:`start` will be overwritten)</span>
<span class="sd">        stop : :obj:`Timestamp` or :obj:`str`, optional</span>
<span class="sd">            stop time of data import (if valid input, then the current</span>
<span class="sd">            :attr:`start` will be overwritten)</span>
<span class="sd">        ts_type : str</span>
<span class="sd">            string specifying temporal resolution (choose from</span>
<span class="sd">            &quot;hourly&quot;, &quot;3hourly&quot;, &quot;daily&quot;, &quot;monthly&quot;).If None, prioritised</span>
<span class="sd">            of the available resolutions is used</span>
<span class="sd">        flex_ts_type : bool</span>
<span class="sd">            if True and if applicable, then another ts_type is used in case</span>
<span class="sd">            the input ts_type is not available for this variable</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            loaded objects, keys are variable names, values are</span>
<span class="sd">            instances of :class:`GridddedData`.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">            &gt;&gt;&gt; read = ReadGriddedMulti(names=[&quot;ECMWF_CAMS_REAN&quot;,</span>
<span class="sd">            ...                                &quot;ECMWF_OSUITE&quot;])</span>
<span class="sd">            &gt;&gt;&gt; read.read([&quot;od550aer&quot;, &quot;od550so4&quot;, &quot;od550bc&quot;])</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vars_to_retrieve</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">vars_to_retrieve</span> <span class="o">=</span> <span class="p">[</span><span class="n">vars_to_retrieve</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">data_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">data_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReadGridded</span><span class="p">(</span><span class="n">data_id</span><span class="p">)</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">data_id</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">data_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_to_retrieve</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">ts_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">data_id</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                    <span class="c1">#self.data[data_id][var] = data</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Failed to read data of </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span>
                                            <span class="s1">&#39;Error message: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_id</span><span class="p">,</span>
                                                                       <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">out</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">head</span> <span class="o">=</span> <span class="s2">&quot;Pyaerocom </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;Data-IDs: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">head</span><span class="p">)</span><span class="o">*</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ids</span><span class="p">))</span>
<span class="c1"># =============================================================================</span>
<span class="c1">#         if bool(self.data):</span>
<span class="c1">#             s += &quot;\nLoaded data:&quot;</span>
<span class="c1">#             for name, vardata in self.data.items():</span>
<span class="c1">#                 for var, data in vardata.items():</span>
<span class="c1">#                     s += &quot;\n%s&quot; %var</span>
<span class="c1"># =============================================================================</span>
        <span class="k">return</span> <span class="n">s</span></div>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyaerocom</span> <span class="k">as</span> <span class="nn">pya</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">ReadGridded</span><span class="p">(</span><span class="s1">&#39;AATSR_SU_v4.3&#39;</span><span class="p">)</span>
    <span class="n">read_constraint</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">var_name</span> <span class="o">=</span> <span class="s1">&#39;od550aer&#39;</span><span class="p">,</span>
        <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span>
        <span class="n">filter_val</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="p">)</span>

    <span class="n">ae</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_var</span><span class="p">(</span><span class="s1">&#39;ang4487aer&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">2010</span><span class="p">)</span>
    <span class="n">ae_qa</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_var</span><span class="p">(</span><span class="s1">&#39;ang4487aer&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">2010</span><span class="p">,</span>
                         <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">read_constraint</span><span class="p">])</span>

    <span class="n">ae</span><span class="o">.</span><span class="n">resample_time</span><span class="p">(</span><span class="s1">&#39;yearly&#39;</span><span class="p">,</span> <span class="n">apply_constraints</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">quickplot_map</span><span class="p">()</span>
    <span class="n">ae_qa</span><span class="o">.</span><span class="n">resample_time</span><span class="p">(</span><span class="s1">&#39;yearly&#39;</span><span class="p">,</span> <span class="n">apply_constraints</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">quickplot_map</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, MET Norway

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>