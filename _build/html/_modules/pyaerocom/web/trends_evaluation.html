

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyaerocom.web.trends_evaluation &mdash; pyaerocom  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> pyaerocom
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#citation">Citation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#access-to-users-database">Access to users database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#getting-started">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pyaerocom-tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyaerocom</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyaerocom.web.trends_evaluation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyaerocom.web.trends_evaluation</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ToDos</span>
<span class="sd">-----</span>

<span class="sd">- Review outlier removal</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span> <span class="k">as</span> <span class="n">od</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">fnmatch</span> <span class="kn">import</span> <span class="n">fnmatch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pyaerocom</span> <span class="kn">import</span> <span class="n">const</span><span class="p">,</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">Region</span>
<span class="kn">from</span> <span class="nn">pyaerocom._lowlevel_helpers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">check_dirs_exist</span><span class="p">,</span> <span class="n">dict_to_str</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyaerocom.helpers</span> <span class="kn">import</span> <span class="n">isnumeric</span>
<span class="kn">from</span> <span class="nn">pyaerocom.trends_helpers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">_init_trends_result_dict</span><span class="p">,</span>
                                      <span class="n">_compute_trend_error</span><span class="p">,</span>
                                      <span class="n">_get_season</span><span class="p">,</span> <span class="n">_mid_season</span><span class="p">,</span>
                                      <span class="n">_find_area</span><span class="p">,</span> <span class="n">_years_from_periodstr</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyaerocom.tstype</span> <span class="kn">import</span> <span class="n">TsType</span>
<span class="kn">from</span> <span class="nn">pyaerocom.io.helpers</span> <span class="kn">import</span> <span class="n">save_dict_json</span>
<span class="kn">from</span> <span class="nn">pyaerocom.io</span> <span class="kn">import</span> <span class="n">ReadGridded</span>
<span class="kn">from</span> <span class="nn">pyaerocom.web.var_groups</span> <span class="kn">import</span> <span class="n">var_groups</span>
<span class="kn">from</span> <span class="nn">pyaerocom.web.helpers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ObsConfigEval</span><span class="p">,</span> <span class="n">ModelConfigEval</span><span class="p">,</span>
                                   <span class="n">read_json</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyaerocom.web.helpers_trends_iface</span> <span class="kn">import</span> <span class="p">(</span><span class="n">update_menu_trends_iface</span><span class="p">,</span>
                                                <span class="n">get_all_config_files_trends_iface</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyaerocom.exceptions</span> <span class="kn">import</span> <span class="n">DataCoverageError</span><span class="p">,</span> <span class="n">TemporalResolutionError</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">kendalltau</span>
<span class="kn">from</span> <span class="nn">scipy.stats.mstats</span> <span class="kn">import</span> <span class="n">theilslopes</span>
<span class="kn">import</span> <span class="nn">simplejson</span>

<div class="viewcode-block" id="TrendsEvaluation"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation">[docs]</a><span class="k">class</span> <span class="nc">TrendsEvaluation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;High-level analysis class to compute json files for trends interface</span>

<span class="sd">    Web: https://aerocom-trends.met.no/</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    name : str</span>
<span class="sd">        name of this configuration setup</span>
<span class="sd">    config_dir : str, optional</span>
<span class="sd">        directory containing available configuration files</span>
<span class="sd">    out_basedir : str</span>
<span class="sd">        basic output directory</span>
<span class="sd">    out_dirs : dict</span>
<span class="sd">        dictionary containing output directories relative to `out_basedir`</span>
<span class="sd">        (will be filled automatically in :func:`init_dirs`)</span>
<span class="sd">    obs_config : dict</span>
<span class="sd">        dictionary containing configuration details for individual observations</span>
<span class="sd">        (i.e. instances of :class:`ObsConfigEval` for each observation) used</span>
<span class="sd">        for the analysis.</span>
<span class="sd">    obs_ignore : list, optional</span>
<span class="sd">        list of observations that are supposed to be ignored in analysis</span>
<span class="sd">        (keys from :attr:`obs_config`)</span>
<span class="sd">    model_config : dict</span>
<span class="sd">        dictionary specifying models or satellites to be used for colocation</span>
<span class="sd">        with the observations.</span>
<span class="sd">    periods : list</span>
<span class="sd">        list of periods used for the trends analysis</span>
<span class="sd">    regions : dict</span>
<span class="sd">        dictionary containing regions used for regional statistics. Keys</span>
<span class="sd">        are region names as displayed in web interface and values are</span>
<span class="sd">        instances of :class:`pyaerocom.Region` for each of the regions.</span>
<span class="sd">    var_mapping : dict</span>
<span class="sd">        mapping of variable names for menu in interface</span>
<span class="sd">    var_order_menu : list, optional</span>
<span class="sd">        order of variables in menu.</span>
<span class="sd">    obs_order_menu_cfg : bool</span>
<span class="sd">        where applicable and if True, then order observations with common</span>
<span class="sd">        variables in the menu in the same order as they appear in</span>
<span class="sd">        :attr:`obs_config`. If False, order alphabetically.</span>
<span class="sd">    slope_alpha : float</span>
<span class="sd">        desired confidence of trends slope retrieval (`alpha` parameter</span>
<span class="sd">        in :func:`scipy.stats.theilslopes`), e.g. .68 corresponds to 1sigma</span>
<span class="sd">        confidence (68%).</span>
<span class="sd">    min_dim : int</span>
<span class="sd">        minimum number of measurements per month in order to compute monthly</span>
<span class="sd">        averages (does not apply for input data that is already aggregated to</span>
<span class="sd">        monthly).</span>
<span class="sd">    avg_how : str</span>
<span class="sd">        averaging method for temporal aggregation (see :attr:`AVG_OPTS` for</span>
<span class="sd">        allowed values).</span>
<span class="sd">    clear_existing_json : bool</span>
<span class="sd">        If true, then existing json files for a given run will be deleted</span>
<span class="sd">        before rerunning (per entry in :attr:`obs_config`).</span>
<span class="sd">    write_logfiles : bool</span>
<span class="sd">        if True, then logfiles will be written for outliers that were</span>
<span class="sd">        identified, errors that occurred and files that were created in the</span>
<span class="sd">        analysis (per entry in :attr:`obs_config`).</span>
<span class="sd">    logdir : str</span>
<span class="sd">        directory where logfiles are stored.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config_file : str, optional</span>
<span class="sd">        if provided and valid, then configuration is loaded from this file</span>
<span class="sd">    **settings</span>
<span class="sd">        configuration settings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#: Vertical layer ranges</span>
    <span class="n">VERT_LAYERS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;0-2km&#39;</span>  <span class="p">:</span>   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2000</span><span class="p">],</span>
                   <span class="s1">&#39;2-5km&#39;</span>  <span class="p">:</span>   <span class="p">[</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">],</span>
                   <span class="s1">&#39;5-10km&#39;</span> <span class="p">:</span>   <span class="p">[</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]}</span>

    <span class="c1">#: Names of output directories relative to :attr:`out_basedir`</span>
    <span class="n">OUT_DIR_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">]</span>

    <span class="c1">#: available averaging options for timeseries</span>
    <span class="n">AVG_OPTS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">]</span>

    <span class="c1">#: mapping of metadata names between pyaerocom (keys) and json trends files</span>
    <span class="c1">#: (values)</span>
    <span class="c1">#: ToDo: this should not be needed and the web tools should use the same</span>
    <span class="c1">#: conventions as pyaerocom</span>
    <span class="n">KEYMAP</span> <span class="o">=</span> <span class="n">od</span><span class="p">(</span><span class="n">var_name</span>        <span class="o">=</span> <span class="s1">&#39;var_name&#39;</span><span class="p">,</span>
                <span class="n">station_name</span>    <span class="o">=</span> <span class="s1">&#39;station&#39;</span><span class="p">,</span>
                <span class="n">latitude</span>        <span class="o">=</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span>
                <span class="n">longitude</span>       <span class="o">=</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span>
                <span class="n">altitude</span>        <span class="o">=</span> <span class="s1">&#39;alt&#39;</span><span class="p">,</span>
                <span class="n">data_id</span>         <span class="o">=</span> <span class="s1">&#39;data_id&#39;</span><span class="p">,</span>
                <span class="n">dataset_name</span>    <span class="o">=</span> <span class="s1">&#39;dataset&#39;</span><span class="p">,</span>
                <span class="n">data_product</span>    <span class="o">=</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span>
                <span class="n">framework</span>       <span class="o">=</span> <span class="s1">&#39;framework&#39;</span><span class="p">,</span>
                <span class="n">data_version</span>    <span class="o">=</span> <span class="s1">&#39;data_version&#39;</span><span class="p">,</span>
                <span class="n">data_level</span>      <span class="o">=</span> <span class="s1">&#39;data_level&#39;</span><span class="p">,</span>
                <span class="n">website</span>         <span class="o">=</span> <span class="s1">&#39;website&#39;</span><span class="p">,</span>
                <span class="n">instrument_name</span> <span class="o">=</span> <span class="s1">&#39;instrument&#39;</span><span class="p">,</span>
                <span class="n">ts_type_src</span>     <span class="o">=</span> <span class="s1">&#39;freq_src&#39;</span><span class="p">,</span>
                <span class="n">ts_type</span>         <span class="o">=</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span>
                <span class="n">PI</span>              <span class="o">=</span> <span class="s1">&#39;PI&#39;</span><span class="p">,</span>
                <span class="n">wavelength</span>      <span class="o">=</span> <span class="s1">&#39;wavelength&#39;</span><span class="p">,</span>
                <span class="n">units</span>           <span class="o">=</span> <span class="s1">&#39;unit&#39;</span><span class="p">,</span>
                <span class="n">statistics</span>      <span class="o">=</span> <span class="s1">&#39;statistics&#39;</span><span class="p">,</span>
                <span class="n">matrix</span>          <span class="o">=</span> <span class="s1">&#39;size_info&#39;</span><span class="p">,</span>
                <span class="n">overlap_info</span>    <span class="o">=</span> <span class="s1">&#39;data_overlap&#39;</span><span class="p">)</span>

    <span class="c1">#: supported frequency codes</span>
    <span class="n">TS_TYPES</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">GRID_IO</span><span class="o">.</span><span class="n">TS_TYPES</span>

    <span class="c1">#: Definition of regions for trends interface</span>
    <span class="c1"># ToDo: use pyaerocom regions</span>
    <span class="n">DEFAULT_REGIONS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;NAMERICA&#39;</span><span class="p">:</span> <span class="s1">&#39;N-America&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SAMERICA&#39;</span><span class="p">:</span> <span class="s1">&#39;S-America&#39;</span><span class="p">,</span>
            <span class="s1">&#39;EUROPE&#39;</span><span class="p">:</span> <span class="s1">&#39;Europe&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ASIA&#39;</span><span class="p">:</span> <span class="s1">&#39;Asia&#39;</span><span class="p">,</span>
            <span class="c1">#&#39;CHINA&#39;: &#39;China&#39;,</span>
            <span class="s1">&#39;AUSTRALIA&#39;</span><span class="p">:</span> <span class="s1">&#39;Australia&#39;</span><span class="p">,</span>
            <span class="s1">&#39;NAFRICA&#39;</span><span class="p">:</span> <span class="s1">&#39;N-Africa&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SAFRICA&#39;</span><span class="p">:</span> <span class="s1">&#39;S-Africa&#39;</span><span class="p">,</span>
            <span class="c1">#&#39;INDIA&#39;: &#39;India&#39;,</span>
            <span class="s1">&#39;WORLD&#39;</span><span class="p">:</span> <span class="s1">&#39;World&#39;</span>
    <span class="p">}</span>
    <span class="n">SEASONS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spring&#39;</span><span class="p">,</span><span class="s1">&#39;summer&#39;</span><span class="p">,</span><span class="s1">&#39;autumn&#39;</span><span class="p">,</span><span class="s1">&#39;winter&#39;</span><span class="p">,</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>

    <span class="n">JSON_CFG_IGNORE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">,</span> <span class="s1">&#39;_log&#39;</span><span class="p">,</span> <span class="s1">&#39;out_dirs&#39;</span><span class="p">]</span>

    <span class="n">GRIDDED_TS_TYPE</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">print_log</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_basedir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_dirs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_ignore</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">periods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_regions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var_mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_order_menu</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obs_order_menu_cfg</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slope_alpha</span> <span class="o">=</span> <span class="mf">0.68</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_dim</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg_how</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delete_outdated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_existing_json</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_logfiles</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logdir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># initialise</span>
        <span class="k">if</span> <span class="n">config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># user provided configuration file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># user maybe provided full config via dict, or only name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;obs_config&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_obsconfig</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;model_config&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_modelconfig</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;obs_id&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Obs config for key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> already exists and &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;will be overwritten&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObsConfigEval</span><span class="p">(</span><span class="o">**</span><span class="n">val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;model_id&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;mtype&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Need key &quot;mtype&quot; in specfication of model </span><span class="si">{}</span><span class="s1">&#39;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Model config for key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> already &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;exists and will be overwritten&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ModelConfigEval</span><span class="p">(</span><span class="o">**</span><span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Invalid input key </span><span class="si">{}</span><span class="s1">. Cannot assign </span><span class="si">{}</span><span class="s1">&#39;</span>
                           <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No such key available: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">_indent_str</span> <span class="o">=</span> <span class="n">indent</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="n">head</span> <span class="o">=</span> <span class="s2">&quot;Pyaerocom </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">head</span><span class="p">)</span><span class="o">*</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">obs_cfg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;obs_config&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">obs_cfg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="si">{}{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_indent_str</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                    <span class="n">obs_cfg</span> <span class="o">=</span> <span class="n">dict_to_str</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">obs_cfg</span><span class="p">,</span>
                                          <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">dict_to_str</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">obs_cfg</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="TrendsEvaluation.get_config_files"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.get_config_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_config_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all available configuration files</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config_dir : str</span>
<span class="sd">            directory containing configuration files</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            dictionary containing all available configuration files</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        FileNotFoundError</span>
<span class="sd">            if no config files could be found in input directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">get_all_config_files_trends_iface</span><span class="p">(</span><span class="n">config_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">files</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Could not find any configuration files&#39;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">menu_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;json file containing region specifications&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_basedir</span><span class="p">,</span> <span class="s1">&#39;menu.json&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_obs_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of all obs names&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_map_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of all existing map files&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dirs</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">])</span>
                       <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;OBS-&#39;</span><span class="p">)])</span>

<div class="viewcode-block" id="TrendsEvaluation.check_config"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.check_config">[docs]</a>    <span class="k">def</span> <span class="nf">check_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if there are any problems in the configuration</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if all is good, False, if configuration settings are missing</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if one of the provided period strings is invalid</span>
<span class="sd">        AttributeError</span>
<span class="sd">            if model configuration is missing</span>
<span class="sd">        AssertionError</span>
<span class="sd">            if there is a problem with EBAS default configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periods</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">periods</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">_years_from_periodstr</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for period: </span><span class="si">{}</span><span class="s1">. &#39;</span>
                                 <span class="s1">&#39;Need string in format &quot;2010-2019&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">run</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">run</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Invalid name: </span><span class="si">{}</span><span class="s1"> (no underscores allowed)&#39;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">obs_id</span> <span class="o">==</span> <span class="s1">&#39;EBASMC&#39;</span><span class="p">:</span>
                <span class="n">check_ebas_default</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;models&#39;</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;No such model with name </span><span class="si">{}</span><span class="s1"> &#39;</span>
                                             <span class="s1">&#39;available in model_config...&#39;</span>
                                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="TrendsEvaluation.find_obs_matches"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.find_obs_matches">[docs]</a>    <span class="k">def</span> <span class="nf">find_obs_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_or_pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find model names that match input search pattern(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name_or_pattern : :obj:`str`, or :obj:`list`</span>
<span class="sd">            Name or pattern specifying obs search string. Can also be a list</span>
<span class="sd">            of names or patterns to search for multiple obs networks.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list of model names (i.e. keys of :attr:`obs_config`) that match</span>
<span class="sd">            the input search string(s) or pattern(s)</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            if no matches can be found</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_pattern</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">name_or_pattern</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_or_pattern</span><span class="p">]</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">search_pattern</span> <span class="ow">in</span> <span class="n">name_or_pattern</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">mname</span><span class="p">,</span> <span class="n">search_pattern</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mname</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                    <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mname</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No models could be found that match input </span><span class="si">{}</span><span class="s1">&#39;</span>
                           <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_or_pattern</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">matches</span></div>

<div class="viewcode-block" id="TrendsEvaluation.check_model_access"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.check_model_access">[docs]</a>    <span class="k">def</span> <span class="nf">check_model_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">vars_to_retrieve</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check availability of input variables in input model IDs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        models : list</span>
<span class="sd">            list of model names that available in :attr:`model_config`.</span>
<span class="sd">        vars_to_retrieve : list</span>
<span class="sd">            list of variable names that are supposed to be checked in models</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            keys are models and values are lists of variables that are</span>
<span class="sd">            available in each of these models</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">maccess</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;No model </span><span class="si">{}</span><span class="s1"> available in model_config&#39;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">))</span>
            <span class="n">mcfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
            <span class="n">model_id</span> <span class="o">=</span> <span class="n">mcfg</span><span class="p">[</span><span class="s1">&#39;model_id&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">ReadGridded</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
                <span class="n">vars_avail</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">obs_var</span> <span class="ow">in</span> <span class="n">vars_to_retrieve</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">mod_var</span> <span class="o">=</span> <span class="n">mcfg</span><span class="p">[</span><span class="s1">&#39;model_use_vars&#39;</span><span class="p">][</span><span class="n">obs_var</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">mod_var</span> <span class="o">=</span> <span class="n">obs_var</span>
                    <span class="k">if</span> <span class="n">mod_var</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">vars_provided</span><span class="p">:</span>
                        <span class="n">vars_avail</span><span class="p">[</span><span class="n">obs_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_var</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_avail</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">maccess</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
                                               <span class="n">vars_avail</span><span class="o">=</span><span class="n">vars_avail</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Model </span><span class="si">{}</span><span class="s1"> does not provide any of the req. &#39;</span>
                                  <span class="s1">&#39;variables </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span>
                                                        <span class="n">vars_to_retrieve</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">maccess</span></div>

<div class="viewcode-block" id="TrendsEvaluation.load_ungridded"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.load_ungridded">[docs]</a>    <span class="k">def</span> <span class="nf">load_ungridded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network_id</span><span class="p">,</span> <span class="n">vars_to_retrieve</span><span class="p">,</span> <span class="o">**</span><span class="n">constraints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load obsdata into instance of :class:`pyaerocom.UngriddedData`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        network_id : str</span>
<span class="sd">            Name of network (if you don&#39;t know the options, check</span>
<span class="sd">            `pyaerocom.const.OBS_IDS_UNGRIDDED`)</span>
<span class="sd">        vars_to_retrieve</span>
<span class="sd">            str or list / tuple of strings specifying AEROCOM variables that are</span>
<span class="sd">            supposed to be imported</span>
<span class="sd">        **constraints</span>
<span class="sd">            Further reading constraints passed to :func:`UngriddedData.read` and</span>
<span class="sd">            from there, further passed to :func:`read`  of respective network</span>
<span class="sd">            reading class.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UngriddedData</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pyaerocom</span> <span class="k">as</span> <span class="nn">pya</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pya</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ReadUngridded</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">datasets_to_read</span><span class="o">=</span><span class="n">network_id</span><span class="p">,</span>
                      <span class="n">vars_to_retrieve</span><span class="o">=</span><span class="n">vars_to_retrieve</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">constraints</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrendsEvaluation.run_evaluation"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.run_evaluation">[docs]</a>    <span class="k">def</span> <span class="nf">run_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_menu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">write_logfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clear_existing_json</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run trends evaluation (main function of this interface)</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Individual runs are / can be specified in :attr:`obs_config`</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        obs_name : str or list, optional</span>
<span class="sd">            name(s) of run(s). If None, then all runs available in</span>
<span class="sd">            :attr:`obs_config` are used.</span>
<span class="sd">        update_menu : bool</span>
<span class="sd">            if True, the menu.json file is automatically updated (if</span>
<span class="sd">            applicable)</span>
<span class="sd">        write_logfiles : bool, optional</span>
<span class="sd">            option to write logfiles (uses :attr:`write_logfiles` if None,</span>
<span class="sd">            else, updates the latter)</span>
<span class="sd">        clear_existing_json : bool, optional</span>
<span class="sd">            option to write logfiles (uses :attr:`clear_existing_json` if None,</span>
<span class="sd">            else, updates the latter)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            nested dictionary containing information about the individual runs</span>
<span class="sd">            (keys), that is, the output from :func:`run_single` for each of the</span>
<span class="sd">            runs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_outdated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_outdated_json_files</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">write_logfiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_logfiles</span> <span class="o">=</span> <span class="n">write_logfiles</span>
        <span class="k">if</span> <span class="n">clear_existing_json</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_existing_json</span> <span class="o">=</span> <span class="n">clear_existing_json</span>
        <span class="k">if</span> <span class="n">obs_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obs_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obs_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_obs_matches</span><span class="p">(</span><span class="n">obs_name</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">obs_name</span> <span class="ow">in</span> <span class="n">obs_list</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">obs_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_single</span><span class="p">(</span><span class="n">obs_name</span><span class="p">,</span> <span class="n">write_logfiles</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">files_written</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Files written:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RUN: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">files_written</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Folder: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Files: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_regions_json</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">update_menu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_menu</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="TrendsEvaluation.get_var_groups"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.get_var_groups">[docs]</a>    <span class="k">def</span> <span class="nf">get_var_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split list of variables of obs into variable sublists</span>

<span class="sd">        Splitting is done based on predefined var groups, defined in</span>
<span class="sd">        :mod:`var_groups`, where available.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs_id : str</span>
<span class="sd">            Name of obsdata source (key of :attr:`obs_config`)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list containing sublists for different variable groups</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obs_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="p">[</span><span class="n">obs_name</span><span class="p">][</span><span class="s1">&#39;obs_id&#39;</span><span class="p">]</span>
        <span class="n">vars_to_retrieve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="p">[</span><span class="n">obs_name</span><span class="p">][</span><span class="s1">&#39;obs_vars&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_id</span> <span class="ow">in</span> <span class="n">var_groups</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">vars_to_retrieve</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">groups</span> <span class="o">=</span>  <span class="n">var_groups</span><span class="p">[</span><span class="n">obs_id</span><span class="p">]</span>
        <span class="n">added</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">vars_to_retrieve</span><span class="p">,</span> <span class="n">group</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">added</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">subset</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Fatal: one variable appears to exist in 2 groups&#39;</span><span class="p">)</span>
            <span class="n">added</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vars_to_retrieve</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">added</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="TrendsEvaluation.run_single"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.run_single">[docs]</a>    <span class="k">def</span> <span class="nf">run_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">,</span> <span class="n">write_logfiles</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run one of the config entries in :attr:`obs_config`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs_name : str</span>
<span class="sd">            name of run (key in :attr:`obs_config`)</span>
<span class="sd">        write_logfiles : bool</span>
<span class="sd">            write logfiles</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            map and ts files that were created</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No such run with name </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_name</span><span class="p">))</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="p">[</span><span class="n">obs_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_existing_json</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Deleting existing files for run </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_existing</span><span class="p">(</span><span class="n">obs_name</span><span class="p">)</span>

        <span class="n">obs_id</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;obs_id&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running </span><span class="si">{}</span><span class="s1"> (NETWORK </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_id</span><span class="p">))</span>

        <span class="n">constraints</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;read_opts_ungridded&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">outlier_log</span><span class="p">,</span> <span class="n">err_log</span><span class="p">,</span> <span class="n">files_log</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">write_logfiles</span><span class="p">:</span>
            <span class="n">outlier_log</span><span class="p">,</span> <span class="n">err_log</span><span class="p">,</span> <span class="n">files_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_logfiles</span><span class="p">(</span><span class="n">obs_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;var_outlier_ranges&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">min_max</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;var_outlier_ranges&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_max</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;min_dim&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">min_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;min_dim&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_dim</span>
        <span class="k">if</span> <span class="s1">&#39;models&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">models</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">models</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">files_created</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ts&#39;</span>  <span class="p">:</span> <span class="p">[],</span>
                         <span class="s1">&#39;map&#39;</span> <span class="p">:</span> <span class="p">[]}</span>

        <span class="n">var_lists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_var_groups</span><span class="p">(</span><span class="n">obs_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vars_to_retrieve</span> <span class="ow">in</span> <span class="n">var_lists</span><span class="p">:</span>
            <span class="n">ungridded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ungridded</span><span class="p">(</span><span class="n">obs_id</span><span class="p">,</span> <span class="n">vars_to_retrieve</span><span class="p">,</span>
                                                 <span class="o">**</span><span class="n">constraints</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;obs_filters&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="n">filters</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;obs_filters&#39;</span><span class="p">]</span>
                <span class="n">ungridded_data</span> <span class="o">=</span> <span class="n">ungridded_data</span><span class="o">.</span><span class="n">apply_filters</span><span class="p">(</span><span class="n">var_outlier_ranges</span><span class="o">=</span><span class="n">min_max</span><span class="p">,</span>
                                                              <span class="o">**</span><span class="n">filters</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;obs_vert_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Profile&#39;</span><span class="p">:</span>
                <span class="n">files_created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_single_3d</span><span class="p">(</span><span class="n">ungridded_data</span><span class="o">=</span><span class="n">ungridded_data</span><span class="p">,</span>
                                                    <span class="n">vars_to_retrieve</span><span class="o">=</span><span class="n">vars_to_retrieve</span><span class="p">,</span>
                                                    <span class="n">min_dim</span><span class="o">=</span><span class="n">min_dim</span><span class="p">,</span>
                                                    <span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="p">,</span>
                                                    <span class="n">name</span><span class="o">=</span><span class="n">obs_name</span><span class="p">,</span>
                                                    <span class="n">files_created</span><span class="o">=</span><span class="n">files_created</span><span class="p">,</span>
                                                    <span class="n">err_log</span><span class="o">=</span><span class="n">err_log</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">files_created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_single_2d</span><span class="p">(</span><span class="n">ungridded_data</span><span class="o">=</span><span class="n">ungridded_data</span><span class="p">,</span>
                                                    <span class="n">vars_to_retrieve</span><span class="o">=</span><span class="n">vars_to_retrieve</span><span class="p">,</span>
                                                    <span class="n">min_dim</span><span class="o">=</span><span class="n">min_dim</span><span class="p">,</span>
                                                    <span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="p">,</span>
                                                    <span class="n">name</span><span class="o">=</span><span class="n">obs_name</span><span class="p">,</span>
                                                    <span class="n">vert_which</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;obs_vert_type&#39;</span><span class="p">],</span>
                                                    <span class="n">files_created</span><span class="o">=</span><span class="n">files_created</span><span class="p">,</span>
                                                    <span class="n">err_log</span><span class="o">=</span><span class="n">err_log</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">write_logfiles</span><span class="p">:</span>
            <span class="n">files_log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;MAP files</span><span class="se">\n</span><span class="s1">---------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_created</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]:</span>
                <span class="n">files_log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="n">files_log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Station ts files</span><span class="se">\n</span><span class="s1">---------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_created</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]:</span>
                <span class="n">files_log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">write_logfiles</span><span class="p">:</span>
            <span class="n">outlier_log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">err_log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">files_log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">files_created</span></div>

<div class="viewcode-block" id="TrendsEvaluation.update_menu"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.update_menu">[docs]</a>    <span class="k">def</span> <span class="nf">update_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update menu.json based on available runs&quot;&quot;&quot;</span>
        <span class="n">update_menu_trends_iface</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">regions_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;File path of regions.json file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_basedir</span><span class="p">,</span> <span class="s1">&#39;regions.json&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="TrendsEvaluation.make_regions_json"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.make_regions_json">[docs]</a>    <span class="k">def</span> <span class="nf">make_regions_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make regions.json file for web interface&quot;&quot;&quot;</span>
        <span class="n">regs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">regname</span><span class="p">,</span> <span class="n">reg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="n">regs</span><span class="p">[</span><span class="n">regname</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">latr</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">lat_range</span>
            <span class="n">lonr</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">lon_range</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;minLat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;maxLat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;minLon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;maxLon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">save_dict_json</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">regs</span></div>

<div class="viewcode-block" id="TrendsEvaluation.update"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update current setup&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_basedir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_dirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_regions</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_config</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setup is incomplete&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrendsEvaluation.search_config_file"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.search_config_file">[docs]</a>    <span class="k">def</span> <span class="nf">search_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to find valid configuration file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Attr. name needs to be specified&#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;No config </span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span><span class="p">))</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_files</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;No config </span><span class="si">{}</span><span class="s1"> in current &#39;</span>
                                            <span class="s1">&#39;directory&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Could not find a valid configuration file&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">autoload</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Importing configuration from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file</span></div>

<div class="viewcode-block" id="TrendsEvaluation.from_json"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.from_json">[docs]</a>    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load configuration from json config file&quot;&quot;&quot;</span>
<span class="c1"># =============================================================================</span>
<span class="c1">#         with open(config_file, &#39;r&#39;) as f:</span>
<span class="c1">#             current = simplejson.load(f)</span>
<span class="c1"># =============================================================================</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">current</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrendsEvaluation.to_dict"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert configuration to dictionary&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">JSON_CFG_IGNORE</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;model_config&#39;</span><span class="p">:</span>
                    <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_config_asdict</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;obs_config&#39;</span><span class="p">:</span>
                    <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obs_config_asdict</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sub</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">sub</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="TrendsEvaluation.to_json"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.to_json">[docs]</a>    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert configuration to json ini file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Attr. &quot;name&quot; needs to be specified&#39;</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;cfg_</span><span class="si">{}</span><span class="s1">.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cfg_&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;json configuration file MUST start with cfg_&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">):</span>
            <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;.json&#39;</span>
        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_basedir</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">save_dict_json</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fp</span></div>

<div class="viewcode-block" id="TrendsEvaluation.print_run_ids"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.print_run_ids">[docs]</a>    <span class="k">def</span> <span class="nf">print_run_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detailed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints all available run ID&#39;s</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        check_existing : bool</span>
<span class="sd">            if True, a check is performed for each run ID, whether .json files</span>
<span class="sd">            exist in the data repository</span>
<span class="sd">        detailed : bool</span>
<span class="sd">            if True, the corresponding settings for the run are printed too</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">run</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Run ID: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">detailed</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">check_existing</span><span class="p">:</span>
                <span class="n">there</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dirs</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                            <span class="n">there</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data files (json) exist: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">there</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to check for existing runs for ID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_meta_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract meta information from json file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : str</span>
<span class="sd">            map or ts json file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            obs_name</span>
<span class="sd">        str</span>
<span class="sd">            obs_var</span>
<span class="sd">        str</span>
<span class="sd">            vert_code</span>
<span class="sd">        str</span>
<span class="sd">            mod_name</span>
<span class="sd">        str</span>
<span class="sd">            mod_var</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obs_info</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;OBS-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_MOD&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_var</span> <span class="o">=</span> <span class="n">obs_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">vert_code</span> <span class="o">=</span> <span class="n">obs_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mod_name</span><span class="p">,</span> <span class="n">mod_var</span> <span class="o">=</span>  <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;MOD-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">vert_code</span><span class="p">,</span> <span class="n">mod_name</span><span class="p">,</span> <span class="n">mod_var</span><span class="p">)</span>

<div class="viewcode-block" id="TrendsEvaluation.get_web_overview_table"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.get_web_overview_table">[docs]</a>    <span class="k">def</span> <span class="nf">get_web_overview_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes overview table based on existing map files</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Ignores map files that belong to runs which are not specified in this</span>
<span class="sd">        configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;obs_name&#39;</span> <span class="p">,</span> <span class="s1">&#39;obs_id&#39;</span><span class="p">,</span> <span class="s1">&#39;obs_var&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;vert&#39;</span><span class="p">,</span> <span class="s1">&#39;mod_name&#39;</span><span class="p">,</span> <span class="s1">&#39;mod_id&#39;</span><span class="p">,</span> <span class="s1">&#39;mod_var&#39;</span><span class="p">,</span> <span class="s1">&#39;mod_type&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;periods&#39;</span><span class="p">]</span>
        <span class="n">periods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_periods_from_map_files</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_map_files</span><span class="p">:</span>
            <span class="p">(</span><span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span>
             <span class="n">vert_code</span><span class="p">,</span>
             <span class="n">mod_name</span><span class="p">,</span> <span class="n">mod_var</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_from_json</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">obs_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="p">[</span><span class="n">obs_name</span><span class="p">][</span><span class="s1">&#39;obs_id&#39;</span><span class="p">]</span>

            <span class="n">mod_id</span><span class="p">,</span> <span class="n">mod_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">mod_name</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">mod_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="p">[</span><span class="n">mod_name</span><span class="p">][</span><span class="s1">&#39;model_id&#39;</span><span class="p">]</span>
                <span class="n">mod_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="p">[</span><span class="n">mod_name</span><span class="p">][</span><span class="s1">&#39;mtype&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mod_var</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1">#os.path.exists(t.out_dirs[&#39;map&#39;] + &#39;/&#39; + t.all_map_files[0])</span>
            <span class="n">tab</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_id</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">vert_code</span><span class="p">,</span>
                        <span class="n">mod_name</span><span class="p">,</span> <span class="n">mod_id</span><span class="p">,</span> <span class="n">mod_var</span><span class="p">,</span> <span class="n">mod_type</span><span class="p">,</span> <span class="n">periods</span><span class="p">[</span><span class="n">f</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">header</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrendsEvaluation.delete_outdated_json_files"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.delete_outdated_json_files">[docs]</a>    <span class="k">def</span> <span class="nf">delete_outdated_json_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all json files that are not part of this configuration&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_map_files</span><span class="p">:</span>
            <span class="p">(</span><span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span>
             <span class="n">vert_code</span><span class="p">,</span>
             <span class="n">mod_name</span><span class="p">,</span> <span class="n">mod_var</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_from_json</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="p">:</span>
                <span class="n">ts_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/OBS-</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_MOD-</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">*.json&#39;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dirs</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span>
                                             <span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">vert_code</span><span class="p">,</span>
                                             <span class="n">mod_name</span><span class="p">,</span> <span class="n">mod_var</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;REMOVING </span><span class="si">{}</span><span class="s1"> files in ts directory for </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)&#39;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts_files</span><span class="p">),</span> <span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">ts_files</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;REMOVING map file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dirs</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">],</span> <span class="n">f</span><span class="p">))</span></div>

<div class="viewcode-block" id="TrendsEvaluation.get_periods_from_map_files"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.get_periods_from_map_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_periods_from_map_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get data periods covered for each of the map files</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            keys are filenames of map files, values are list of periods</span>
<span class="sd">            covered</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_map_files</span><span class="p">:</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dirs</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">],</span> <span class="n">fname</span><span class="p">)</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;all&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="c1"># =============================================================================</span>
<span class="c1">#             with open(os.path.join(self.out_dirs[&#39;map&#39;], fname), &#39;r&#39;) as fp:</span>
<span class="c1">#                 current = simplejson.load(fp)</span>
<span class="c1">#                 res[fname] = list(current[0][&#39;all&#39;].keys())</span>
<span class="c1"># =============================================================================</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="TrendsEvaluation.get_obsvar_name_and_type"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.get_obsvar_name_and_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_obsvar_name_and_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get menu name and type of observation variable</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs_var : str</span>
<span class="sd">            Name of observation variable</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            menu name of this variable</span>
<span class="sd">        str</span>
<span class="sd">            menu category of this variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_mapping</span><span class="p">[</span><span class="n">obs_var</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">cat</span> <span class="o">=</span> <span class="n">obs_var</span><span class="p">,</span> <span class="s1">&#39;UNDEFINED&#39;</span><span class="p">,</span> <span class="s1">&#39;UNDEFINED&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Missing menu name definition for var </span><span class="si">{}</span><span class="s1">. &#39;</span>
                              <span class="s1">&#39;Using variable name&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_var</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">cat</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrendsEvaluation.clear_existing"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.clear_existing">[docs]</a>    <span class="k">def</span> <span class="nf">clear_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete existing json files for a certain run</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Clearing old files is recommended before a new run is started</span>
<span class="sd">        for this ID.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs_name : str</span>
<span class="sd">            name of observation (key of :attr:`obs_config`)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dirs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">obs_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_init_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initiate regions to assign lat / lon coordinates&quot;&quot;&quot;</span>
        <span class="n">regs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">reg_id</span><span class="p">,</span> <span class="n">reg_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_REGIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">regs</span><span class="p">[</span><span class="n">reg_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">reg_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reg_name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_regions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">regs</span><span class="p">[</span><span class="n">reg_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">reg_name</span><span class="p">,</span>
                                        <span class="n">lat_range</span><span class="o">=</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;lat_range&#39;</span><span class="p">],</span>
                                        <span class="n">lon_range</span><span class="o">=</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;lon_range&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed to add region </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span>
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_name</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="n">regs</span>

    <span class="k">def</span> <span class="nf">_init_dirs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_basedir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check and create directories&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">out_basedir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_basedir</span> <span class="o">=</span> <span class="n">out_basedir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_basedir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_basedir</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">OUTPUTDIR</span>
        <span class="n">check_dirs_exist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_basedir</span><span class="p">)</span>
        <span class="n">outdirs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUT_DIR_NAMES</span><span class="p">:</span>
            <span class="n">outdirs</span><span class="p">[</span><span class="n">dname</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_basedir</span><span class="p">,</span> <span class="n">dname</span><span class="p">)</span>
        <span class="n">check_dirs_exist</span><span class="p">(</span><span class="o">**</span><span class="n">outdirs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_dirs</span> <span class="o">=</span> <span class="n">outdirs</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">OUTPUTDIR</span><span class="p">,</span> <span class="s1">&#39;logfiles&#39;</span><span class="p">)</span>
        <span class="n">check_dirs_exist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_output_dirs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_output_dirs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if relevant output directories for json files exist&quot;&quot;&quot;</span>
        <span class="n">dirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dirs</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Directory does not exist: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="s1">&#39;Cannot write to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_obs_config_asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">as_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">as_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">as_dict</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">_model_config_asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">as_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">as_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">as_dict</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">_set_obsconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObsConfigEval</span><span class="p">(</span><span class="o">**</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_config</span> <span class="o">=</span> <span class="n">cfg</span>

    <span class="k">def</span> <span class="nf">_set_modelconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;mtype&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Need key &quot;mtype&quot; in specfication of model </span><span class="si">{}</span><span class="s1">&#39;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ModelConfigEval</span><span class="p">(</span><span class="o">**</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="o">=</span> <span class="n">cfg</span>

    <span class="k">def</span> <span class="nf">_save_map_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_data</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">vert_which</span><span class="p">,</span>
                       <span class="n">mod_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mod_var</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">map_outname</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;OBS-</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_MOD-</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_name</span><span class="p">,</span>
                                                            <span class="n">obs_var</span><span class="p">,</span>
                                                            <span class="n">vert_which</span><span class="p">,</span>
                                                            <span class="n">mod_name</span><span class="p">,</span>
                                                            <span class="n">mod_var</span><span class="p">))</span>

        <span class="n">outfile_map</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dirs</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">],</span> <span class="n">map_outname</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile_map</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">simplejson</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">map_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ignore_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">map_outname</span>

    <span class="k">def</span> <span class="nf">_save_stat_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trends_stat</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">,</span> <span class="n">vert_which</span><span class="p">,</span>
                        <span class="n">mod_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mod_var</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save station json file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        trends_stat</span>

<span class="sd">        var_name</span>

<span class="sd">        network_id</span>

<span class="sd">        vert_which</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">station_name</span> <span class="o">=</span> <span class="n">trends_stat</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;OBS-</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_MOD-</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_name</span><span class="p">,</span>
                                                            <span class="n">obs_var</span><span class="p">,</span>
                                                            <span class="n">vert_which</span><span class="p">,</span>
                                                            <span class="n">mod_name</span><span class="p">,</span>
                                                            <span class="n">mod_var</span><span class="p">,</span>
                                                            <span class="n">station_name</span><span class="p">))</span>

        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dirs</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">trends_stat</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">double_precision</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;FATAL: could not save station time-series trends &#39;</span>
                             <span class="s1">&#39;data to json. Reason: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">_remove_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">min_max</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove outliers from StationData objects</span>

<span class="sd">        NOTE</span>
<span class="sd">        ----</span>
<span class="sd">        This method is deprecated since 26.6.2019, since outlier removal is now</span>
<span class="sd">        done already in UngriddedData object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">raw</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">len0</span> <span class="o">=</span>  <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">notnan</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">notnan</span><span class="p">]</span>

        <span class="n">notok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">vals</span><span class="o">&lt;</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="o">&gt;</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#notok = ~((vals &gt; min_max[0]) &amp; (vals &lt; min_max[1]))</span>
        <span class="n">vals_invalid</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">notok</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals_invalid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stat</span>

        <span class="k">if</span> <span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dtime</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals_invalid</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">,</span><span class="si">{:.3f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span>
                                                        <span class="n">stat</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span>
                                                        <span class="n">var_name</span><span class="p">,</span>
                                                        <span class="n">dtime</span><span class="p">,</span>
                                                        <span class="n">val</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">stat</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">vals_invalid</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="n">var_name</span><span class="p">])</span> <span class="o">==</span> <span class="n">len0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Length mismatch of input and output arrays, developers, please check&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="n">var_name</span><span class="p">])):</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;No valid data remains after removing outliers&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stat</span>

    <span class="k">def</span> <span class="nf">_station_to_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="o">**</span><span class="n">alt_range</span><span class="p">):</span>
        <span class="c1"># load additional information about data source (if applicable)</span>
        <span class="n">station</span><span class="o">.</span><span class="n">load_dataset_info</span><span class="p">()</span>
        <span class="n">keymap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEYMAP</span>
        <span class="n">vardata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vardata</span><span class="p">[</span><span class="s1">&#39;data_revision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">data_revision</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">vardata</span><span class="p">[</span><span class="s1">&#39;data_revision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">vardata</span><span class="p">[</span><span class="s1">&#39;pyaerocom_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__version__</span>
        <span class="n">vardata</span><span class="p">[</span><span class="s1">&#39;data_overlap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">vardata</span><span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_name</span>

        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">station</span><span class="o">.</span><span class="n">overlap</span><span class="p">:</span>
            <span class="n">vardata</span><span class="p">[</span><span class="s1">&#39;data_overlap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">station</span><span class="p">[</span><span class="s1">&#39;var_info&#39;</span><span class="p">]:</span>
            <span class="n">var_info</span> <span class="o">=</span>  <span class="n">station</span><span class="p">[</span><span class="s1">&#39;var_info&#39;</span><span class="p">][</span><span class="n">var_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">keymap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">,</span> <span class="s1">&#39;data_overlap&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vardata</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Key </span><span class="si">{}</span><span class="s1"> already exists... please debug...&#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span> <span class="c1"># longitude, latitude and altitude are @property decorators in StationData</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">station</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">var_info</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">var_info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">])</span>
            <span class="n">vardata</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="c1"># this is necessary, as e.g. altitude attribute of input station data</span>
        <span class="c1"># is not necessarily the station coordinate!</span>
        <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">cval</span> <span class="ow">in</span> <span class="n">station</span><span class="o">.</span><span class="n">get_station_coords</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isnumeric</span><span class="p">(</span><span class="n">cval</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>

            <span class="n">vardata</span><span class="p">[</span><span class="n">keymap</span><span class="p">[</span><span class="n">cname</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">cval</span><span class="p">)</span>
        <span class="c1"># the actual sampling frequency</span>
        <span class="n">tst</span> <span class="o">=</span> <span class="n">vardata</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">TsType</span><span class="p">(</span><span class="n">tst</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">TemporalResolutionError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TemporalResolutionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Skipping processing of </span><span class="si">{</span><span class="n">station</span><span class="o">.</span><span class="n">station_name</span><span class="si">}</span><span class="s1"> trend for var &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s1"> since temporal resolution </span><span class="si">{</span><span class="n">tst</span><span class="si">}</span><span class="s1"> is invalid&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vardata</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wvl</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> nm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VARS</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">wavelength_nm</span><span class="p">)</span>
                <span class="n">vardata</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wvl</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">tst</span><span class="o">==</span><span class="s1">&#39;native&#39;</span> <span class="ow">or</span> <span class="n">freq</span><span class="o">&gt;=</span><span class="n">TsType</span><span class="p">(</span><span class="s1">&#39;daily&#39;</span><span class="p">):</span>
            <span class="n">to_freq</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span>
            <span class="n">freq_name</span> <span class="o">=</span> <span class="s1">&#39;dobs&#39;</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="o">&gt;=</span> <span class="n">TsType</span><span class="p">(</span><span class="s1">&#39;monthly&#39;</span><span class="p">):</span>
            <span class="n">to_freq</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>
            <span class="n">freq_name</span> <span class="o">=</span> <span class="s1">&#39;mobs&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TemporalResolutionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Skipping processing of </span><span class="si">{</span><span class="n">station</span><span class="o">.</span><span class="n">station_name</span><span class="si">}</span><span class="s1"> since temporal &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;resolution </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1"> is too low (need at least monthly)&#39;</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">to_timeseries</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">to_freq</span><span class="p">,</span>
                                  <span class="n">resample_how</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">avg_how</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">alt_range</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;Failed to retrieve timeseries&#39;</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">values</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

        <span class="n">jsdate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_jsdate</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">od</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">dates</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
               <span class="n">month</span><span class="o">=</span><span class="n">dates</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
               <span class="n">day</span><span class="o">=</span><span class="n">dates</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
               <span class="n">value</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
               <span class="n">date</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
               <span class="n">jsdate</span><span class="o">=</span><span class="n">jsdate</span><span class="p">)</span>

        <span class="n">vardata</span><span class="p">[</span><span class="n">freq_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vardata</span>

    <span class="k">def</span> <span class="nf">_daily2monthly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily</span><span class="p">,</span> <span class="n">min_dim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper to convert daily to monthly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Group data first by year, then by month</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">daily</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">])</span>
        <span class="c1"># For each group, calculate the average of value</span>
        <span class="n">_m</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">aggregate</span><span class="p">({</span><span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">})</span>
        <span class="n">numdays</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

        <span class="c1"># NOTE: BEFORE 16.5.19</span>
        <span class="c1">#invalid_mask = numdays &lt;= min_dim</span>
        <span class="c1"># NOTE: AFTER 16.5.19</span>
        <span class="n">invalid_mask</span> <span class="o">=</span> <span class="n">numdays</span> <span class="o">&lt;</span> <span class="n">min_dim</span>
        <span class="n">_m</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">invalid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1">#js date</span>
        <span class="n">_m</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">_m</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;Derived monthly averages do not contain &#39;</span>
                                    <span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="c1"># Todo: check this, this seems cumbersome</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">_m</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]),</span>
                                                       <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]),</span>
                                                       <span class="mi">15</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">monthly</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">_m</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dates</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="c1">#.resample(&#39;MS&#39;).mean()</span>
        <span class="n">monthly</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;MS&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">monthly</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span>

        <span class="n">dates</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">index</span>
        <span class="n">jsdate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_jsdate</span><span class="p">(</span><span class="n">monthly</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">od</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">dates</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                               <span class="n">month</span><span class="o">=</span><span class="n">dates</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                               <span class="n">day</span><span class="o">=</span><span class="n">dates</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                               <span class="n">value</span><span class="o">=</span><span class="n">monthly</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                               <span class="n">date</span><span class="o">=</span><span class="n">dates</span><span class="p">,</span>
                               <span class="n">jsdate</span><span class="o">=</span><span class="n">jsdate</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_frequency_and_prep_mobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">min_dim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check frequency in data and if higher than monthly, create and append monthly</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : dict</span>
<span class="sd">            return value from :func:`_station_to_timeseries`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            2-element tuple, containing</span>

<span class="sd">            - str, granularity (daily, monthly)</span>
<span class="sd">            - DataFrame, containing monthly results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;dobs&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">granulo</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span>

            <span class="c1">#monthly avg</span>
            <span class="c1">#drop na values</span>
            <span class="c1"># FOLLOWING LINE COMMENTED OUT BY JGLISS (17.12.2018)</span>
            <span class="n">daily</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dobs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">daily</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: Derived daily averages do not contain &#39;</span>
                                        <span class="s1">&#39;data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]))</span>

            <span class="n">mobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_daily2monthly</span><span class="p">(</span><span class="n">daily</span><span class="p">,</span> <span class="n">min_dim</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mobs</span>

        <span class="k">elif</span> <span class="s1">&#39;mobs&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">granulo</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>
            <span class="n">mobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mobs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unexpected Error. Data should either contain daily &#39;</span>
                            <span class="s1">&#39;or monthly averages, please check function &#39;</span>
                            <span class="s1">&#39;_station_to_timeseries and debug&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">granulo</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_to_jsdate</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert datetime vector to jsdate vector&quot;&quot;&quot;</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s1">&#39;1970-01-01&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">dates</span> <span class="o">-</span> <span class="n">epoch</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;timedelta64[ms]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_init_trends_result_dict</span><span class="p">(</span><span class="n">start_yr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_init_trends_result_dict</span><span class="p">(</span><span class="n">start_yr</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_compute_trend_error</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">m_err</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v0_err</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes error of trend estimate using gaussian error propagation</span>

<span class="sd">        The (normalised) trend is computed as T = m / v0</span>

<span class="sd">        where m denotes the slope of a regression line and v0 denotes the</span>
<span class="sd">        normalistation value. This method computes the uncertainty of T (delta_T)</span>
<span class="sd">        using gaussian error propagation of uncertainties accompanying m and v0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        m : float</span>
<span class="sd">            slope in units of &lt;U&gt; yr-1 (where &lt;U&gt; denotes the unit of the data).</span>
<span class="sd">            (m -&gt; &quot;montant&quot;).</span>
<span class="sd">        m_err : float</span>
<span class="sd">            slope error (same unit as `m`)</span>
<span class="sd">        v0 : float</span>
<span class="sd">            normalisation value in units of &lt;U&gt;</span>
<span class="sd">        v0_err : float</span>
<span class="sd">            error of `v0` (same units as `v0`)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            error of T in computed using gaussian error propagation of trend</span>
<span class="sd">            formula in units of %/yr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_compute_trend_error</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">m_err</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v0_err</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_compute_trend_error_alt</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">residual_magnitude</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alternative way to compute error of trend estimate</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        m : float</span>
<span class="sd">            slope in units of &lt;U&gt; yr-1 (where &lt;U&gt; denotes the unit of the data).</span>
<span class="sd">            (m -&gt; &quot;montant&quot;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            error of T computed using gaussian error propagation of trend formula</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vlast</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">v0_low</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">-</span> <span class="n">residual_magnitude</span>
        <span class="n">v0_high</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">+</span> <span class="n">residual_magnitude</span>

        <span class="n">vlast_low</span> <span class="o">=</span> <span class="n">vlast</span> <span class="o">-</span> <span class="n">residual_magnitude</span>
        <span class="n">vlast_high</span> <span class="o">=</span> <span class="n">vlast</span> <span class="o">+</span> <span class="n">residual_magnitude</span>

        <span class="n">T1</span> <span class="o">=</span> <span class="p">(</span><span class="n">vlast_low</span> <span class="o">-</span> <span class="n">v0_high</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">v0_high</span><span class="p">)</span> <span class="o">*</span><span class="mi">100</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="p">(</span><span class="n">vlast_high</span> <span class="o">-</span> <span class="n">v0_low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">v0_low</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_trends_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">seasons</span><span class="p">):</span>
        <span class="c1">#trends with yearly and seasonal averages</span>
         <span class="c1">#add season to monthly data</span>
        <span class="n">mobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mobs&#39;</span><span class="p">]</span>

        <span class="n">mobs</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mobs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">_get_season</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span>
                                                            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]),</span>
                                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">mobs</span> <span class="o">=</span> <span class="n">mobs</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
        <span class="c1"># FOLLOWING LINE COMMENTED OUT BY JGLISS (17.12.2018)</span>
        <span class="c1">#data[&#39;dobs&#39;].dropna(subset=[&#39;value&#39;],inplace=True)</span>
        <span class="c1"># Group data first by year, then by month</span>

        <span class="n">yrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mobs</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">seas</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seasons</span><span class="p">):</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1">#initialize seasonal object</span>
            <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;date&#39;</span>    <span class="p">:</span> <span class="p">[],</span>
                          <span class="s1">&#39;jsdate&#39;</span>  <span class="p">:</span> <span class="p">[],</span>
                          <span class="s1">&#39;val&#39;</span>     <span class="p">:</span> <span class="p">[],</span>
                          <span class="s1">&#39;trends&#39;</span>  <span class="p">:</span> <span class="p">{}}</span>
            <span class="c1">#filter the months</span>
            <span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="n">yrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">seas</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span> <span class="c1">#yearly trends</span>
                    <span class="n">catch</span> <span class="o">=</span> <span class="n">mobs</span><span class="p">[</span><span class="n">mobs</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">yr</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">catch</span> <span class="o">=</span> <span class="n">mobs</span><span class="p">[</span><span class="n">mobs</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seas</span><span class="p">,</span> <span class="n">yr</span><span class="p">))]</span>

                <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_mid_season</span><span class="p">(</span><span class="n">seas</span><span class="p">,</span> <span class="n">yr</span><span class="p">))</span>

                <span class="c1">#needs 4 seasons to compute seasonal average to avoid biases</span>
                <span class="k">if</span> <span class="n">seas</span><span class="o">==</span><span class="s1">&#39;all&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">catch</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">catch</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
            <span class="c1"># assign dates and jsdates vector to data dict</span>
            <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;jsdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_jsdate</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;jsdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([])</span>

            <span class="c1">#filter period</span>
            <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
                <span class="c1"># init dictionary that will contain trends results for this period</span>
                <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;trends&#39;</span><span class="p">][</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># desired start / stop year (note, that this may change if first</span>
                <span class="c1"># or last value in tseries (or both) is NaN)</span>
                <span class="n">start_yr</span><span class="p">,</span> <span class="n">stop_yr</span> <span class="o">=</span> <span class="n">_years_from_periodstr</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>

                <span class="n">start_date</span> <span class="o">=</span> <span class="n">_mid_season</span><span class="p">(</span><span class="n">seas</span><span class="p">,</span> <span class="n">start_yr</span><span class="p">)</span>
                <span class="n">stop_date</span> <span class="o">=</span> <span class="n">_mid_season</span><span class="p">(</span><span class="n">seas</span><span class="p">,</span> <span class="n">stop_yr</span><span class="p">)</span>

                <span class="n">period_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
                                             <span class="n">end</span><span class="o">=</span><span class="n">stop_date</span><span class="p">,</span>
                                             <span class="n">freq</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

                <span class="n">num_dates_period</span> <span class="o">=</span> <span class="n">period_index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[Y]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

                <span class="c1">#filtering to the period limit</span>
                <span class="n">jsp0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_jsdate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-01-01&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_yr</span><span class="p">)))</span>
                <span class="n">jsp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_jsdate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-12-31&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stop_yr</span><span class="p">)))</span>

                <span class="c1"># vector containing numerical timestamps in javascript format</span>
                <span class="n">jsdate</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;jsdate&#39;</span><span class="p">]</span>
                <span class="n">dates</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>

                <span class="c1"># get period filter mask</span>
                <span class="n">tmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">jsdate</span><span class="o">&gt;=</span><span class="n">jsp0</span><span class="p">,</span> <span class="n">jsdate</span><span class="o">&lt;=</span><span class="n">jsp1</span><span class="p">)</span>

                <span class="c1"># apply period mask to jsdate vector and value vector</span>
                <span class="n">jsdate_data</span> <span class="o">=</span> <span class="n">jsdate</span><span class="p">[</span><span class="n">tmask</span><span class="p">]</span>
                <span class="n">dates_data</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="n">tmask</span><span class="p">]</span>

                <span class="c1"># vector containing data values</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">])[</span><span class="n">tmask</span><span class="p">]</span>

                <span class="n">valid</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

                <span class="c1">#works only on not nan values</span>
                <span class="n">jsdate_data</span> <span class="o">=</span> <span class="n">jsdate_data</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">dates_data</span> <span class="o">=</span> <span class="n">dates_data</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>

                <span class="n">num_dates_data</span> <span class="o">=</span> <span class="n">dates_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[Y]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

                <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>

                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_trends_result_dict</span><span class="p">(</span><span class="n">start_yr</span><span class="p">)</span>

                <span class="c1">#TODO: len(y) is number of years - 1 due to midseason averages</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;y_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;y_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;y_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

                    <span class="c1">#Mann / Kendall test</span>
                    <span class="p">[</span><span class="n">tau</span><span class="p">,</span> <span class="n">pval</span><span class="p">]</span> <span class="o">=</span> <span class="n">kendalltau</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">num_dates_data</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">vals</span><span class="p">)</span>

                    <span class="p">(</span><span class="n">slope</span><span class="p">,</span>
                     <span class="n">yoffs</span><span class="p">,</span>
                     <span class="n">slope_low</span><span class="p">,</span>
                     <span class="n">slope_up</span><span class="p">)</span> <span class="o">=</span> <span class="n">theilslopes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">vals</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">num_dates_data</span><span class="p">,</span>
                                             <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slope_alpha</span><span class="p">)</span>

                    <span class="c1"># estimate error of slope at input confidence level</span>
                    <span class="n">slope_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">slope</span> <span class="o">-</span> <span class="n">slope_low</span><span class="p">),</span>
                                         <span class="nb">abs</span><span class="p">(</span><span class="n">slope</span> <span class="o">-</span> <span class="n">slope_up</span><span class="p">)])</span>

                    <span class="n">reg_data</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">num_dates_data</span> <span class="o">+</span> <span class="n">yoffs</span>
                    <span class="n">reg_period</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">num_dates_period</span>  <span class="o">+</span> <span class="n">yoffs</span>

                    <span class="c1"># value used for normalisation of slope to compute trend T</span>
                    <span class="c1"># T=m / v0</span>
                    <span class="n">v0_data</span> <span class="o">=</span> <span class="n">reg_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">v0_period</span> <span class="o">=</span> <span class="n">reg_period</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Compute the mean residual value, which is used to estimate</span>
                    <span class="c1"># the uncertainty in the normalisation value used to compute</span>
                    <span class="c1"># trend</span>
                    <span class="n">mean_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vals</span> <span class="o">-</span> <span class="n">reg_data</span><span class="p">))</span>

                    <span class="c1"># trend is slope normalised by first reference value.</span>
                    <span class="c1"># 2 trends are computed, 1. the trend using the first value of</span>
                    <span class="c1"># the regression line at the first available data year, 2. the</span>
                    <span class="c1"># trend corresponding to the value corresponding to the first</span>
                    <span class="c1"># year of the considered period.</span>

                    <span class="n">trend_data</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">/</span> <span class="n">v0_data</span> <span class="o">*</span> <span class="mi">100</span>
                    <span class="n">trend_period</span> <span class="o">=</span>  <span class="n">slope</span> <span class="o">/</span> <span class="n">v0_period</span> <span class="o">*</span> <span class="mi">100</span>

                    <span class="c1"># Compute errors of normalisation values</span>
                    <span class="n">v0_err_data</span> <span class="o">=</span> <span class="n">mean_residual</span>
                    <span class="n">t0_data</span><span class="p">,</span> <span class="n">tN_data</span> <span class="o">=</span> <span class="n">num_dates_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num_dates_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">t0_period</span> <span class="o">=</span> <span class="n">num_dates_period</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># sanity check</span>
                    <span class="k">assert</span> <span class="n">t0_data</span> <span class="o">&lt;</span> <span class="n">tN_data</span>
                    <span class="k">assert</span> <span class="n">t0_period</span> <span class="o">&lt;=</span> <span class="n">t0_data</span>

                    <span class="n">dt_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">t0_data</span> <span class="o">-</span> <span class="n">t0_period</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tN_data</span> <span class="o">-</span> <span class="n">t0_data</span><span class="p">)</span>

                    <span class="n">v0_err_period</span> <span class="o">=</span> <span class="n">v0_err_data</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dt_ratio</span><span class="p">)</span>

                    <span class="n">trend_data_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_trend_error</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">slope</span><span class="p">,</span>
                                                               <span class="n">m_err</span><span class="o">=</span><span class="n">slope_err</span><span class="p">,</span>
                                                               <span class="n">v0</span><span class="o">=</span><span class="n">v0_data</span><span class="p">,</span>
                                                               <span class="n">v0_err</span><span class="o">=</span><span class="n">v0_err_data</span><span class="p">)</span>

                    <span class="n">trend_period_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_trend_error</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">slope</span><span class="p">,</span>
                                                                 <span class="n">m_err</span><span class="o">=</span><span class="n">slope_err</span><span class="p">,</span>
                                                                 <span class="n">v0</span><span class="o">=</span><span class="n">v0_period</span><span class="p">,</span>
                                                                 <span class="n">v0_err</span><span class="o">=</span><span class="n">v0_err_period</span><span class="p">)</span>

                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;pval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pval</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slope</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;m_err&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">slope_err</span>

                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;slp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trend_data</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;slp_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trend_data_err</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;reg0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v0_data</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsdate_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">v0_period</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;slp_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_yr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">trend_period</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;slp_</span><span class="si">{}</span><span class="s1">_err&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_yr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">trend_period_err</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;reg0_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_yr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v0_period</span>

                <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;trends&#39;</span><span class="p">][</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_compute_trends_station</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">min_dim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute trends for station</span>

<span class="sd">        Slightly modified code from original trends interface developed by</span>
<span class="sd">        A. Mortier.</span>

<span class="sd">        Main changes applied:</span>

<span class="sd">            - Keep NaNs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">granulo</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_frequency_and_prep_mobs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">min_dim</span><span class="p">)</span>

        <span class="n">seasons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SEASONS</span>
        <span class="c1"># get monthly values for display in interface (&#39;mobs&#39; is modified in</span>
        <span class="c1"># _compute_trends_helper, e.g. NaNs are removed from it)</span>
        <span class="n">jsdate</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mobs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">jsdate</span><span class="o">.</span><span class="n">values</span>
        <span class="n">monthly_vals</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mobs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_trends_helper</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">periods</span><span class="p">,</span> <span class="n">seasons</span><span class="p">)</span>

        <span class="c1">#creates dictionary</span>
        <span class="n">trends_stat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;daily&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;monthly&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;season&#39;</span><span class="p">:</span> <span class="p">{}}</span>

        <span class="n">trends_stat</span><span class="p">[</span><span class="s1">&#39;data_revision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data_revision&#39;</span><span class="p">]</span>
        <span class="n">trends_stat</span><span class="p">[</span><span class="s1">&#39;pyaerocom_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pyaerocom_version&#39;</span><span class="p">]</span>
        <span class="n">metakeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEYMAP</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">metakey</span> <span class="ow">in</span> <span class="n">metakeys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metakey</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">trends_stat</span><span class="p">[</span><span class="n">metakey</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">metakey</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">granulo</span><span class="o">==</span><span class="s1">&#39;daily&#39;</span><span class="p">:</span>
            <span class="n">trends_stat</span><span class="p">[</span><span class="s1">&#39;daily&#39;</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dobs&#39;</span><span class="p">][</span><span class="s1">&#39;jsdate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">trends_stat</span><span class="p">[</span><span class="s1">&#39;daily&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dobs&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">elif</span> <span class="n">granulo</span><span class="o">==</span><span class="s1">&#39;monthly&#39;</span><span class="p">:</span>
            <span class="n">trends_stat</span><span class="p">[</span><span class="s1">&#39;daily&#39;</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">trends_stat</span><span class="p">[</span><span class="s1">&#39;daily&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[]</span>

        <span class="n">trends_stat</span><span class="p">[</span><span class="s1">&#39;monthly&#39;</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsdate</span>
        <span class="n">trends_stat</span><span class="p">[</span><span class="s1">&#39;monthly&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">monthly_vals</span>
        <span class="k">for</span> <span class="n">seas</span> <span class="ow">in</span> <span class="n">seasons</span><span class="p">:</span>
            <span class="n">trends_stat</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">][</span><span class="n">seas</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;date&#39;</span>  <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;jsdate&#39;</span><span class="p">],</span>
                                           <span class="s1">&#39;val&#39;</span>   <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                                           <span class="s1">&#39;trends&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;trends&#39;</span><span class="p">]}</span>

        <span class="n">reg</span> <span class="o">=</span> <span class="n">_find_area</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span>
                         <span class="n">regions_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_REGIONS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reg</span> <span class="o">==</span> <span class="s1">&#39;WORLD&#39;</span><span class="p">:</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># station information for map view</span>
        <span class="n">map_stat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;site&#39;</span>      <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;lat&#39;</span>       <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;lon&#39;</span>       <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;alt&#39;</span>       <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;alt&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;region&#39;</span>    <span class="p">:</span> <span class="n">reg</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">seas</span> <span class="ow">in</span> <span class="n">seasons</span><span class="p">:</span>
            <span class="n">map_stat</span><span class="p">[</span><span class="n">seas</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">seas</span><span class="p">][</span><span class="s1">&#39;trends&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">trends_stat</span><span class="p">,</span> <span class="n">map_stat</span>

    <span class="k">def</span> <span class="nf">_init_logfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
        <span class="n">nowstr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">outlier_log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="p">,</span>
                                        <span class="s1">&#39;Run_</span><span class="si">{}</span><span class="s1">_outliers_</span><span class="si">{}</span><span class="s1">.log&#39;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_name</span><span class="p">,</span> <span class="n">nowstr</span><span class="p">),</span> <span class="s1">&#39;w+&#39;</span><span class="p">))</span>
        <span class="n">err_log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="p">,</span>
                                        <span class="s1">&#39;Run_</span><span class="si">{}</span><span class="s1">_errors_</span><span class="si">{}</span><span class="s1">.log&#39;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_name</span><span class="p">,</span> <span class="n">nowstr</span><span class="p">),</span> <span class="s1">&#39;w+&#39;</span><span class="p">))</span>
        <span class="n">files_log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="p">,</span>
                                        <span class="s1">&#39;Run_</span><span class="si">{}</span><span class="s1">_outfiles_</span><span class="si">{}</span><span class="s1">.log&#39;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_name</span><span class="p">,</span> <span class="n">nowstr</span><span class="p">),</span> <span class="s1">&#39;w+&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">outlier_log</span><span class="p">,</span> <span class="n">err_log</span><span class="p">,</span> <span class="n">files_log</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_single_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ungridded_data</span><span class="p">,</span> <span class="n">vars_to_retrieve</span><span class="p">,</span>
                       <span class="n">min_dim</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">vert_which</span><span class="p">,</span> <span class="n">files_created</span><span class="p">,</span>
                       <span class="n">err_log</span><span class="p">):</span>

        <span class="n">files_created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_single_helper</span><span class="p">(</span><span class="n">ungridded_data</span><span class="o">=</span><span class="n">ungridded_data</span><span class="p">,</span>
                                                <span class="n">vars_to_retrieve</span><span class="o">=</span><span class="n">vars_to_retrieve</span><span class="p">,</span>
                                                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                                <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">,</span>
                                                <span class="n">files_created</span><span class="o">=</span><span class="n">files_created</span><span class="p">,</span>
                                                <span class="n">min_dim</span><span class="o">=</span><span class="n">min_dim</span><span class="p">,</span>
                                                <span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="p">,</span>
                                                <span class="n">err_log</span><span class="o">=</span><span class="n">err_log</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">files_created</span>

    <span class="k">def</span> <span class="nf">_run_single_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ungridded_data</span><span class="p">,</span> <span class="n">vars_to_retrieve</span><span class="p">,</span>
                       <span class="n">min_dim</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">files_created</span><span class="p">,</span> <span class="n">err_log</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">models</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Cannot yet colocate 3D observations &#39;</span>
                                      <span class="s1">&#39;with model data ...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">add_name</span><span class="p">,</span> <span class="n">alt_range</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">VERT_LAYERS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">files_created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_single_helper</span><span class="p">(</span><span class="n">ungridded_data</span><span class="o">=</span><span class="n">ungridded_data</span><span class="p">,</span>
                                                    <span class="n">vars_to_retrieve</span><span class="o">=</span><span class="n">vars_to_retrieve</span><span class="p">,</span>
                                                    <span class="n">min_dim</span><span class="o">=</span><span class="n">min_dim</span><span class="p">,</span>
                                                    <span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="p">,</span>
                                                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                                    <span class="n">vert_which</span><span class="o">=</span><span class="n">add_name</span><span class="p">,</span>
                                                    <span class="n">files_created</span><span class="o">=</span><span class="n">files_created</span><span class="p">,</span>
                                                    <span class="n">err_log</span><span class="o">=</span><span class="n">err_log</span><span class="p">,</span>
                                                    <span class="n">altitude</span><span class="o">=</span><span class="n">alt_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">files_created</span>

    <span class="k">def</span> <span class="nf">_run_single_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ungridded_data</span><span class="p">,</span> <span class="n">vars_to_retrieve</span><span class="p">,</span>
                           <span class="n">name</span><span class="p">,</span> <span class="n">vert_which</span><span class="p">,</span> <span class="n">files_created</span><span class="p">,</span> <span class="n">min_dim</span><span class="p">,</span>
                           <span class="n">models</span><span class="p">,</span> <span class="n">err_log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">alt_range</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pyaerocom.exceptions</span> <span class="kn">import</span> <span class="n">DataCoverageError</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vars_to_retrieve</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">vars_to_retrieve</span> <span class="o">=</span> <span class="p">[</span><span class="n">vars_to_retrieve</span><span class="p">]</span>

        <span class="n">model_access</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">models</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">model_access</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_model_access</span><span class="p">(</span><span class="n">models</span><span class="p">,</span>
                                                   <span class="n">vars_to_retrieve</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_to_retrieve</span><span class="p">:</span>

            <span class="n">all_stats</span> <span class="o">=</span> <span class="n">ungridded_data</span><span class="o">.</span><span class="n">to_station_data_all</span><span class="p">(</span><span class="n">vars_to_convert</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                                                           <span class="n">by_station_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="n">all_stats</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">]</span>

            <span class="n">var_out</span> <span class="o">=</span> <span class="n">var</span>
            <span class="n">stats_processed</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">map_data</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">stats_ok</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lats_ok</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lons_ok</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">:</span>
                <span class="n">stat_name</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stat_name</span> <span class="ow">in</span> <span class="n">stats_processed</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unexpected Error, please check&#39;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_to_timeseries</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span>
                                                            <span class="n">var_name</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                                                            <span class="o">**</span><span class="n">alt_range</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">trends_stat</span><span class="p">,</span>
                     <span class="n">map_stat</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_trends_station</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span>
                                                              <span class="n">min_dim</span><span class="o">=</span><span class="n">min_dim</span><span class="p">)</span>

                    <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_stat_json</span><span class="p">(</span><span class="n">trends_stat</span><span class="p">,</span>
                                                 <span class="n">obs_var</span><span class="o">=</span><span class="n">var_out</span><span class="p">,</span>
                                                 <span class="n">obs_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                                 <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">)</span>
                    <span class="n">files_created</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

                    <span class="n">stats_ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stat_name</span><span class="p">)</span>
                    <span class="n">lats_ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">])</span>
                    <span class="n">lons_ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">map_stat</span><span class="p">:</span>
                        <span class="n">map_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">map_stat</span><span class="p">)</span>

                <span class="k">except</span> <span class="n">DataCoverageError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Error: </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">err_log</span><span class="p">:</span>
                        <span class="n">err_log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Add to map only if at least one station is available</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats_ok</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">map_outname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_map_json</span><span class="p">(</span><span class="n">map_data</span><span class="p">,</span> <span class="n">obs_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                                  <span class="n">obs_var</span><span class="o">=</span><span class="n">var_out</span><span class="p">,</span>
                                                  <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">)</span>
                <span class="n">files_created</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">map_outname</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">mod_name</span><span class="p">,</span> <span class="n">mod_info</span> <span class="ow">in</span> <span class="n">model_access</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">mod_info</span><span class="p">[</span><span class="s1">&#39;vars_avail&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="n">mod_var</span><span class="o">=</span><span class="n">mod_info</span><span class="p">[</span><span class="s1">&#39;vars_avail&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_gridded</span><span class="p">(</span><span class="n">obs_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">obs_var</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                                  <span class="n">mod_name</span><span class="o">=</span><span class="n">mod_name</span><span class="p">,</span> <span class="n">mod_var</span><span class="o">=</span><span class="n">mod_var</span><span class="p">,</span>
                                  <span class="n">stat_lats</span><span class="o">=</span><span class="n">lats_ok</span><span class="p">,</span>
                                  <span class="n">stat_lons</span><span class="o">=</span><span class="n">lons_ok</span><span class="p">,</span>
                                  <span class="n">stat_names</span><span class="o">=</span><span class="n">stats_ok</span><span class="p">,</span>
                                  <span class="n">min_dim</span><span class="o">=</span><span class="n">min_dim</span><span class="p">,</span>
                                  <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">,</span>
                                  <span class="n">files_created</span><span class="o">=</span><span class="n">files_created</span><span class="p">,</span>
                                  <span class="n">err_log</span><span class="o">=</span><span class="n">err_log</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">alt_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">files_created</span>

<div class="viewcode-block" id="TrendsEvaluation.freq_gridded"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.TrendsEvaluation.freq_gridded">[docs]</a>    <span class="k">def</span> <span class="nf">freq_gridded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Frequency used for any colocated gridded data&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GRIDDED_TS_TYPE</span></div>

    <span class="k">def</span> <span class="nf">_run_gridded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">mod_name</span><span class="p">,</span> <span class="n">mod_var</span><span class="p">,</span> <span class="n">stat_lats</span><span class="p">,</span>
                     <span class="n">stat_lons</span><span class="p">,</span> <span class="n">stat_names</span><span class="p">,</span> <span class="n">min_dim</span><span class="p">,</span> <span class="n">vert_which</span><span class="p">,</span> <span class="n">files_created</span><span class="p">,</span>
                     <span class="n">err_log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">alt_range</span><span class="p">):</span>
        <span class="n">mcfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span>
        <span class="n">data_id</span> <span class="o">=</span> <span class="n">mcfg</span><span class="p">[</span><span class="s1">&#39;model_id&#39;</span><span class="p">]</span>

        <span class="n">reader</span> <span class="o">=</span> <span class="n">ReadGridded</span><span class="p">(</span><span class="n">data_id</span><span class="o">=</span><span class="n">data_id</span><span class="p">)</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="n">mcfg</span><span class="p">[</span><span class="s1">&#39;model_ts_type_read&#39;</span><span class="p">]</span>

        <span class="n">read_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_gridded</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">read_freq</span> <span class="o">=</span> <span class="n">rf</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mod_var</span> <span class="ow">in</span> <span class="n">rf</span><span class="p">:</span>
                    <span class="n">read_freq</span> <span class="o">=</span> <span class="n">read_freq</span><span class="p">[</span><span class="n">mod_var</span><span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_var</span><span class="p">(</span><span class="n">mod_var</span><span class="p">,</span> <span class="n">ts_type</span><span class="o">=</span><span class="n">read_freq</span><span class="p">,</span>
                               <span class="n">ts_type_flex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">resample_time</span><span class="p">(</span><span class="n">to_ts_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_gridded</span><span class="p">())</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_time_series</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="n">stat_lons</span><span class="p">,</span>
                                       <span class="n">latitude</span><span class="o">=</span><span class="n">stat_lats</span><span class="p">,</span>
                                       <span class="n">add_meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">station_name</span> <span class="o">=</span> <span class="n">stat_names</span><span class="p">))</span>

        <span class="n">stats_processed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">map_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">got_one</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">:</span>
            <span class="n">stat_name</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">mod_var</span><span class="p">,</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">],</span> <span class="n">obs_name</span><span class="p">,</span> <span class="n">mod_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat_name</span> <span class="ow">in</span> <span class="n">stats_processed</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unexpected Error, please check&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="n">data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_to_timeseries</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span>
                                                        <span class="n">var_name</span><span class="o">=</span><span class="n">mod_var</span><span class="p">,</span>
                                                        <span class="o">**</span><span class="n">alt_range</span><span class="p">)</span>
                <span class="p">(</span><span class="n">trends_stat</span><span class="p">,</span>
                 <span class="n">map_stat</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_trends_station</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span>
                                                          <span class="n">min_dim</span><span class="o">=</span><span class="n">min_dim</span><span class="p">)</span>

                <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_stat_json</span><span class="p">(</span><span class="n">trends_stat</span><span class="p">,</span>
                                             <span class="n">obs_var</span><span class="o">=</span><span class="n">obs_var</span><span class="p">,</span>
                                             <span class="n">obs_name</span><span class="o">=</span><span class="n">obs_name</span><span class="p">,</span>
                                             <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">,</span>
                                             <span class="n">mod_name</span><span class="o">=</span><span class="n">mod_name</span><span class="p">,</span>
                                             <span class="n">mod_var</span><span class="o">=</span><span class="n">mod_var</span><span class="p">)</span>
                <span class="n">files_created</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">got_one</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">map_stat</span><span class="p">:</span>
                    <span class="n">map_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">map_stat</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">DataCoverageError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Error: </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mod_var</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span>
                                                 <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">err_log</span><span class="p">:</span>
                    <span class="n">err_log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Add to map only if at least one station is available</span>
        <span class="k">if</span> <span class="n">got_one</span><span class="p">:</span>
            <span class="n">map_outname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_map_json</span><span class="p">(</span><span class="n">map_data</span><span class="p">,</span>
                                              <span class="n">obs_name</span><span class="o">=</span><span class="n">obs_name</span><span class="p">,</span>
                                              <span class="n">obs_var</span><span class="o">=</span><span class="n">obs_var</span><span class="p">,</span>
                                              <span class="n">vert_which</span><span class="o">=</span><span class="n">vert_which</span><span class="p">,</span>
                                              <span class="n">mod_name</span><span class="o">=</span><span class="n">mod_name</span><span class="p">,</span>
                                              <span class="n">mod_var</span><span class="o">=</span><span class="n">mod_var</span><span class="p">)</span>
            <span class="n">files_created</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">map_outname</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">files_created</span></div>

<div class="viewcode-block" id="check_ebas_default"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.trends_evaluation.check_ebas_default">[docs]</a><span class="k">def</span> <span class="nf">check_ebas_default</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Make sure the EBAS default configuration has not changed&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pyaerocom.io</span> <span class="kn">import</span> <span class="n">ReadEbas</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ReadEbas</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">eval_flags</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">keep_aux_vars</span> <span class="o">==</span> <span class="kc">False</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">TrendsEvaluation</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, MET Norway

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>