

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyaerocom.web.helpers_evaluation_iface &mdash; pyaerocom  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> pyaerocom
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#aerocom">AeroCom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#citation">Citation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#website-and-code-documentation">Website and code documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#requirements">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#installation-of-pyaerocom">Installation of pyaerocom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#access-to-users-database">Access to users database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#getting-started">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyaerocom</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyaerocom.web.helpers_evaluation_iface</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyaerocom.web.helpers_evaluation_iface</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Mon Apr 15 14:00:44 2019</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">simplejson</span>
<span class="kn">from</span> <span class="nn">pyaerocom</span> <span class="kn">import</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">pyaerocom._lowlevel_helpers</span> <span class="kn">import</span> <span class="n">sort_dict_by_name</span>
<span class="kn">from</span> <span class="nn">pyaerocom.io.helpers</span> <span class="kn">import</span> <span class="n">save_dict_json</span>
<span class="kn">from</span> <span class="nn">pyaerocom.web.helpers</span> <span class="kn">import</span> <span class="n">read_json</span><span class="p">,</span> <span class="n">write_json</span>
<span class="kn">from</span> <span class="nn">pyaerocom.web.const</span> <span class="kn">import</span> <span class="p">(</span><span class="n">HEATMAP_FILENAME_EVAL_IFACE_MONTHLY</span><span class="p">,</span>
                                 <span class="n">HEATMAP_FILENAME_EVAL_IFACE_DAILY</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyaerocom.colocateddata</span> <span class="kn">import</span> <span class="n">ColocatedData</span>
<span class="kn">from</span> <span class="nn">pyaerocom.mathutils</span> <span class="kn">import</span> <span class="n">calc_statistics</span>
<span class="kn">from</span> <span class="nn">pyaerocom.tstype</span> <span class="kn">import</span> <span class="n">TsType</span>
<span class="kn">from</span> <span class="nn">pyaerocom.exceptions</span> <span class="kn">import</span> <span class="n">DataDimensionError</span><span class="p">,</span> <span class="n">TemporalResolutionError</span>
<span class="kn">from</span> <span class="nn">pyaerocom.region</span> <span class="kn">import</span> <span class="p">(</span><span class="n">get_all_default_region_ids</span><span class="p">,</span>
                              <span class="n">find_closest_region_coord</span><span class="p">,</span>
                              <span class="n">get_all_default_regions</span><span class="p">,</span> <span class="n">Region</span><span class="p">)</span>

<span class="c1">#from pyaerocom import __version__ as PYA_VERSION</span>

<div class="viewcode-block" id="delete_experiment_data_evaluation_iface"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.helpers_evaluation_iface.delete_experiment_data_evaluation_iface">[docs]</a><span class="k">def</span> <span class="nf">delete_experiment_data_evaluation_iface</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">proj_id</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete all data associated with a certain experiment</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_dir : str, optional</span>
<span class="sd">        basic output direcory (containg subdirs of all projects)</span>
<span class="sd">    proj_name : str, optional</span>
<span class="sd">        name of project, if None, then this project is used</span>
<span class="sd">    exp_name : str, optional</span>
<span class="sd">        name experiment, if None, then this project is used</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">proj_id</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;No such data directory found: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_all_config_files_evaluation_iface"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.helpers_evaluation_iface.get_all_config_files_evaluation_iface">[docs]</a><span class="k">def</span> <span class="nf">get_all_config_files_evaluation_iface</span><span class="p">(</span><span class="n">config_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    This code only checks json configuration files, not .py module files</span>
<span class="sd">    containing configuration.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config_dir : str</span>
<span class="sd">        directory containing config json files for AerocomEvaluation interface</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        nested dictionary containing file paths of all config files that were</span>
<span class="sd">        detected, where first level of dict id `proj_id` and second level</span>
<span class="sd">        is `exp_id`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/*.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config_dir</span><span class="p">)):</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">spl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span><span class="s1">&#39;cfg&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Invalid config file name &#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">proj</span><span class="p">,</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">spl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">spl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">proj</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">proj</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">results</span><span class="p">[</span><span class="n">proj</span><span class="p">][</span><span class="n">exp</span><span class="p">]</span> <span class="o">=</span> <span class="n">file</span>
    <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="reorder_experiments_menu_evaluation_iface"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.helpers_evaluation_iface.reorder_experiments_menu_evaluation_iface">[docs]</a><span class="k">def</span> <span class="nf">reorder_experiments_menu_evaluation_iface</span><span class="p">(</span><span class="n">menu_file</span><span class="p">,</span> <span class="n">exp_order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reorder experiment order in evaluation interface</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    menu_file : str</span>
<span class="sd">        file path of menu.json file</span>
<span class="sd">    exp_order : str or list, optional</span>
<span class="sd">        desired experiment order (must not contain all available experiments</span>
<span class="sd">        in menu)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">menu_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exp_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># keep the way it is</span>
        <span class="n">exp_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp_order</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">exp_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_order</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp_order</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for exp_order, need None, str or list&#39;</span><span class="p">)</span>

    <span class="n">new</span> <span class="o">=</span> <span class="n">sort_dict_by_name</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">pref_list</span><span class="o">=</span><span class="n">exp_order</span><span class="p">)</span>
    <span class="n">write_json</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">menu_file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>

<div class="viewcode-block" id="update_menu_evaluation_iface"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.helpers_evaluation_iface.update_menu_evaluation_iface">[docs]</a><span class="k">def</span> <span class="nf">update_menu_evaluation_iface</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">ignore_experiments</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update menu for Aerocom Evaluation interface</span>

<span class="sd">    The menu.json file is created based on the available json map files in the</span>
<span class="sd">    map directory of an experiment.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : AerocomEvaluation</span>
<span class="sd">        instance of config class that has all relevant paths specified</span>
<span class="sd">    ignore_experiments : list, optional</span>
<span class="sd">        list containing experiment IDs that may be in the current menu.json</span>
<span class="sd">        file and that are supposed to be removed from it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">var_dummy</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Helper that creates empty dict for variable info&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span>      <span class="p">:</span>   <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;cat&#39;</span>       <span class="p">:</span>   <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span>      <span class="p">:</span>   <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;longname&#39;</span>  <span class="p">:</span>   <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;obs&#39;</span>       <span class="p">:</span>   <span class="p">{}}</span>

    <span class="n">new</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">exp_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">exp_id</span>
    <span class="k">if</span> <span class="n">ignore_experiments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ignore_experiments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_web_overview_table</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">tab</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">obs_var</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">,</span> <span class="n">vert_code</span><span class="p">,</span> <span class="n">mod_name</span><span class="p">,</span> <span class="n">mod_var</span> <span class="o">=</span> <span class="n">info</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_var</span> <span class="ow">in</span> <span class="n">new</span><span class="p">:</span>
            <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding new observation variable: </span><span class="si">{}</span><span class="s1">&#39;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_var</span><span class="p">))</span>
            <span class="n">new</span><span class="p">[</span><span class="n">obs_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span> <span class="o">=</span> <span class="n">var_dummy</span><span class="p">()</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">cat</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_obsvar_name_and_type</span><span class="p">(</span><span class="n">obs_var</span><span class="p">)</span>

            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span>  <span class="o">=</span><span class="n">cat</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;longname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">VARS</span><span class="p">[</span><span class="n">obs_var</span><span class="p">]</span><span class="o">.</span><span class="n">description</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="n">obs_var</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_name</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">]:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">][</span><span class="n">obs_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dobs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dobs</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">][</span><span class="n">obs_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vert_code</span> <span class="ow">in</span> <span class="n">dobs</span><span class="p">:</span>
            <span class="n">dobs</span><span class="p">[</span><span class="n">vert_code</span><span class="p">]</span> <span class="o">=</span> <span class="n">dobs_vert</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dobs_vert</span> <span class="o">=</span> <span class="n">dobs</span><span class="p">[</span><span class="n">vert_code</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="n">dobs_vert</span><span class="p">:</span>
            <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Overwriting old entry for </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mod_name</span><span class="p">,</span> <span class="n">dobs_vert</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]))</span>
        <span class="n">dobs_vert</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dir&#39;</span> <span class="p">:</span> <span class="n">mod_name</span><span class="p">,</span>
                               <span class="s1">&#39;id&#39;</span>  <span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">model_config</span><span class="p">[</span><span class="n">mod_name</span><span class="p">][</span><span class="s1">&#39;model_id&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;var&#39;</span> <span class="p">:</span> <span class="n">mod_var</span><span class="p">}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_new</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">var_order_menu</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_new</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No variable </span><span class="si">{}</span><span class="s1"> found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">new</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">_new</span><span class="p">:</span>
                <span class="n">_new</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">_new</span>

    <span class="n">new_sorted</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">new</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">new_sorted</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
        <span class="n">sorted_obs</span> <span class="o">=</span> <span class="n">sort_dict_by_name</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">])</span>
        <span class="n">new_sorted</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sorted_obs</span>
        <span class="k">for</span> <span class="n">obs_name</span><span class="p">,</span> <span class="n">vert_codes</span> <span class="ow">in</span> <span class="n">sorted_obs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">vert_codes_sorted</span> <span class="o">=</span> <span class="n">sort_dict_by_name</span><span class="p">(</span><span class="n">vert_codes</span><span class="p">)</span>
            <span class="n">new_sorted</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;obs&#39;</span><span class="p">][</span><span class="n">obs_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vert_codes_sorted</span>
            <span class="k">for</span> <span class="n">vert_code</span><span class="p">,</span> <span class="n">models</span> <span class="ow">in</span> <span class="n">vert_codes_sorted</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">models_sorted</span> <span class="o">=</span> <span class="n">sort_dict_by_name</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
                <span class="n">new_sorted</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;obs&#39;</span><span class="p">][</span><span class="n">obs_name</span><span class="p">][</span><span class="n">vert_code</span><span class="p">]</span> <span class="o">=</span> <span class="n">models_sorted</span>
    <span class="n">new_menu</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">menu_file</span><span class="p">)</span>
    <span class="n">available_exps</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">basedir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">menu_file</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">menu_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">exp</span><span class="p">,</span> <span class="n">submenu</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">ignore_experiments</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">submenu</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">available_exps</span><span class="p">:</span>
                <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing outdated experiment </span><span class="si">{}</span><span class="s1"> from &#39;</span>
                                     <span class="s1">&#39;menu.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">new_menu</span><span class="p">[</span><span class="n">exp</span><span class="p">]</span> <span class="o">=</span> <span class="n">submenu</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exp_id</span> <span class="ow">in</span> <span class="n">new_menu</span><span class="p">:</span>
        <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Sub menu for experiment </span><span class="si">{}</span><span class="s1"> already exists in &#39;</span>
                                <span class="s1">&#39;menu.json and will be overwritten&#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">exp_id</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_sorted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">new_menu</span><span class="p">[</span><span class="n">exp_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_sorted</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">menu_file</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">new_menu</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span></div>

<div class="viewcode-block" id="make_info_table_evaluation_iface"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.helpers_evaluation_iface.make_info_table_evaluation_iface">[docs]</a><span class="k">def</span> <span class="nf">make_info_table_evaluation_iface</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyaerocom</span> <span class="kn">import</span> <span class="n">ColocatedData</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="n">menu</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">menu_file</span>

    <span class="n">SKIP_META</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data_source&#39;</span><span class="p">,</span> <span class="s1">&#39;var_name&#39;</span><span class="p">,</span> <span class="s1">&#39;lon_range&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;lat_range&#39;</span><span class="p">,</span> <span class="s1">&#39;alt_range&#39;</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">menu</span> <span class="o">=</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">exp_id</span> <span class="ow">in</span> <span class="n">menu</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No menu entry available for experiment </span><span class="si">{}</span><span class="s1">&#39;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">exp_id</span><span class="p">))</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="n">menu</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">exp_id</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">obs_name</span><span class="p">,</span> <span class="n">vert_types</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">vert_type</span><span class="p">,</span> <span class="n">models</span> <span class="ow">in</span> <span class="n">vert_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">mname</span><span class="p">,</span> <span class="n">minfo</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">mname</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
                        <span class="n">table</span><span class="p">[</span><span class="n">mname</span><span class="p">]</span> <span class="o">=</span> <span class="n">mi</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">mi</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_id</span> <span class="o">=</span> <span class="n">minfo</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mi</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">mname</span><span class="p">]</span>
                        <span class="n">model_id</span> <span class="o">=</span> <span class="n">mi</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">minfo</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mi</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Unexpected error: conflict in model ID and name&#39;</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">mo</span> <span class="o">=</span> <span class="n">mi</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">mi</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mo</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="s1">&#39;var&#39;</span> <span class="ow">in</span> <span class="n">minfo</span><span class="p">:</span>
                        <span class="n">mvar</span> <span class="o">=</span> <span class="n">minfo</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mvar</span> <span class="o">=</span> <span class="n">obs_var</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_var</span> <span class="ow">in</span> <span class="n">mo</span><span class="p">:</span>
                        <span class="n">mo</span><span class="p">[</span><span class="n">obs_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">oi</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">oi</span> <span class="o">=</span> <span class="n">mo</span><span class="p">[</span><span class="n">obs_var</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">obs_name</span> <span class="ow">in</span> <span class="n">oi</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span>
                    <span class="n">oi</span><span class="p">[</span><span class="n">obs_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">motab</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">motab</span><span class="p">[</span><span class="s1">&#39;model_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mvar</span>
                    <span class="n">motab</span><span class="p">[</span><span class="s1">&#39;obs_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_obs_id</span><span class="p">(</span><span class="n">obs_name</span><span class="p">)</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">*REF-</span><span class="si">{}</span><span class="s1">*.nc&#39;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">coldata_dir</span><span class="p">,</span>
                                              <span class="n">model_id</span><span class="p">,</span> <span class="n">mvar</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">))</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">motab</span><span class="p">[</span><span class="s1">&#39;MULTIFILES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">motab</span><span class="p">[</span><span class="s1">&#39;NOFILES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>

                    <span class="n">coldata</span> <span class="o">=</span> <span class="n">ColocatedData</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">coldata</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">SKIP_META</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                    <span class="n">motab</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_obs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="n">motab</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_mod&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">motab</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">motab</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table</span></div>

<div class="viewcode-block" id="get_stationfile_name"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.helpers_evaluation_iface.get_stationfile_name">[docs]</a><span class="k">def</span> <span class="nf">get_stationfile_name</span><span class="p">(</span><span class="n">station_name</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">vert_code</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get name of station timeseries file&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_OBS-</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.json&#39;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">station_name</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">vert_code</span><span class="p">))</span></div>

<div class="viewcode-block" id="get_json_mapname"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.helpers_evaluation_iface.get_json_mapname">[docs]</a><span class="k">def</span> <span class="nf">get_json_mapname</span><span class="p">(</span><span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model_var</span><span class="p">,</span>
                     <span class="n">vert_code</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get name base name of json file&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;OBS-</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_MOD-</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">.json&#39;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">vert_code</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model_var</span><span class="p">))</span></div>

<span class="k">def</span> <span class="nf">_write_stationdata_json</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">out_dirs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method writes time series data given in a dictionary to .json files</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ts_data : dict</span>
<span class="sd">        A dictionary containing all processed time series data.</span>
<span class="sd">    out_dirs : list?</span>
<span class="sd">        list of file paths for writing data to</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">        Raised if opening json file fails</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">get_stationfile_name</span><span class="p">(</span><span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">],</span>
                                    <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;web_iface_name&#39;</span><span class="p">],</span>
                                    <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;obs_var&#39;</span><span class="p">],</span>
                                    <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;vert_code&#39;</span><span class="p">])</span>

    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dirs</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Fatal: could not open existing json file: </span><span class="si">{}</span><span class="s1">. &#39;</span>
                            <span class="s1">&#39;Reason: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">current</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">current</span><span class="p">[</span><span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ts_data</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">simplejson</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ignore_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_write_diurnal_week_stationdata_json</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">out_dirs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Minor modification of method _write_stationdata_json to allow a further</span>
<span class="sd">    level of sub-directories</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ts_data : dict</span>
<span class="sd">        A dictionary containing all processed time series data.</span>
<span class="sd">    out_dirs : list</span>
<span class="sd">        list of file paths for writing data to</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">        Raised if opening json file fails</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">get_stationfile_name</span><span class="p">(</span><span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">],</span>
                                    <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;web_iface_name&#39;</span><span class="p">],</span>
                                    <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;obs_var&#39;</span><span class="p">],</span>
                                    <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;vert_code&#39;</span><span class="p">])</span>

    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dirs</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span><span class="s1">&#39;dw&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Fatal: could not open existing json file: </span><span class="si">{}</span><span class="s1">. &#39;</span>
                            <span class="s1">&#39;Reason: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">current</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">current</span><span class="p">[</span><span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ts_data</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">simplejson</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ignore_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="add_entry_heatmap_json"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.helpers_evaluation_iface.add_entry_heatmap_json">[docs]</a><span class="k">def</span> <span class="nf">add_entry_heatmap_json</span><span class="p">(</span><span class="n">heatmap_file</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">vert_code</span><span class="p">,</span>
                           <span class="n">model_name</span><span class="p">,</span> <span class="n">model_var</span><span class="p">):</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">heatmap_file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Fatal: could not open existing json file: </span><span class="si">{}</span><span class="s1">. &#39;</span>
                            <span class="s1">&#39;Reason: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">current</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_var</span> <span class="ow">in</span> <span class="n">current</span><span class="p">:</span>
        <span class="n">current</span><span class="p">[</span><span class="n">obs_var</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ov</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="n">obs_var</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_name</span> <span class="ow">in</span> <span class="n">ov</span><span class="p">:</span>
        <span class="n">ov</span><span class="p">[</span><span class="n">obs_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">on</span> <span class="o">=</span> <span class="n">ov</span><span class="p">[</span><span class="n">obs_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">vert_code</span> <span class="ow">in</span> <span class="n">on</span><span class="p">:</span>
        <span class="n">on</span><span class="p">[</span><span class="n">vert_code</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ovc</span> <span class="o">=</span> <span class="n">on</span><span class="p">[</span><span class="n">vert_code</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">ovc</span><span class="p">:</span>
        <span class="n">ovc</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mn</span> <span class="o">=</span> <span class="n">ovc</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">model_var</span> <span class="ow">in</span> <span class="n">mn</span><span class="p">:</span>
        <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Overwriting existing heatmap statistics for &#39;</span>
                             <span class="s1">&#39;model </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">) in glob_stats.json&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_var</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">,</span>
                                     <span class="n">vert_code</span><span class="p">))</span>
    <span class="n">mn</span><span class="p">[</span><span class="n">model_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">simplejson</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ignore_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_init_stats_dummy</span><span class="p">():</span>
    <span class="c1"># dummy for statistics dictionary for locations without data</span>
    <span class="n">stats_dummy</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">calc_statistics</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">stats_dummy</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">stats_dummy</span>

<span class="k">def</span> <span class="nf">_check_flatten_latlon_dims</span><span class="p">(</span><span class="n">coldata</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;station_name&#39;</span> <span class="ow">in</span> <span class="n">coldata</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">coldata</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataDimensionError</span><span class="p">(</span><span class="s1">&#39;Invalid number of dimensions. &#39;</span>
                                     <span class="s1">&#39;Need 4, got: </span><span class="si">{}</span><span class="s1">&#39;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coldata</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="s1">&#39;latitude&#39;</span> <span class="ow">in</span> <span class="n">coldata</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span> <span class="ow">and</span> <span class="s1">&#39;longitude&#39;</span> <span class="ow">in</span> <span class="n">coldata</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataDimensionError</span><span class="p">(</span><span class="s1">&#39;Need latitude and longitude &#39;</span>
                                     <span class="s1">&#39;dimension. Got </span><span class="si">{}</span><span class="s1">&#39;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coldata</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">))</span>
        <span class="n">coldata</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">coldata</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">station_name</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;longitude&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">coldata</span>

<span class="k">def</span> <span class="nf">_prepare_default_regions_json</span><span class="p">():</span>
    <span class="n">regs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">regname</span> <span class="ow">in</span> <span class="n">get_all_default_region_ids</span><span class="p">():</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">regname</span><span class="p">)</span>
        <span class="n">regs</span><span class="p">[</span><span class="n">regname</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">latr</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">lat_range</span>
        <span class="n">r</span><span class="p">[</span><span class="s1">&#39;minLat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">r</span><span class="p">[</span><span class="s1">&#39;maxLat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lonr</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">lon_range</span>
        <span class="n">r</span><span class="p">[</span><span class="s1">&#39;minLon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">r</span><span class="p">[</span><span class="s1">&#39;maxLon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">regs</span>

<div class="viewcode-block" id="init_regions_web"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.helpers_evaluation_iface.init_regions_web">[docs]</a><span class="k">def</span> <span class="nf">init_regions_web</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="n">regions_how</span><span class="p">):</span>
    <span class="n">default_regs</span> <span class="o">=</span> <span class="n">_prepare_default_regions_json</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">regions_how</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default_regs</span>
        <span class="c1">#region_ids = get_all_default_region_ids()</span>
    <span class="k">elif</span> <span class="n">regions_how</span> <span class="o">==</span> <span class="s1">&#39;country&#39;</span><span class="p">:</span>
        <span class="n">regs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">regs</span><span class="p">[</span><span class="s1">&#39;WORLD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_regs</span><span class="p">[</span><span class="s1">&#39;WORLD&#39;</span><span class="p">]</span>
        <span class="n">coldata</span><span class="o">.</span><span class="n">check_set_countries</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">regs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">coldata</span><span class="o">.</span><span class="n">get_country_codes</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">regs</span>
        <span class="c1">#region_ids = coldata.countries_available</span>
    <span class="k">elif</span> <span class="n">regions_how</span> <span class="o">==</span> <span class="s1">&#39;htap&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Support for HTAP regions is coming soon&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input for regions_how&#39;</span><span class="p">,</span> <span class="n">regions_how</span><span class="p">)</span></div>

<div class="viewcode-block" id="update_regions_json"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.helpers_evaluation_iface.update_regions_json">[docs]</a><span class="k">def</span> <span class="nf">update_regions_json</span><span class="p">(</span><span class="n">region_defs</span><span class="p">,</span> <span class="n">regions_json</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">regions_json</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">regions_json</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">current</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">region_id</span><span class="p">,</span> <span class="n">region_info</span> <span class="ow">in</span> <span class="n">region_defs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">region_id</span> <span class="ow">in</span> <span class="n">current</span><span class="p">:</span>
            <span class="n">current</span><span class="p">[</span><span class="n">region_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_info</span>
    <span class="n">save_dict_json</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">regions_json</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">current</span></div>

<span class="k">def</span> <span class="nf">_init_data_default_frequenciesOLD</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="n">colocation_settings</span><span class="p">):</span>
    <span class="n">ts_types_order</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">GRID_IO</span><span class="o">.</span><span class="n">TS_TYPES</span>
    <span class="n">to_ts_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="s1">&#39;yearly&#39;</span><span class="p">]</span>

    <span class="n">data_arrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">to_ts_types</span><span class="p">)</span>
    <span class="n">jsdate</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">to_ts_types</span><span class="p">)</span>

    <span class="n">ts_type</span> <span class="o">=</span> <span class="n">coldata</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;ts_type&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">to_ts_types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ts_types_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ts_types_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ts_type</span><span class="p">):</span>
            <span class="n">data_arrs</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">ts_types_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">==</span> <span class="n">ts_types_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ts_type</span><span class="p">):</span>
            <span class="n">data_arrs</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">coldata</span><span class="o">.</span><span class="n">data</span>

            <span class="n">js</span> <span class="o">=</span> <span class="p">(</span><span class="n">coldata</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[s]&#39;</span><span class="p">)</span> <span class="o">-</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s1">&#39;1970&#39;</span><span class="p">,</span> <span class="s1">&#39;[s]&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">jsdate</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">js</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">colstp</span> <span class="o">=</span> <span class="n">colocation_settings</span>
            <span class="n">_a</span> <span class="o">=</span> <span class="n">coldata</span><span class="o">.</span><span class="n">resample_time</span><span class="p">(</span><span class="n">to_ts_type</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span>
                                 <span class="n">apply_constraints</span><span class="o">=</span><span class="n">colstp</span><span class="o">.</span><span class="n">apply_time_resampling_constraints</span><span class="p">,</span>
                                 <span class="n">min_num_obs</span><span class="o">=</span><span class="n">colstp</span><span class="o">.</span><span class="n">min_num_obs</span><span class="p">,</span>
                                 <span class="n">colocate_time</span><span class="o">=</span><span class="n">colstp</span><span class="o">.</span><span class="n">colocate_time</span><span class="p">,</span>
                                 <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
            <span class="n">data_arrs</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">_a</span> <span class="c1">#= resample_time_dataarray(arr, freq=freq)</span>

            <span class="n">js</span> <span class="o">=</span> <span class="p">(</span><span class="n">_a</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[s]&#39;</span><span class="p">)</span> <span class="o">-</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s1">&#39;1970&#39;</span><span class="p">,</span> <span class="s1">&#39;[s]&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">jsdate</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">js</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data_arrs</span><span class="p">,</span> <span class="n">jsdate</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_init_meta_glob</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">coldata</span><span class="o">.</span><span class="n">meta</span>

    <span class="c1"># create metadata dictionary that is shared among all timeseries files</span>
    <span class="n">meta_glob</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">meta_glob</span><span class="p">[</span><span class="s1">&#39;pyaerocom_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;pyaerocom&#39;</span><span class="p">]</span>
    <span class="c1">#meta_glob[&#39;obs_name&#39;] = obs_name</span>
    <span class="c1">#meta_glob[&#39;model_name&#39;] = model_name</span>
    <span class="n">meta_glob</span><span class="p">[</span><span class="s1">&#39;obs_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">meta_glob</span><span class="p">[</span><span class="s1">&#39;obs_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;var_units&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#meta_glob[&#39;vert_code&#39;] = vert_code</span>
    <span class="n">meta_glob</span><span class="p">[</span><span class="s1">&#39;obs_freq_src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;ts_type_src&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">meta_glob</span><span class="p">[</span><span class="s1">&#39;obs_revision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;revision_ref&#39;</span><span class="p">]</span>

    <span class="n">meta_glob</span><span class="p">[</span><span class="s1">&#39;mod_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">meta_glob</span><span class="p">[</span><span class="s1">&#39;mod_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;var_units&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">meta_glob</span><span class="p">[</span><span class="s1">&#39;mod_freq_src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;ts_type_src&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">meta_glob</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">meta_glob</span>

<span class="k">def</span> <span class="nf">_init_ts_data</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">daily_date</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">daily_obs</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">daily_mod</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">monthly_date</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">monthly_obs</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">monthly_mod</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">yearly_date</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">yearly_obs</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">yearly_mod</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="p">)</span>

<span class="k">def</span> <span class="nf">_create_diurnal_weekly_data_object</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span><span class="n">resolution</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Private helper functions that creates the data set containing all the</span>
<span class="sd">    weekly time series at the specified resolution. Called by</span>
<span class="sd">    _process_sites_weekly_ts. The returned xarray.Dataset contains a dummy time</span>
<span class="sd">    variable (currently not used) and the weekly time series as xarray.DataArray</span>
<span class="sd">    objects.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coldata : ColocatedData</span>
<span class="sd">        ColocatedData object colocated on hourly resolution.</span>
<span class="sd">    resolution : string</span>
<span class="sd">        String specifying the averaging window used to generate representative</span>
<span class="sd">        weekly time series with hourly resolution. Valid values are &#39;yearly&#39;</span>
<span class="sd">        and  &#39;seasonal&#39;.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If an invalid resolution is given raise ValueError and print what</span>
<span class="sd">        was given.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rep_week_full_period : xarray.Dataset</span>
<span class="sd">        Contains the weekly time series as the variable &#39;rep_week&#39;</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">coldata</span><span class="o">.</span><span class="n">data</span>
    <span class="k">if</span> <span class="n">resolution</span> <span class="o">==</span> <span class="s1">&#39;seasonal&#39;</span><span class="p">:</span>
        <span class="n">seasons</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DJF&#39;</span><span class="p">,</span><span class="s1">&#39;MAM&#39;</span><span class="p">,</span><span class="s1">&#39;JJA&#39;</span><span class="p">,</span><span class="s1">&#39;SON&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">resolution</span> <span class="o">==</span> <span class="s1">&#39;yearly&#39;</span><span class="p">:</span>
        <span class="n">seasons</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid resolution. Got </span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">seas</span> <span class="ow">in</span> <span class="n">seasons</span><span class="p">:</span>
        <span class="n">rep_week_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">resolution</span> <span class="o">==</span> <span class="s1">&#39;seasonal&#39;</span><span class="p">:</span>
            <span class="n">mon_slice</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time.season&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">seas</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">resolution</span> <span class="o">==</span> <span class="s1">&#39;yearly&#39;</span><span class="p">:</span>
            <span class="n">mon_slice</span> <span class="o">=</span> <span class="n">data</span>

        <span class="n">month_stamp</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">seas</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
            <span class="n">day_slice</span> <span class="o">=</span> <span class="n">mon_slice</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mon_slice</span><span class="p">[</span><span class="s1">&#39;time.dayofweek&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">day</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">rep_day</span> <span class="o">=</span> <span class="n">day_slice</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.hour&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
            <span class="n">rep_day</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rep_day</span><span class="o">.</span><span class="n">hour</span><span class="o">/</span><span class="mi">24</span><span class="o">+</span><span class="n">day</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">day</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rep_week</span> <span class="o">=</span> <span class="n">rep_day</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rep_week</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rep_week</span><span class="p">,</span><span class="n">rep_day</span><span class="p">],</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;hour&#39;</span><span class="p">)</span>

        <span class="n">rep_week</span><span class="o">=</span><span class="n">rep_week</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;hour&#39;</span><span class="p">:</span><span class="s1">&#39;dummy_time&#39;</span><span class="p">})</span>
        <span class="n">month_stamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rep_week</span><span class="o">.</span><span class="n">dummy_time</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;&lt;U5&#39;</span><span class="p">)</span>
        <span class="n">month_stamps</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">month_stamp</span>
        <span class="n">rep_week_ds</span><span class="p">[</span><span class="s1">&#39;rep_week&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">rep_week</span>
        <span class="n">rep_week_ds</span><span class="p">[</span><span class="s1">&#39;month_stamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;dummy_time&#39;</span><span class="p">),</span><span class="n">month_stamps</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">seas</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DJF&#39;</span><span class="p">,</span><span class="s1">&#39;year&#39;</span><span class="p">]:</span>
            <span class="n">rep_week_full_period</span> <span class="o">=</span> <span class="n">rep_week_ds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rep_week_full_period</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rep_week_full_period</span><span class="p">,</span><span class="n">rep_week_ds</span><span class="p">],</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rep_week_full_period</span>

<span class="k">def</span> <span class="nf">_get_period_keys</span><span class="p">(</span><span class="n">resolution</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">resolution</span> <span class="o">==</span> <span class="s1">&#39;seasonal&#39;</span><span class="p">:</span>
        <span class="n">period_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DJF&#39;</span><span class="p">,</span><span class="s1">&#39;MAM&#39;</span><span class="p">,</span><span class="s1">&#39;JJA&#39;</span><span class="p">,</span><span class="s1">&#39;SON&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">resolution</span> <span class="o">==</span> <span class="s1">&#39;yearly&#39;</span><span class="p">:</span>
        <span class="n">period_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Annual&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">period_keys</span>

<span class="k">def</span> <span class="nf">_process_one_station_weekly</span><span class="p">(</span><span class="n">stat_name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span><span class="n">repw_res</span><span class="p">,</span> <span class="n">meta_glob</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes one station data set for all supported averaging windows into a</span>
<span class="sd">    dict of station time series data and metadata.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stat_name : string</span>
<span class="sd">        Name of station to process</span>
<span class="sd">    i : int</span>
<span class="sd">        Index of the station to process in the xarray.Datasets.</span>
<span class="sd">    repw_res : dict</span>
<span class="sd">        Dictionary of xarray.Datasets for each supported averaging window for</span>
<span class="sd">        the weekly time series</span>
<span class="sd">    meta_glob : TYPE</span>
<span class="sd">        Dictionary containing global metadata.</span>
<span class="sd">    time : list</span>
<span class="sd">        Time index.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ts_data : dict</span>
<span class="sd">        Dictinary of time series data and metadata for one station. Contains all</span>
<span class="sd">        resolutions/averaging windows.</span>
<span class="sd">    has_data : bool</span>
<span class="sd">        Set to false if all data is missing for a station.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">has_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ts_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span> <span class="p">:</span> <span class="n">time</span><span class="p">,</span><span class="s1">&#39;seasonal&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;obs&#39;</span> <span class="p">:</span> <span class="p">{},</span><span class="s1">&#39;mod&#39;</span> <span class="p">:</span> <span class="p">{}},</span><span class="s1">&#39;yearly&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;obs&#39;</span> <span class="p">:</span> <span class="p">{},</span><span class="s1">&#39;mod&#39;</span> <span class="p">:</span> <span class="p">{}}</span> <span class="p">}</span>
    <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_name</span>
    <span class="n">ts_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta_glob</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">res</span><span class="p">,</span><span class="n">repw</span> <span class="ow">in</span> <span class="n">repw_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">obs_vals</span> <span class="o">=</span> <span class="n">repw</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs_vals</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">has_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mod_vals</span> <span class="o">=</span> <span class="n">repw</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>

        <span class="n">period_keys</span> <span class="o">=</span> <span class="n">_get_period_keys</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">period_num</span><span class="p">,</span><span class="n">pk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">period_keys</span><span class="p">):</span>
            <span class="n">ts_data</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="s1">&#39;obs&#39;</span><span class="p">][</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs_vals</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period_num</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">ts_data</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="s1">&#39;mod&#39;</span><span class="p">][</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_vals</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period_num</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ts_data</span><span class="p">,</span> <span class="n">has_data</span>

<span class="k">def</span> <span class="nf">_process_weekly_object_to_station_time_series</span><span class="p">(</span><span class="n">repw_res</span><span class="p">,</span><span class="n">meta_glob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process the xarray.Datasets objects returned by _create_diurnal_weekly_data_object</span>
<span class="sd">    into a dictionary containing station time series data and metadata.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    repw_res : dict</span>
<span class="sd">        Dictionary of xarray.Datasets for each supported averaging window for</span>
<span class="sd">        the weekly time series</span>
<span class="sd">    meta_glob : dict</span>
<span class="sd">        Dictionary containing global metadata.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ts_objs : list</span>
<span class="sd">        List of dicts containing station time series data and metadata.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ts_objs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">168</span><span class="p">)</span><span class="o">/</span><span class="mi">24</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stat_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">repw_res</span><span class="p">[</span><span class="s1">&#39;seasonal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">station_name</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
        <span class="n">ts_data</span><span class="p">,</span> <span class="n">has_data</span> <span class="o">=</span> <span class="n">_process_one_station_weekly</span><span class="p">(</span><span class="n">stat_name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">repw_res</span><span class="p">,</span>
                                                        <span class="n">meta_glob</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_data</span><span class="p">:</span>
            <span class="n">ts_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_data</span><span class="p">)</span>
            <span class="n">dc</span> <span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">ts_objs</span>

<span class="k">def</span> <span class="nf">_process_weekly_object_to_country_time_series</span><span class="p">(</span><span class="n">repw_res</span><span class="p">,</span><span class="n">meta_glob</span><span class="p">,</span><span class="n">regions_how</span><span class="p">,</span><span class="n">region_ids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process the xarray.Dataset objects returned by _create_diurnal_weekly_data_object</span>
<span class="sd">    into a dictionary containing country average time series data and metadata.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    repw_res : dict</span>
<span class="sd">        Dictionary of xarray.Datasets for each supported averaging window for</span>
<span class="sd">        the weekly time series</span>
<span class="sd">    meta_glob : dict</span>
<span class="sd">        Dictionary containing global metadata.</span>
<span class="sd">    regions_how : string</span>
<span class="sd">        String describing how regions are to be processed. Regional time series</span>
<span class="sd">        are only calculated if regions_how = country.</span>
<span class="sd">    region_ids : list?</span>
<span class="sd">        List of regional IDs</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ts_objs_reg : list</span>
<span class="sd">        List of dicts containing station time series data and metadata.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ts_objs_reg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">168</span><span class="p">)</span><span class="o">/</span><span class="mi">24</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">regions_how</span> <span class="o">!=</span> <span class="s1">&#39;country&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Regional diurnal cycles are only implemented for country regions, skipping...&#39;</span><span class="p">)</span>
        <span class="n">ts_objs_reg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">region_ids</span><span class="p">:</span>
            <span class="n">ts_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span> <span class="p">:</span> <span class="n">time</span><span class="p">,</span><span class="s1">&#39;seasonal&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;obs&#39;</span> <span class="p">:</span> <span class="p">{},</span><span class="s1">&#39;mod&#39;</span> <span class="p">:</span> <span class="p">{}},</span><span class="s1">&#39;yearly&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;obs&#39;</span> <span class="p">:</span> <span class="p">{},</span><span class="s1">&#39;mod&#39;</span> <span class="p">:</span> <span class="p">{}}</span> <span class="p">}</span>
            <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span>
            <span class="n">ts_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta_glob</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">res</span><span class="p">,</span><span class="n">repw</span> <span class="ow">in</span> <span class="n">repw_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">reg</span> <span class="o">==</span> <span class="s1">&#39;WORLD&#39;</span><span class="p">:</span>
                    <span class="n">subset</span> <span class="o">=</span> <span class="n">repw</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">subset</span> <span class="o">=</span> <span class="n">repw</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">repw</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="n">reg</span><span class="p">)</span>

                <span class="c1"># if cd.has_latlon_dims:</span>
                <span class="c1">#     avg = subset.data.mean(dim=(&#39;latitude&#39;, &#39;longitude&#39;))</span>
                <span class="c1"># else:</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;station_name&#39;</span><span class="p">)</span>
                <span class="n">obs_vals</span> <span class="o">=</span> <span class="n">avg</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span>
                <span class="n">mod_vals</span> <span class="o">=</span> <span class="n">avg</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:]</span>

                <span class="n">period_keys</span> <span class="o">=</span> <span class="n">_get_period_keys</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">period_num</span><span class="p">,</span><span class="n">pk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">period_keys</span><span class="p">):</span>
                    <span class="n">ts_data</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="s1">&#39;obs&#39;</span><span class="p">][</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs_vals</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period_num</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">ts_data</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="s1">&#39;mod&#39;</span><span class="p">][</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_vals</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period_num</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="n">ts_objs_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ts_objs_reg</span>

<span class="k">def</span> <span class="nf">_process_sites_weekly_ts</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span><span class="n">regions_how</span><span class="p">,</span><span class="n">region_ids</span><span class="p">,</span><span class="n">meta_glob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Private helper function to process ColocatedData objects into dictionaries</span>
<span class="sd">    containing represenative weekly time series with hourly resolution.</span>

<span class="sd">    Processing the coloceted data object into a collection of representative</span>
<span class="sd">    weekly time series is done in the private function _create_diurnal_weekly_data_object.</span>
<span class="sd">    This object (an xarray.Dataset) is then further processed into two dictionaries</span>
<span class="sd">    containing station and regional time series respectively.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coldata : ColocatedData</span>
<span class="sd">        The colocated data to process.</span>
<span class="sd">    regions_how : string</span>
<span class="sd">        Srting describing how regions are to be processed. Regional time series</span>
<span class="sd">        are only calculated if regions_how = country.</span>
<span class="sd">    region_ids : list?</span>
<span class="sd">        List of regional IDs.</span>
<span class="sd">    meta_glob : dict</span>
<span class="sd">        Dictionary containing global metadata.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ts_objs : list</span>
<span class="sd">        List of dicts containing station time series data and metadata.</span>
<span class="sd">    ts_objs_reg : list</span>
<span class="sd">        List of dicts containing country time series data and metadata.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="n">ColocatedData</span><span class="p">):</span>
        <span class="n">_check_flatten_latlon_dims</span><span class="p">(</span><span class="n">coldata</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">coldata</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;data_source&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;station_name&#39;</span><span class="p">)</span>

    <span class="n">repw_res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;seasonal&#39;</span><span class="p">:</span><span class="n">_create_diurnal_weekly_data_object</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="s1">&#39;seasonal&#39;</span><span class="p">)[</span><span class="s1">&#39;rep_week&#39;</span><span class="p">],</span>
                <span class="s1">&#39;yearly&#39;</span><span class="p">:</span><span class="n">_create_diurnal_weekly_data_object</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="s1">&#39;yearly&#39;</span><span class="p">)[</span><span class="s1">&#39;rep_week&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),}</span>

    <span class="n">default_regs</span> <span class="o">=</span> <span class="n">get_all_default_regions</span><span class="p">(</span><span class="n">use_all_in_ini</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


    <span class="n">lats</span> <span class="o">=</span> <span class="n">repw_res</span><span class="p">[</span><span class="s1">&#39;seasonal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">repw_res</span><span class="p">[</span><span class="s1">&#39;seasonal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;altitude&#39;</span> <span class="ow">in</span> <span class="n">repw_res</span><span class="p">[</span><span class="s1">&#39;seasonal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="n">alts</span> <span class="o">=</span> <span class="n">repw_res</span><span class="p">[</span><span class="s1">&#39;seasonal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">altitude</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alts</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">regions_how</span> <span class="o">==</span> <span class="s1">&#39;country&#39;</span><span class="p">:</span>
        <span class="n">countries</span> <span class="o">=</span> <span class="n">repw_res</span><span class="p">[</span><span class="s1">&#39;seasonal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">values</span>

    <span class="n">ts_objs</span> <span class="o">=</span> <span class="n">_process_weekly_object_to_station_time_series</span><span class="p">(</span><span class="n">repw_res</span><span class="p">,</span><span class="n">meta_glob</span><span class="p">)</span>
    <span class="n">ts_objs_reg</span> <span class="o">=</span> <span class="n">_process_weekly_object_to_country_time_series</span><span class="p">(</span><span class="n">repw_res</span><span class="p">,</span>
                                                                <span class="n">meta_glob</span><span class="p">,</span>
                                                                <span class="n">regions_how</span><span class="p">,</span>
                                                                <span class="n">region_ids</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ts_objs</span><span class="p">,</span><span class="n">ts_objs_reg</span>

<span class="k">def</span> <span class="nf">_process_sites</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">jsdate</span><span class="p">,</span> <span class="n">regions_how</span><span class="p">,</span> <span class="n">meta_glob</span><span class="p">):</span>
    <span class="n">ts_objs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">map_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scat_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">ColocatedData</span><span class="p">):</span>
            <span class="n">_check_flatten_latlon_dims</span><span class="p">(</span><span class="n">cd</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">cd</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;data_source&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;station_name&#39;</span><span class="p">)</span>

    <span class="n">mon</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;monthly&#39;</span><span class="p">]</span>

    <span class="n">stats_dummy</span> <span class="o">=</span> <span class="n">_init_stats_dummy</span><span class="p">()</span>
    <span class="n">default_regs</span> <span class="o">=</span> <span class="n">get_all_default_regions</span><span class="p">(</span><span class="n">use_all_in_ini</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">lats</span> <span class="o">=</span> <span class="n">mon</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">mon</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;altitude&#39;</span> <span class="ow">in</span> <span class="n">mon</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="n">alts</span> <span class="o">=</span> <span class="n">mon</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">altitude</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alts</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">regions_how</span> <span class="o">==</span> <span class="s1">&#39;country&#39;</span><span class="p">:</span>
        <span class="n">countries</span> <span class="o">=</span> <span class="n">mon</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">values</span>
    <span class="n">dc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stat_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mon</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">station_name</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
        <span class="n">has_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ts_data</span> <span class="o">=</span> <span class="n">_init_ts_data</span><span class="p">()</span>
        <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_name</span>
        <span class="n">ts_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta_glob</span><span class="p">)</span>

        <span class="n">stat_lat</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">stat_lon</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">stat_alt</span> <span class="o">=</span> <span class="n">alts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">regions_how</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">find_closest_region_coord</span><span class="p">(</span><span class="n">stat_lat</span><span class="p">,</span> <span class="n">stat_lon</span><span class="p">,</span>
                                               <span class="n">default_regs</span><span class="o">=</span><span class="n">default_regs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">regions_how</span> <span class="o">==</span> <span class="s1">&#39;country&#39;</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">countries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># station information for map view</span>
        <span class="n">map_stat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;site&#39;</span>      <span class="p">:</span> <span class="n">stat_name</span><span class="p">,</span>
                    <span class="s1">&#39;lat&#39;</span>       <span class="p">:</span> <span class="n">stat_lat</span><span class="p">,</span>
                    <span class="s1">&#39;lon&#39;</span>       <span class="p">:</span> <span class="n">stat_lon</span><span class="p">,</span>
                    <span class="s1">&#39;alt&#39;</span>       <span class="p">:</span> <span class="n">stat_alt</span><span class="p">,</span>
                    <span class="s1">&#39;region&#39;</span>    <span class="p">:</span> <span class="n">region</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">tres</span><span class="p">,</span> <span class="n">coldata</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="n">map_stat</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_statistics&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tres</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">coldata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">map_stat</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_statistics&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tres</span><span class="p">)]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stats_dummy</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">coldata</span><span class="o">.</span><span class="n">data</span>
            <span class="n">obs_vals</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs_vals</span><span class="p">)):</span>
                <span class="n">map_stat</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_statistics&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tres</span><span class="p">)]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stats_dummy</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">has_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">mod_vals</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_date&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tres</span><span class="p">)]</span> <span class="o">=</span> <span class="n">jsdate</span><span class="p">[</span><span class="n">tres</span><span class="p">]</span>
            <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_obs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tres</span><span class="p">)]</span> <span class="o">=</span> <span class="n">obs_vals</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_mod&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tres</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mod_vals</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="n">station_statistics</span> <span class="o">=</span> <span class="n">calc_statistics</span><span class="p">(</span><span class="n">mod_vals</span><span class="p">,</span> <span class="n">obs_vals</span><span class="p">,</span>
                                                 <span class="n">min_num_valid</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">station_statistics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">station_statistics</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">map_stat</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_statistics&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tres</span><span class="p">)]</span> <span class="o">=</span> <span class="n">station_statistics</span>

        <span class="k">if</span> <span class="n">has_data</span><span class="p">:</span>
            <span class="n">ts_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_data</span><span class="p">)</span>
            <span class="n">map_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">map_stat</span><span class="p">)</span>
            <span class="n">scat_data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">stat_name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sc</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;monthly_obs&#39;</span><span class="p">]</span>
            <span class="n">sc</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;monthly_mod&#39;</span><span class="p">]</span>
            <span class="n">sc</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span>
            <span class="n">dc</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">map_data</span><span class="p">,</span> <span class="n">scat_data</span><span class="p">,</span> <span class="n">ts_objs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_process_regional_timeseries</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">jsdate</span><span class="p">,</span> <span class="n">region_ids</span><span class="p">,</span>
                                 <span class="n">regions_how</span><span class="p">,</span> <span class="n">meta_glob</span><span class="p">):</span>
    <span class="n">ts_objs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">check_countries</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">regions_how</span><span class="o">==</span><span class="s1">&#39;country&#39;</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">region_ids</span><span class="p">:</span>
        <span class="n">ts_data</span> <span class="o">=</span> <span class="n">_init_ts_data</span><span class="p">()</span>
        <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span>
        <span class="n">ts_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta_glob</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">ColocatedData</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">filter_region</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span>
                                      <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">check_country_meta</span><span class="o">=</span><span class="n">check_countries</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cd</span><span class="o">.</span><span class="n">has_latlon_dims</span><span class="p">:</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;station_name&#39;</span><span class="p">)</span>
            <span class="n">obs_vals</span> <span class="o">=</span> <span class="n">avg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">mod_vals</span> <span class="o">=</span> <span class="n">avg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_date&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">freq</span><span class="p">)]</span> <span class="o">=</span> <span class="n">jsdate</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span>
            <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_obs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">freq</span><span class="p">)]</span> <span class="o">=</span> <span class="n">obs_vals</span>
            <span class="n">ts_data</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_mod&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">freq</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mod_vals</span>

        <span class="n">ts_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ts_objs</span>

<span class="k">def</span> <span class="nf">_process_heatmap_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">region_ids</span><span class="p">,</span> <span class="n">use_weights</span><span class="p">,</span> <span class="n">use_country</span><span class="p">,</span>
                          <span class="n">meta_glob</span><span class="p">):</span>

    <span class="n">hm_all</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="s1">&#39;monthly&#39;</span><span class="p">),</span> <span class="p">({},{})))</span>
    <span class="n">stats_dummy</span> <span class="o">=</span> <span class="n">_init_stats_dummy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">hm_data</span> <span class="ow">in</span> <span class="n">hm_all</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">region_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hm_data</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats_dummy</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coldata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span>

                <span class="n">filtered</span> <span class="o">=</span> <span class="n">coldata</span><span class="o">.</span><span class="n">filter_region</span><span class="p">(</span><span class="n">region_id</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
                                                 <span class="n">check_country_meta</span><span class="o">=</span><span class="n">use_country</span><span class="p">)</span>

                <span class="n">stats</span> <span class="o">=</span> <span class="n">filtered</span><span class="o">.</span><span class="n">calc_statistics</span><span class="p">(</span><span class="n">use_area_weights</span><span class="o">=</span><span class="n">use_weights</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">==</span><span class="s1">&#39;NOTE&#39;</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">stats</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

                <span class="n">hm_data</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>
    <span class="k">return</span> <span class="n">hm_all</span>

<span class="k">def</span> <span class="nf">_get_jsdate</span><span class="p">(</span><span class="n">coldata</span><span class="p">):</span>
    <span class="n">js</span> <span class="o">=</span> <span class="p">(</span><span class="n">coldata</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[s]&#39;</span><span class="p">)</span> <span class="o">-</span>
          <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s1">&#39;1970&#39;</span><span class="p">,</span> <span class="s1">&#39;[s]&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="k">return</span> <span class="n">js</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_resample_time_coldata</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">colstp</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">coldata</span><span class="o">.</span><span class="n">resample_time</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span>
                <span class="n">apply_constraints</span><span class="o">=</span><span class="n">colstp</span><span class="o">.</span><span class="n">apply_time_resampling_constraints</span><span class="p">,</span>
                <span class="n">min_num_obs</span><span class="o">=</span><span class="n">colstp</span><span class="o">.</span><span class="n">min_num_obs</span><span class="p">,</span>
                <span class="n">colocate_time</span><span class="o">=</span><span class="n">colstp</span><span class="o">.</span><span class="n">colocate_time</span><span class="p">,</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_init_data_default_frequencies</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="n">colocation_settings</span><span class="p">):</span>

    <span class="n">to_ts_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;monthly&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;yearly&#39;</span><span class="p">]</span>

    <span class="n">data_arrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">to_ts_types</span><span class="p">)</span>
    <span class="n">jsdate</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">to_ts_types</span><span class="p">)</span>

    <span class="n">tt</span> <span class="o">=</span> <span class="n">TsType</span><span class="p">(</span><span class="n">coldata</span><span class="o">.</span><span class="n">ts_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="n">TsType</span><span class="p">(</span><span class="s1">&#39;monthly&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">TemporalResolutionError</span><span class="p">(</span><span class="s1">&#39;Temporal resolution (</span><span class="si">{}</span><span class="s1">) is too low for &#39;</span>
                                      <span class="s1">&#39;web processing, need monthly or higher&#39;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tt</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">tt</span> <span class="o">&gt;</span> <span class="n">TsType</span><span class="p">(</span><span class="s1">&#39;daily&#39;</span><span class="p">):</span>
        <span class="c1"># resolution is higher than daily -&gt; convert to daily</span>
        <span class="n">coldata</span> <span class="o">=</span> <span class="n">_resample_time_coldata</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="n">colocation_settings</span><span class="p">)</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">TsType</span><span class="p">(</span><span class="s1">&#39;daily&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">to_ts_types</span><span class="p">:</span>
        <span class="n">tt_freq</span> <span class="o">=</span> <span class="n">TsType</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="n">tt_freq</span><span class="p">:</span> <span class="c1"># skip (coldata is in lower resolution)</span>
            <span class="c1">#data_arrs[freq] = None</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">tt</span> <span class="o">==</span> <span class="n">tt_freq</span><span class="p">:</span>
            <span class="n">data_arrs</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">coldata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">jsdate</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_jsdate</span><span class="p">(</span><span class="n">coldata</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">cd</span> <span class="o">=</span> <span class="n">_resample_time_coldata</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span>
                                        <span class="n">colocation_settings</span><span class="p">)</span>
            <span class="n">data_arrs</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">cd</span>
            <span class="n">jsdate</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_jsdate</span><span class="p">(</span><span class="n">cd</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">data_arrs</span><span class="p">,</span> <span class="n">jsdate</span><span class="p">)</span>

<div class="viewcode-block" id="compute_json_files_from_colocateddata"><a class="viewcode-back" href="../../../api.html#pyaerocom.web.helpers_evaluation_iface.compute_json_files_from_colocateddata">[docs]</a><span class="k">def</span> <span class="nf">compute_json_files_from_colocateddata</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">,</span>
                                          <span class="n">model_name</span><span class="p">,</span> <span class="n">use_weights</span><span class="p">,</span>
                                          <span class="n">colocation_settings</span><span class="p">,</span>
                                          <span class="n">vert_code</span><span class="p">,</span> <span class="n">out_dirs</span><span class="p">,</span>
                                          <span class="n">regions_json</span><span class="p">,</span>
                                          <span class="n">web_iface_name</span><span class="p">,</span>
                                          <span class="n">diurnal_only</span><span class="p">,</span>
                                          <span class="n">regions_how</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">zeros_to_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Creates all json files for one ColocatedData object</span>

<span class="sd">    ToDo</span>
<span class="sd">    ----</span>
<span class="sd">    Complete docstring</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">vert_code</span> <span class="o">==</span> <span class="s1">&#39;ModelLevel&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Coming soon...&#39;</span><span class="p">)</span>

    <span class="c1"># this will need to be figured out as soon as there is altitude</span>
    <span class="k">elif</span> <span class="s1">&#39;altitude&#39;</span> <span class="ow">in</span> <span class="n">coldata</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Cannot yet handle profile data&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="n">ColocatedData</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need ColocatedData object, got </span><span class="si">{}</span><span class="s1">&#39;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">coldata</span><span class="p">)))</span>

    <span class="k">elif</span> <span class="n">coldata</span><span class="o">.</span><span class="n">has_latlon_dims</span> <span class="ow">and</span> <span class="n">regions_how</span><span class="o">==</span><span class="s1">&#39;country&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Cannot yet apply country filtering for &#39;</span>
                                  <span class="s1">&#39;4D colocated data instances&#39;</span><span class="p">)</span>
    <span class="n">const</span><span class="o">.</span><span class="n">print_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing json files for </span><span class="si">{}</span><span class="s1"> vs. </span><span class="si">{}</span><span class="s1">&#39;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">obs_name</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">zeros_to_nan</span><span class="p">:</span>
        <span class="n">coldata</span> <span class="o">=</span> <span class="n">coldata</span><span class="o">.</span><span class="n">set_zeros_nan</span><span class="p">()</span>

    <span class="c1"># init some stuff</span>
    <span class="n">obs_var</span> <span class="o">=</span> <span class="n">coldata</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">model_var</span> <span class="o">=</span> <span class="n">coldata</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">meta_glob</span> <span class="o">=</span> <span class="n">_init_meta_glob</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span>
                                <span class="n">vert_code</span><span class="o">=</span><span class="n">vert_code</span><span class="p">,</span>
                                <span class="n">obs_name</span><span class="o">=</span><span class="n">obs_name</span><span class="p">,</span>
                                <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                                <span class="n">web_iface_name</span><span class="o">=</span><span class="n">web_iface_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">regions_how</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">regions_how</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>

    <span class="c1"># get region IDs</span>
    <span class="n">regions</span> <span class="o">=</span> <span class="n">init_regions_web</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="n">regions_how</span><span class="p">)</span>

    <span class="n">update_regions_json</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">regions_json</span><span class="p">)</span>

    <span class="n">region_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>

    <span class="n">use_country</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">regions_how</span> <span class="o">==</span> <span class="s1">&#39;country&#39;</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="n">data</span><span class="p">,</span> <span class="n">jsdate</span> <span class="o">=</span> <span class="n">_init_data_default_frequencies</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span>
                                                  <span class="n">colocation_settings</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">diurnal_only</span><span class="p">:</span>
        <span class="c1"># FIRST: process data for heatmap json file</span>
        <span class="n">hm_all</span> <span class="o">=</span> <span class="n">_process_heatmap_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">region_ids</span><span class="p">,</span> <span class="n">use_weights</span><span class="p">,</span>
                                        <span class="n">use_country</span><span class="o">=</span><span class="n">use_country</span><span class="p">,</span>
                                        <span class="n">meta_glob</span><span class="o">=</span><span class="n">meta_glob</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">hm_data</span> <span class="ow">in</span> <span class="n">hm_all</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;daily&#39;</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">HEATMAP_FILENAME_EVAL_IFACE_DAILY</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">HEATMAP_FILENAME_EVAL_IFACE_MONTHLY</span>

            <span class="n">hm_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dirs</span><span class="p">[</span><span class="s1">&#39;hm&#39;</span><span class="p">],</span> <span class="n">fname</span><span class="p">)</span>

            <span class="n">add_entry_heatmap_json</span><span class="p">(</span><span class="n">hm_file</span><span class="p">,</span> <span class="n">hm_data</span><span class="p">,</span> <span class="n">web_iface_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span>
                                    <span class="n">vert_code</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model_var</span><span class="p">)</span>

        <span class="n">ts_objs_regional</span> <span class="o">=</span> <span class="n">_process_regional_timeseries</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                                        <span class="n">jsdate</span><span class="p">,</span>
                                                        <span class="n">region_ids</span><span class="p">,</span>
                                                        <span class="n">regions_how</span><span class="p">,</span>
                                                        <span class="n">meta_glob</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ts_data</span> <span class="ow">in</span> <span class="n">ts_objs_regional</span><span class="p">:</span>
            <span class="c1">#writes json file</span>
            <span class="n">_write_stationdata_json</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">out_dirs</span><span class="p">)</span>

        <span class="p">(</span><span class="n">map_data</span><span class="p">,</span>
          <span class="n">scat_data</span><span class="p">,</span>
          <span class="n">ts_objs</span><span class="p">)</span> <span class="o">=</span> <span class="n">_process_sites</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">jsdate</span><span class="p">,</span>
                                    <span class="n">regions_how</span><span class="p">,</span>
                                    <span class="n">meta_glob</span><span class="o">=</span><span class="n">meta_glob</span><span class="p">)</span>

        <span class="n">dirs</span> <span class="o">=</span> <span class="n">out_dirs</span>

        <span class="n">map_name</span> <span class="o">=</span> <span class="n">get_json_mapname</span><span class="p">(</span><span class="n">web_iface_name</span><span class="p">,</span> <span class="n">obs_var</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span>
                                    <span class="n">model_var</span><span class="p">,</span> <span class="n">vert_code</span><span class="p">)</span>

        <span class="n">outfile_map</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirs</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">],</span> <span class="n">map_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile_map</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">simplejson</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">map_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ignore_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">outfile_scat</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirs</span><span class="p">[</span><span class="s1">&#39;scat&#39;</span><span class="p">],</span> <span class="n">map_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile_scat</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">simplejson</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">scat_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ignore_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ts_data</span> <span class="ow">in</span> <span class="n">ts_objs</span><span class="p">:</span>
            <span class="c1">#writes json file</span>
            <span class="n">_write_stationdata_json</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">out_dirs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">coldata</span><span class="o">.</span><span class="n">ts_type</span> <span class="o">==</span> <span class="s1">&#39;hourly&#39;</span><span class="p">:</span>
        <span class="n">ts_objs_weekly</span><span class="p">,</span><span class="n">ts_objs_weekly_reg</span> <span class="o">=</span> <span class="n">_process_sites_weekly_ts</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span><span class="n">regions_how</span><span class="p">,</span> <span class="n">region_ids</span><span class="p">,</span> <span class="n">meta_glob</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ts_data_weekly</span> <span class="ow">in</span> <span class="n">ts_objs_weekly</span><span class="p">:</span>
            <span class="c1">#writes json file</span>
            <span class="n">_write_diurnal_week_stationdata_json</span><span class="p">(</span><span class="n">ts_data_weekly</span><span class="p">,</span> <span class="n">out_dirs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ts_objs_weekly_reg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ts_data_weekly_reg</span> <span class="ow">in</span> <span class="n">ts_objs_weekly_reg</span><span class="p">:</span>
                <span class="c1">#writes json file</span>
                <span class="n">_write_diurnal_week_stationdata_json</span><span class="p">(</span><span class="n">ts_data_weekly_reg</span><span class="p">,</span> <span class="n">out_dirs</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyaerocom</span> <span class="k">as</span> <span class="nn">pya</span>
    <span class="n">stp</span> <span class="o">=</span> <span class="n">pya</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">AerocomEvaluation</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>

    <span class="n">colfile</span> <span class="o">=</span> <span class="s1">&#39;/home/jonasg/github/aerocom_evaluation/coldata/PIII-optics2019-P/AEROCOM-MEDIAN_AP3-CTRL/od550aer_REF-AeronetSun_MOD-AEROCOM-MEDIAN_20100101_20101231_monthly_WORLD-noMOUNTAINS.nc&#39;</span>
    <span class="c1">#colfile = &#39;/home/jonasg/github/aerocom_evaluation/coldata/PIII-optics2019-P/AEROCOM-MEDIAN_AP3-CTRL/od550aer_REF-AATSR4.3-SU_MOD-AEROCOM-MEDIAN_20100101_20101231_monthly_WORLD-noMOUNTAINS.nc&#39;</span>

    <span class="n">coldata</span> <span class="o">=</span> <span class="n">ColocatedData</span><span class="p">(</span><span class="n">colfile</span><span class="p">)</span>
    <span class="n">out_dirs</span> <span class="o">=</span> <span class="n">stp</span><span class="o">.</span><span class="n">out_dirs</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">coldata</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;data_source&#39;</span><span class="p">]</span>

    <span class="n">rgf</span> <span class="o">=</span> <span class="n">stp</span><span class="o">.</span><span class="n">regions_file</span>
    <span class="n">compute_json_files_from_colocateddata</span><span class="p">(</span><span class="n">coldata</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span>
                                          <span class="n">mod</span><span class="p">,</span>
                                          <span class="n">use_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">colocation_settings</span><span class="o">=</span><span class="n">stp</span><span class="o">.</span><span class="n">colocation_settings</span><span class="p">,</span>
                                          <span class="n">vert_code</span><span class="o">=</span><span class="s1">&#39;Column&#39;</span><span class="p">,</span>
                                          <span class="n">out_dirs</span><span class="o">=</span><span class="n">out_dirs</span><span class="p">,</span>
                                          <span class="n">regions_how</span><span class="o">=</span><span class="s1">&#39;country&#39;</span><span class="p">,</span>
                                          <span class="n">regions_json</span><span class="o">=</span><span class="n">rgf</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, MET Norway

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>