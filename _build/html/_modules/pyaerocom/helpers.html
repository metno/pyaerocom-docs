

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyaerocom.helpers &mdash; pyaerocom  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="pyaerocom  documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> pyaerocom
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">NEWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#about">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#aerocom">AeroCom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#website-and-code-documentation">Website and code documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#requirements">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#installation-of-pyaerocom">Installation of pyaerocom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#access-to-users-database">Access to users database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#getting-started">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials (Jupyter Notebooks)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html#further-tutorials-in-depth">Further tutorials (in-depth)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_testsuite.html">Tests (for developers)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_files.html">Configuration files</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyaerocom</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pyaerocom.helpers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyaerocom.helpers</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">General helper methods for the pyaerocom library.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">iris</span>
<span class="kn">from</span> <span class="nn">iris</span> <span class="k">import</span> <span class="n">coord_categorisation</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xray</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pyaerocom.exceptions</span> <span class="k">import</span> <span class="p">(</span><span class="n">LongitudeConstraintError</span><span class="p">,</span> 
                                  <span class="n">DataCoverageError</span><span class="p">,</span> <span class="n">MetaDataError</span><span class="p">,</span>
                                  <span class="n">DataDimensionError</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyaerocom</span> <span class="k">import</span> <span class="n">logger</span><span class="p">,</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">cf_units</span> <span class="k">import</span> <span class="n">Unit</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">MINYEAR</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span>

<span class="c1"># The following import was removed and the information about available unit </span>
<span class="c1"># strings was copied from the netCDF4 module directly here</span>
<span class="c1"># from netCDF4 import (microsec_units, millisec_units, sec_units, min_units,</span>
<span class="c1">#                     hr_units, day_units)</span>
<span class="c1"># from netCDF4._netCDF4 import _dateparse</span>
<span class="n">microsec_units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;microseconds&#39;</span><span class="p">,</span> <span class="s1">&#39;microsecond&#39;</span><span class="p">,</span> <span class="s1">&#39;microsec&#39;</span><span class="p">,</span> <span class="s1">&#39;microsecs&#39;</span><span class="p">]</span>
<span class="n">millisec_units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;milliseconds&#39;</span><span class="p">,</span> <span class="s1">&#39;millisecond&#39;</span><span class="p">,</span> <span class="s1">&#39;millisec&#39;</span><span class="p">,</span> <span class="s1">&#39;millisecs&#39;</span><span class="p">]</span>
<span class="n">sec_units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="s1">&#39;seconds&#39;</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;secs&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span>
<span class="n">min_units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="s1">&#39;minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;mins&#39;</span><span class="p">]</span>
<span class="n">hr_units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;hours&#39;</span><span class="p">,</span> <span class="s1">&#39;hr&#39;</span><span class="p">,</span> <span class="s1">&#39;hrs&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">]</span>
<span class="n">day_units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]</span>

<span class="c1">#</span>
<span class="c1"># Start of the gregorian calendar</span>
<span class="c1"># adapted from here: https://github.com/Unidata/cftime/blob/master/cftime/_cftime.pyx   </span>
<span class="n">GREGORIAN_BASE</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1582</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

<span class="n">_STR_TO_IRIS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">count</span>       <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">COUNT</span><span class="p">,</span>
                    <span class="n">gmean</span>       <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">GMEAN</span><span class="p">,</span> 
                    <span class="n">hmean</span>       <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">HMEAN</span><span class="p">,</span>
                    <span class="nb">max</span>         <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">MAX</span><span class="p">,</span> 
                    <span class="n">mean</span>        <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">MEAN</span><span class="p">,</span>
                    <span class="n">median</span>      <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">MEDIAN</span><span class="p">,</span>
                    <span class="nb">sum</span>         <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span>
                    <span class="n">nearest</span>     <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Nearest</span><span class="p">,</span>
                    <span class="n">linear</span>      <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">,</span>
                    <span class="n">areaweighted</span><span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">AreaWeighted</span><span class="p">)</span>

<span class="n">IRIS_AGGREGATORS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hourly&#39;</span>    <span class="p">:</span>   <span class="n">coord_categorisation</span><span class="o">.</span><span class="n">add_hour</span><span class="p">,</span>
                    <span class="s1">&#39;daily&#39;</span>     <span class="p">:</span>   <span class="n">coord_categorisation</span><span class="o">.</span><span class="n">add_day_of_year</span><span class="p">,</span>
                    <span class="s1">&#39;monthly&#39;</span>   <span class="p">:</span>   <span class="n">coord_categorisation</span><span class="o">.</span><span class="n">add_month_number</span><span class="p">,</span>
                    <span class="s1">&#39;yearly&#39;</span>    <span class="p">:</span>   <span class="n">coord_categorisation</span><span class="o">.</span><span class="n">add_year</span><span class="p">}</span> 

<span class="c1"># some helper dictionaries for conversion of temporal resolution</span>
<span class="n">TS_TYPE_TO_PANDAS_FREQ</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hourly&#39;</span>  <span class="p">:</span>   <span class="s1">&#39;H&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;3hourly&#39;</span> <span class="p">:</span>   <span class="s1">&#39;3H&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;daily&#39;</span>   <span class="p">:</span>   <span class="s1">&#39;D&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;monthly&#39;</span> <span class="p">:</span>   <span class="s1">&#39;MS&#39;</span><span class="p">,</span> <span class="c1">#Month start !</span>
                          <span class="s1">&#39;yearly&#39;</span>  <span class="p">:</span>   <span class="s1">&#39;AS&#39;</span><span class="p">}</span>

<span class="n">PANDAS_RESAMPLE_OFFSETS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AS&#39;</span> <span class="p">:</span> <span class="s1">&#39;6M&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;MS&#39;</span> <span class="p">:</span> <span class="s1">&#39;14D&#39;</span><span class="p">}</span>

<span class="n">PANDAS_FREQ_TO_TS_TYPE</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">TS_TYPE_TO_PANDAS_FREQ</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># frequency strings </span>
<span class="n">TS_TYPE_TO_NUMPY_FREQ</span> <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;hourly&#39;</span>  <span class="p">:</span>   <span class="s1">&#39;h&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;3hourly&#39;</span> <span class="p">:</span>   <span class="s1">&#39;3h&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;daily&#39;</span>   <span class="p">:</span>   <span class="s1">&#39;D&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;monthly&#39;</span> <span class="p">:</span>   <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="c1">#Month start !</span>
                          <span class="s1">&#39;yearly&#39;</span>  <span class="p">:</span>   <span class="s1">&#39;Y&#39;</span><span class="p">}</span>

<span class="n">NUMPY_FREQ_TO_TS_TYPE</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">TS_TYPE_TO_NUMPY_FREQ</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># conversion of datetime-like objects for given temporal resolutions (can, e.g.</span>
<span class="c1"># be used in plotting methods)</span>
<span class="n">TS_TYPE_DATETIME_CONV</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span>       <span class="p">:</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">.%m.%Y&#39;</span><span class="p">,</span> <span class="c1">#Default</span>
                         <span class="s1">&#39;hourly&#39;</span>   <span class="p">:</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">.%m.%Y&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;3hourly&#39;</span>  <span class="p">:</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">.%m.%Y&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;daily&#39;</span>    <span class="p">:</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">.%m.%Y&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;monthly&#39;</span>  <span class="p">:</span> <span class="s1">&#39;%b %Y&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;yearly&#39;</span>   <span class="p">:</span> <span class="s1">&#39;%Y&#39;</span><span class="p">}</span>

<span class="n">NUM_KEYS_META</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;altitude&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="get_lowest_resolution"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.get_lowest_resolution">[docs]</a><span class="k">def</span> <span class="nf">get_lowest_resolution</span><span class="p">(</span><span class="n">ts_type</span><span class="p">,</span> <span class="o">*</span><span class="n">ts_types</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the lowest resolution from several ts_type codes</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ts_type : str</span>
<span class="sd">        first ts_type</span>
<span class="sd">    *ts_types</span>
<span class="sd">        one or more additional ts_type codes</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        the ts_type that corresponds to the lowest resolution</span>
<span class="sd">        </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        if one of the input ts_type codes is not supported</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_ts_types</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">GRID_IO</span><span class="o">.</span><span class="n">TS_TYPES</span>
    <span class="n">lowest</span> <span class="o">=</span> <span class="n">ts_type</span>
    <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">ts_types</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">all_ts_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input, only valid ts_type codes are &#39;</span>
                             <span class="s1">&#39;supported: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">all_ts_types</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">all_ts_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lowest</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">all_ts_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">freq</span><span class="p">):</span>
            <span class="n">lowest</span> <span class="o">=</span> <span class="n">freq</span>
    <span class="k">return</span> <span class="n">lowest</span></div>

<div class="viewcode-block" id="isnumeric"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.isnumeric">[docs]</a><span class="k">def</span> <span class="nf">isnumeric</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if input value is numeric</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    val</span>
<span class="sd">        input value to be checked</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool </span>
<span class="sd">        True, if input value corresponds to a range, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numbers</span> <span class="k">import</span> <span class="n">Number</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>
    
<div class="viewcode-block" id="isrange"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.isrange">[docs]</a><span class="k">def</span> <span class="nf">isrange</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if input value corresponds to a range</span>
<span class="sd">    </span>
<span class="sd">    Checks if input is list, or array or tuple with 2 entries, or alternatively</span>
<span class="sd">    a slice that has defined start and stop and has set step to None.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    No check is performed, whether first entry is smaller than second entry if</span>
<span class="sd">    all requirements for a range are fulfilled.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    val</span>
<span class="sd">        input value to be checked</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool </span>
<span class="sd">        True, if input value corresponds to a range, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>
        
<div class="viewcode-block" id="merge_station_data"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.merge_station_data">[docs]</a><span class="k">def</span> <span class="nf">merge_station_data</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">pref_attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                       <span class="n">sort_by_largest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_missing_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">add_meta_keys</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Merge multiple StationData objects (from one station) into one instance</span>
<span class="sd">    </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    - all input :class:`StationData` objects need to have same attributes\</span>
<span class="sd">       ``station_name``, ``latitude``, ``longitude`` and ``altitude``</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stats : list</span>
<span class="sd">        list containing :class:`StationData` objects (note: all of these </span>
<span class="sd">        objects must contain variable data for the specified input variable)</span>
<span class="sd">    var_name : str</span>
<span class="sd">        data variable name that is to be merged</span>
<span class="sd">    pref_attr </span>
<span class="sd">        optional argument that may be used to specify a metadata attribute</span>
<span class="sd">        that is available in all input :class:`StationData` objects and that</span>
<span class="sd">        is used to order the input stations by relevance. The associated values</span>
<span class="sd">        of this attribute need to be sortable (e.g. revision_date). This is </span>
<span class="sd">        only relevant in case overlaps occur. If unspecified the relevance of </span>
<span class="sd">        the stations is sorted based on the length of the associated data </span>
<span class="sd">        arrays.</span>
<span class="sd">    sort_by_largest : bool</span>
<span class="sd">        if True, the result from the sorting is inverted. E.g. if </span>
<span class="sd">        ``pref_attr`` is unspecified, then the stations will be sorted based on</span>
<span class="sd">        the length of the data vectors, starting with the shortest, ending with</span>
<span class="sd">        the longest. This sorting result will then be inverted, if </span>
<span class="sd">        ``sort_by_largest=True``, so that the longest time series get&#39;s highest</span>
<span class="sd">        importance. If, e.g. ``pref_attr=&#39;revision_date&#39;``, then the stations </span>
<span class="sd">        are sorted by the associated revision date value, starting with the </span>
<span class="sd">        earliest, ending with the latest (which will also be inverted if </span>
<span class="sd">        this argument is set to True)</span>
<span class="sd">    fill_missing_nan : bool</span>
<span class="sd">        if True, the resulting time series is filled with NaNs. NOTE: this </span>
<span class="sd">        requires that information about the temporal resolution (ts_type) of</span>
<span class="sd">        the data is available in each of the StationData objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Merging of multivar data not yet possible&#39;</span><span class="p">)</span>
        <span class="n">var_name</span> <span class="o">=</span> <span class="n">var_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># make sure the data is provided as pandas.Series object</span>
    <span class="n">is_3d</span><span class="p">,</span> <span class="n">has_errs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DataCoverageError</span><span class="p">(</span><span class="s1">&#39;All input station must contain </span><span class="si">{}</span><span class="s1"> data&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">pref_attr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pref_attr</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MetaDataError</span><span class="p">(</span><span class="s1">&#39;Cannot sort station relevance by attribute </span><span class="si">{}</span><span class="s1">. &#39;</span>
                                <span class="s1">&#39;At least one of the input stations does not &#39;</span>
                                <span class="s1">&#39;contain this attribute&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pref_attr</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="n">var_name</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stat</span><span class="o">.</span><span class="n">_to_ts_helper</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data needs to be provided as pandas Series in &#39;</span>
                                 <span class="s1">&#39;individual station data objects. Attempted to&#39;</span>
                                 <span class="s1">&#39;convert but failed with the following &#39;</span>
                                 <span class="s1">&#39;exception: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">fill_missing_nan</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stat</span><span class="o">.</span><span class="n">get_var_ts_type</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">MetaDataError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MetaDataError</span><span class="p">(</span><span class="s1">&#39;Cannot merge StationData objects: one or &#39;</span>
                                    <span class="s1">&#39;more of the provided objects does not &#39;</span>
                                    <span class="s1">&#39;provide information about the ts_type of &#39;</span>
                                    <span class="s1">&#39;the </span><span class="si">{}</span><span class="s1"> data, which is required when input &#39;</span>
                                    <span class="s1">&#39;arg. fill_missing_nan is True.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">check_if_3d</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
            <span class="n">is_3d</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">is_3d</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Merge error: some of the input stations contain &#39;</span>
                             <span class="s1">&#39;altitude info (suggesting profile data), others &#39;</span>
                             <span class="s1">&#39;not.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">stat</span><span class="o">.</span><span class="n">data_err</span><span class="p">:</span>
            <span class="n">has_errs</span> <span class="o">=</span> <span class="kc">True</span>
            
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_3d</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pref_attr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="n">pref_attr</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()))</span>
        
        <span class="k">if</span> <span class="n">sort_by_largest</span><span class="p">:</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># remove first station from the list</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stats</span><span class="p">):</span>    
            <span class="n">merged</span><span class="o">.</span><span class="n">merge_other</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="o">**</span><span class="n">add_meta_keys</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pyaerocom</span> <span class="k">import</span> <span class="n">const</span>
        <span class="kn">from</span> <span class="nn">xarray</span> <span class="k">import</span> <span class="n">DataArray</span>
        <span class="n">dtime</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">_t</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">_t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;So far, merging of profile data &#39;</span>
                                          <span class="s1">&#39;requires that profile values are &#39;</span>
                                          <span class="s1">&#39;sampled at the same time&#39;</span><span class="p">)</span>
            <span class="n">dtime</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">tidx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span>
        
        <span class="c1"># AeroCom default vertical grid</span>
        <span class="n">vert_grid</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">make_default_vert_grid</span><span class="p">()</span>
        <span class="n">_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">vert_grid</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tidx</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="n">has_errs</span><span class="p">:</span>
            <span class="n">_data_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">vert_grid</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tidx</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stats</span><span class="p">):</span>
            <span class="c1">#print(stat[var_name].values)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">merged</span> <span class="o">=</span> <span class="n">stat</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">merge_meta_same_station</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="o">**</span><span class="n">add_meta_keys</span><span class="p">)</span>

            <span class="n">_data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">vert_grid</span><span class="p">,</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;altitude&#39;</span><span class="p">],</span> 
                                    <span class="n">stat</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">has_errs</span><span class="p">:</span>
                <span class="n">_data_err</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">vert_grid</span><span class="p">,</span> 
                                            <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;altitude&#39;</span><span class="p">],</span> 
                                            <span class="n">stat</span><span class="o">.</span><span class="n">data_err</span><span class="p">[</span><span class="n">var_name</span><span class="p">])</span>
        <span class="n">_coords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span>     <span class="p">:</span> <span class="n">tidx</span><span class="p">,</span>
                   <span class="s1">&#39;altitude&#39;</span> <span class="p">:</span> <span class="n">vert_grid</span><span class="p">}</span>
        
        <span class="n">d</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">_data</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">_coords</span><span class="p">,</span> 
                      <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;altitude&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">var_name</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="n">merged</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">dtime</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">time</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">altitude</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">altitude</span>
    
    <span class="k">if</span> <span class="n">fill_missing_nan</span><span class="p">:</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">insert_nans_timeseries</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
    <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;stat_merge_pref_attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pref_attr</span>
    <span class="k">return</span> <span class="n">merged</span></div>

<span class="k">def</span> <span class="nf">_get_pandas_freq_and_loffset</span><span class="p">(</span><span class="n">freq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to convert resampling info&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">TS_TYPE_TO_PANDAS_FREQ</span><span class="p">:</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">TS_TYPE_TO_PANDAS_FREQ</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span>
    <span class="n">loffset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">PANDAS_RESAMPLE_OFFSETS</span><span class="p">:</span>
        <span class="n">loffset</span> <span class="o">=</span> <span class="n">PANDAS_RESAMPLE_OFFSETS</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">loffset</span><span class="p">)</span>

<div class="viewcode-block" id="resample_timeseries"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.resample_timeseries">[docs]</a><span class="k">def</span> <span class="nf">resample_timeseries</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">min_num_obs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resample a timeseries (pandas.Series)</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : Series</span>
<span class="sd">        time series instance</span>
<span class="sd">    freq : str</span>
<span class="sd">        new temporal resolution (can be pandas freq. string, or pyaerocom</span>
<span class="sd">        ts_type)</span>
<span class="sd">    how : str</span>
<span class="sd">        choose from mean or median</span>
<span class="sd">    min_num_obs : :obj:`int`, optional</span>
<span class="sd">        minimum number of observations required per period (when downsampling).</span>
<span class="sd">        E.g. if input is in daily resolution and freq is monthly and </span>
<span class="sd">        min_num_obs is 10, then all months that have less than 10 days of data</span>
<span class="sd">        are set to nan.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Series</span>
<span class="sd">        resampled time series object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">freq</span><span class="p">,</span> <span class="n">loffset</span> <span class="o">=</span> <span class="n">_get_pandas_freq_and_loffset</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>    
    <span class="n">resampler</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">loffset</span><span class="o">=</span><span class="n">loffset</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">min_num_obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">resampler</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">how</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">resampler</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">how</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="n">how</span><span class="p">][</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_num_obs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">how</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="resample_time_dataarray"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.resample_time_dataarray">[docs]</a><span class="k">def</span> <span class="nf">resample_time_dataarray</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">min_num_obs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resample the time dimension of a :class:`xarray.DataArray`</span>
<span class="sd">    </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The dataarray must have a dimension coordinate named &quot;time&quot;</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr : DataArray</span>
<span class="sd">        data array to be resampled</span>
<span class="sd">    freq : str</span>
<span class="sd">        new temporal resolution (can be pandas freq. string, or pyaerocom</span>
<span class="sd">        ts_type)</span>
<span class="sd">    how : str</span>
<span class="sd">        choose from mean or median</span>
<span class="sd">    min_num_obs : :obj:`int`, optional</span>
<span class="sd">        minimum number of observations required per period (when downsampling).</span>
<span class="sd">        E.g. if input is in daily resolution and freq is monthly and </span>
<span class="sd">        min_num_obs is 10, then all months that have less than 10 days of data</span>
<span class="sd">        are set to nan.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DataArray</span>
<span class="sd">        resampled data array object</span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IOError</span>
<span class="sd">        if data input `arr` is not an instance of :class:`DataArray`</span>
<span class="sd">    DataDimensionError</span>
<span class="sd">        if time dimension is not available in dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">xray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Invalid input for arr: need DataArray, got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">arr</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DataDimensionError</span><span class="p">(</span><span class="s1">&#39;Cannot resample time: input DataArray has &#39;</span>
                                 <span class="s1">&#39;no time dimension&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">min_num_obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Coming soon...&#39;</span><span class="p">)</span>
    <span class="n">freq</span><span class="p">,</span> <span class="n">loffset</span> <span class="o">=</span> <span class="n">_get_pandas_freq_and_loffset</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">loffset</span><span class="o">=</span><span class="n">loffset</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="unit_conversion_fac"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.unit_conversion_fac">[docs]</a><span class="k">def</span> <span class="nf">unit_conversion_fac</span><span class="p">(</span><span class="n">from_unit</span><span class="p">,</span> <span class="n">to_unit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns multiplicative unit conversion factor for input units</span>
<span class="sd">    </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Input must be either instances of :class:`cf_units.Unit` class or string.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    from_unit : :obj:`cf_units.Unit`, or :obj:`str`</span>
<span class="sd">        unit to be converted</span>
<span class="sd">    to_unit : :obj:`cf_units.Unit`, or :obj:`str`</span>
<span class="sd">        final unit</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        multiplicative conversion factor</span>
<span class="sd">        </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        if units cannot be converted into each other using cf_units package</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">from_unit</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">from_unit</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span><span class="n">from_unit</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">from_unit</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">to_unit</span><span class="p">)</span>    
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pyaerocom.exceptions</span> <span class="k">import</span> <span class="n">UnitConversionError</span>
        <span class="k">raise</span> <span class="n">UnitConversionError</span><span class="p">(</span><span class="s1">&#39;Failed to convert unit from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span>
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">from_unit</span><span class="p">,</span> <span class="n">to_unit</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="same_meta_dict"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.same_meta_dict">[docs]</a><span class="k">def</span> <span class="nf">same_meta_dict</span><span class="p">(</span><span class="n">meta1</span><span class="p">,</span> <span class="n">meta2</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PI&#39;</span><span class="p">],</span> 
                   <span class="n">num_keys</span><span class="o">=</span><span class="n">NUM_KEYS_META</span><span class="p">,</span> <span class="n">num_rtol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compare meta dictionaries</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    meta1 : dict</span>
<span class="sd">        meta dictionary that is to be compared with ``meta2``</span>
<span class="sd">    meta2 : dict</span>
<span class="sd">        meta dictionary that is to be compared with ``meta1``</span>
<span class="sd">    ignore_keys : list</span>
<span class="sd">        list containing meta keys that are supposed to be ignored</span>
<span class="sd">    num_keys : keys that contain numerical values</span>
<span class="sd">    num_rtol : float</span>
<span class="sd">        relative tolerance level for comparison of numerical values</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool </span>
<span class="sd">        True, if dictionaries are the same, else False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">meta1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">meta2</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">meta1</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ignore_keys</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">num_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">meta2</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="n">num_rtol</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">same_meta_dict</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">meta2</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span> <span class="o">==</span> <span class="n">meta2</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>
            
<div class="viewcode-block" id="str_to_iris"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.str_to_iris">[docs]</a><span class="k">def</span> <span class="nf">str_to_iris</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mapping function that converts strings into iris analysis objects</span>
<span class="sd">    </span>
<span class="sd">    Please see dictionary ``_STR_TO_IRIS`` in this module for valid definitions</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : str</span>
<span class="sd">        key of :attr:`_STR_TO_IRIS` dictionary</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obj</span>
<span class="sd">        corresponding iris analysis object (e.g. Aggregator, method)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_STR_TO_IRIS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No iris.analysis object available for key </span><span class="si">%s</span><span class="s2">, please &quot;</span>
                       <span class="s2">&quot;choose from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_STR_TO_IRIS</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">_STR_TO_IRIS</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">val</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span></div>

<div class="viewcode-block" id="to_pandas_timestamp"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.to_pandas_timestamp">[docs]</a><span class="k">def</span> <span class="nf">to_pandas_timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert input to instance of :class:`pandas.Timestamp`&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">numval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">numval</span> <span class="o">&lt;=</span> <span class="mi">10000</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not infer valid year from numerical &#39;</span>
                                 <span class="s1">&#39;time input&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">numval</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Failed to convert </span><span class="si">{}</span><span class="s1"> to Timestamp: </span><span class="si">{}</span><span class="s1">&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>    </div>
    
<div class="viewcode-block" id="to_datetime64"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.to_datetime64">[docs]</a><span class="k">def</span> <span class="nf">to_datetime64</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert input value to numpy.datetime64 </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value</span>
<span class="sd">        input value that is supposed to be converted, needs to be either str, </span>
<span class="sd">        datetime.datetime, pandas.Timestamp or an integer specifying the </span>
<span class="sd">        desired year.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    datetime64</span>
<span class="sd">        input timestamp converted to datetime64</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">to_datetime64</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Failed to convert </span><span class="si">{}</span><span class="s1"> to datetime64 object&#39;</span>
                             <span class="s1">&#39;Error: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span></div>
  
<div class="viewcode-block" id="is_year"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.is_year">[docs]</a><span class="k">def</span> <span class="nf">is_year</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="o">-</span><span class="mi">2000</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">raise</span> <span class="ne">Exception</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>
    
<div class="viewcode-block" id="start_stop"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.start_stop">[docs]</a><span class="k">def</span> <span class="nf">start_stop</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-12-31 23:59:59&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span></div>

<div class="viewcode-block" id="datetime2str"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.datetime2str">[docs]</a><span class="k">def</span> <span class="nf">datetime2str</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">ts_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">conv</span> <span class="o">=</span> <span class="n">TS_TYPE_DATETIME_CONV</span><span class="p">[</span><span class="n">ts_type</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">is_year</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">time</span></div>

<div class="viewcode-block" id="start_stop_str"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.start_stop_str">[docs]</a><span class="k">def</span> <span class="nf">start_stop_str</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ts_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="n">conv</span> <span class="o">=</span> <span class="n">TS_TYPE_DATETIME_CONV</span><span class="p">[</span><span class="n">ts_type</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">is_year</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="ow">and</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">start_stop</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
    <span class="n">start_str</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
    <span class="n">stop_str</span> <span class="o">=</span> <span class="n">stop</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stop_str</span> <span class="o">!=</span> <span class="n">start_str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_str</span><span class="p">,</span> <span class="n">stop_str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">start_str</span></div>

<div class="viewcode-block" id="start_stop_from_year"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.start_stop_from_year">[docs]</a><span class="k">def</span> <span class="nf">start_stop_from_year</span><span class="p">(</span><span class="n">year</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create start / stop timestamp from year</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    year : int</span>
<span class="sd">        the year for which start / stop is to be instantiated</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        2-element tuple containing</span>
<span class="sd">        </span>
<span class="sd">        - :obj:`pandas.Timestamp`: start timestamp</span>
<span class="sd">        - :obj:`pandas.Timestamp`: end timestamp</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-12-31 23:59:59&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="to_datestring_YYYYMMDD"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.to_datestring_YYYYMMDD">[docs]</a><span class="k">def</span> <span class="nf">to_datestring_YYYYMMDD</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert input time to string with format YYYYMMDD</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value</span>
<span class="sd">        input time, may be string, datetime, numpy.datetime64 or </span>
<span class="sd">        pandas.Timestamp</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        input formatted to string YYYYMMDD</span>
<span class="sd">        </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        if input is not supported</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Input is already string containing 8 chars. Assuming it &#39;</span>
                    <span class="s1">&#39;is in the right format and returning unchanged&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">to_pandas_timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input, need str, datetime, numpy.datetime64 &#39;</span>
                         <span class="s1">&#39;or pandas.Timestamp. Error: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span></div>
    
<div class="viewcode-block" id="cftime_to_datetime64"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.cftime_to_datetime64">[docs]</a><span class="k">def</span> <span class="nf">cftime_to_datetime64</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">cfunit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert numerical timestamps with epoch to numpy datetime64</span>
<span class="sd">    </span>
<span class="sd">    This method was designed to enhance the performance of datetime conversions</span>
<span class="sd">    and is based on the corresponding information provided in the cftime </span>
<span class="sd">    package (`see here &lt;https://github.com/Unidata/cftime/blob/master/cftime/</span>
<span class="sd">    _cftime.pyx&gt;`__). Particularly, this object does, what the :func:`num2date` </span>
<span class="sd">    therein does, but faster, in case the time stamps are not defined on a non</span>
<span class="sd">    standard calendar.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    times : :obj:`list` or :obj:`ndarray` or :obj:`iris.coords.DimCoord`</span>
<span class="sd">        array containing numerical time stamps (relative to basedate of </span>
<span class="sd">        ``cfunit``). Can also be a single number.</span>
<span class="sd">    cfunit : :obj:`str` or :obj:`Unit`, optional</span>
<span class="sd">        CF unit string (e.g. day since 2018-01-01 00:00:00.00000000 UTC) or</span>
<span class="sd">        unit. Required if `times` is not an instance of </span>
<span class="sd">        :class:`iris.coords.DimCoord`</span>
<span class="sd">    calendar : :obj:`str`, optional</span>
<span class="sd">        string specifying calendar (only required if ``cfunit`` is of type</span>
<span class="sd">        ``str``).</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        numpy array containing timestamps as datetime64 objects</span>
<span class="sd">        </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        if cfunit is ``str`` and calendar is not provided or invalid, or if </span>
<span class="sd">        the cfunit string is invalid</span>
<span class="sd">        </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; cfunit_str = &#39;day since 2018-01-01 00:00:00.00000000 UTC&#39;</span>
<span class="sd">    &gt;&gt;&gt; cftime_to_datetime64(10, cfunit_str, &quot;gregorian&quot;)</span>
<span class="sd">    array([&#39;2018-01-11T00:00:00.000000&#39;], dtype=&#39;datetime64[us]&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">DimCoord</span><span class="p">):</span> <span class="c1">#special case</span>
        <span class="n">times</span><span class="p">,</span> <span class="n">cfunit</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">times</span><span class="o">.</span><span class="n">units</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">times</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfunit</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">calendar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Require specification of calendar for &quot;</span>
                             <span class="s2">&quot;conversion into datetime64 objects&quot;</span><span class="p">)</span>
        <span class="n">cfunit</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span><span class="n">cfunit</span><span class="p">,</span> <span class="n">calendar</span><span class="p">)</span> <span class="c1">#raises Error if calendar is invalid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfunit</span><span class="p">,</span> <span class="n">Unit</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please provide cfunit either as instance of class &quot;</span>
                         <span class="s2">&quot;cf_units.Unit or as a string&quot;</span><span class="p">)</span>
    <span class="n">calendar</span> <span class="o">=</span> <span class="n">cfunit</span><span class="o">.</span><span class="n">calendar</span>
    <span class="n">basedate</span> <span class="o">=</span> <span class="n">cfunit</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;proleptic_gregorian&#39;</span> <span class="ow">and</span> <span class="n">basedate</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">MINYEAR</span><span class="p">)</span> <span class="ow">or</span> 
        <span class="p">(</span><span class="n">calendar</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gregorian&#39;</span><span class="p">,</span><span class="s1">&#39;standard&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">basedate</span> <span class="o">&gt;</span> <span class="n">GREGORIAN_BASE</span><span class="p">)):</span>
        <span class="c1"># NOTE: changed on 9 July 2018 by jgliss due to error (kernel died)</span>
        <span class="c1"># after update of dependencies (cf_units). Attribute name does not</span>
        <span class="c1"># work anymore...</span>
        <span class="n">cfu_str</span> <span class="o">=</span> <span class="n">cfunit</span><span class="o">.</span><span class="n">origin</span> <span class="c1">#cfunit.name</span>
        
        <span class="n">res</span> <span class="o">=</span> <span class="n">cfu_str</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">microsec_units</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="s2">&quot;us&quot;</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">millisec_units</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="s2">&quot;ms&quot;</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">sec_units</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">min_units</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">hr_units</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="s2">&quot;h&quot;</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">day_units</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="s2">&quot;D&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unsupported time units&#39;</span><span class="p">)</span>
        
        <span class="n">basedate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">basedate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">basedate</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;timedelta64[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span><span class="n">tstr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cfunit</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">times</span><span class="p">)])</span></div>

<div class="viewcode-block" id="get_constraint"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.get_constraint">[docs]</a><span class="k">def</span> <span class="nf">get_constraint</span><span class="p">(</span><span class="n">lon_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                   <span class="n">time_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">meridian_centre</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that creates an :class:`iris.Constraint` based on input</span>
<span class="sd">    </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Please be aware of the definition of the longitudes in your data when </span>
<span class="sd">    cropping within the longitude dimension. The longitudes in your data may be </span>
<span class="sd">    defined either from **-180 &lt;= lon &lt;= 180** (pyaerocom standard) or from </span>
<span class="sd">    **0 &lt;= lon &lt;= 360**. In the former case (-180 -&gt; 180) you can leave the </span>
<span class="sd">    additional input parameter ``meridian_centre=True`` (default). </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lon_range : :obj:`tuple`, optional</span>
<span class="sd">        2-element tuple containing longitude range for cropping</span>
<span class="sd">        Example input to crop around meridian: `lon_range=(-30, 30)`</span>
<span class="sd">    lat_range : :obj:`tuple`, optional</span>
<span class="sd">        2-element tuple containing latitude range for cropping. </span>
<span class="sd">    time_range : :obj:`tuple`, optional</span>
<span class="sd">        2-element tuple containing time range for cropping. Allowed data</span>
<span class="sd">        types for specifying the times are </span>
<span class="sd">        </span>
<span class="sd">            1. a combination of 2 :class:`pandas.Timestamp` instances or </span>
<span class="sd">            2. a combination of two strings that can be directly converted\</span>
<span class="sd">            into :class:`pandas.Timestamp` instances (e.g.\</span>
<span class="sd">            `time_range=(&quot;2010-1-1&quot;, &quot;2012-1-1&quot;)`) or</span>
<span class="sd">            3. directly a combination of indices (:obj:`int`). </span>
<span class="sd">    meridian_centre : bool</span>
<span class="sd">        specifies the coordinate definition range of longitude array. If True, </span>
<span class="sd">        then -180 -&gt; 180 is assumed, else 0 -&gt; 360</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.Constraint</span>
<span class="sd">        the combined constraint from all valid input parameters</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    The following example shows how to crop over the meridian</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; from pyaerocom.helpers import get_constraint</span>
<span class="sd">    &gt;&gt;&gt; from pyaerocom.io.fileconventions import FileConventionRead</span>
<span class="sd">    &gt;&gt;&gt; from iris import load</span>
<span class="sd">    &gt;&gt;&gt; from pyaerocom.io.testfiles import get</span>
<span class="sd">    &gt;&gt;&gt; files = get()</span>
<span class="sd">    &gt;&gt;&gt; fname = files[&#39;models&#39;][&#39;aatsr_su_v4.3&#39;]</span>
<span class="sd">    &gt;&gt;&gt; convention = FileConventionRead().from_file(fname)</span>
<span class="sd">    &gt;&gt;&gt; meta_info = convention.get_info_from_file(fname)</span>
<span class="sd">    &gt;&gt;&gt; for k, v in meta_info.items(): print(k, v)</span>
<span class="sd">    year 2008</span>
<span class="sd">    var_name od550aer</span>
<span class="sd">    ts_type daily</span>
<span class="sd">    &gt;&gt;&gt; cubes = load(fname)</span>
<span class="sd">    &gt;&gt;&gt; lons = cubes[0].coord(&quot;longitude&quot;).points</span>
<span class="sd">    &gt;&gt;&gt; meridian_centre = True if lons.max() &gt; 180 else False</span>
<span class="sd">    &gt;&gt;&gt; year = meta_info[&quot;year&quot;]</span>
<span class="sd">    &gt;&gt;&gt; c = get_constraint(lon_range=(50, 150), </span>
<span class="sd">    ...                    lat_range=(20, 60), </span>
<span class="sd">    ...                    time_range=(&quot;%s-02-05&quot; %year, &quot;%s-02-25&quot; %year))</span>
<span class="sd">    &gt;&gt;&gt; cube_crop = cubes.extract(c)[0]</span>
<span class="sd">    &gt;&gt;&gt; cube_crop.shape</span>
<span class="sd">    (21, 40, 100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">lon_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_lon_rng_constraint</span><span class="p">(</span><span class="n">lon_range</span><span class="p">,</span> <span class="n">meridian_centre</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">lat_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_lat_rng_constraint</span><span class="p">(</span><span class="n">lat_range</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">time_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_time_rng_constraint</span><span class="p">(</span><span class="o">*</span><span class="n">time_range</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cadd</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="n">cadd</span>
    <span class="k">return</span> <span class="n">c</span></div>
    
<div class="viewcode-block" id="get_lat_rng_constraint"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.get_lat_rng_constraint">[docs]</a><span class="k">def</span> <span class="nf">get_lat_rng_constraint</span><span class="p">(</span><span class="n">lat_range</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create latitude constraint based on input range</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lat_range : tuple</span>
<span class="sd">        2-element tuple specifying latitude range</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.Constraint</span>
<span class="sd">        the corresponding iris.Constraint instance</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">lat_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">lat_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>
    
<div class="viewcode-block" id="get_lon_rng_constraint"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.get_lon_rng_constraint">[docs]</a><span class="k">def</span> <span class="nf">get_lon_rng_constraint</span><span class="p">(</span><span class="n">lon_range</span><span class="p">,</span> <span class="n">meridian_centre</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create longitude constraint based on input range</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lon_range : tuple</span>
<span class="sd">        2-element tuple containing from left -&gt; right end of range</span>
<span class="sd">    meridian_centre : bool</span>
<span class="sd">        specifies the coordinate definition range of longitude array of the </span>
<span class="sd">        data to be cropped. If True, then -180 -&gt; 180 is assumed, else 0 -&gt; 360</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.Constraint</span>
<span class="sd">        the corresponding iris.Constraint instance </span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        if first coordinate in lon_range equals or exceeds second</span>
<span class="sd">    LongitudeConstraintError</span>
<span class="sd">        if the input implies cropping over border of longitude array</span>
<span class="sd">        (e.g. 160 -&gt; - 160 if -180 &lt;= lon &lt;= 180).</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; from pyaerocom.io.testfiles import get</span>
<span class="sd">    &gt;&gt;&gt; from pyaerocom import GriddedData</span>
<span class="sd">    &gt;&gt;&gt; files = get()</span>
<span class="sd">    &gt;&gt;&gt; data = GriddedData(files[&#39;models&#39;][&#39;aatsr_su_v4.3&#39;], var_name=&quot;od550aer&quot;)</span>
<span class="sd">    &gt;&gt;&gt; c = get_lon_rng_constraint(lon_range=(170, -160), meridian_centre=True)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">     ...</span>
<span class="sd">    ValueError: Left coordinate must exceed right coordinate</span>
<span class="sd">    &gt;&gt;&gt; c = get_lon_rng_constraint(lon_range=(-30, 30), meridian_centre=True)</span>
<span class="sd">    &gt;&gt;&gt; data_crop = data.extract(c)</span>
<span class="sd">    &gt;&gt;&gt; assert data_crop.grid.shape == (366, 180, 60)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">lon_range</span>
    <span class="k">if</span> <span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the specified values are equal&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="n">right</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Left coordinate must exceed right coordinate&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">meridian_centre</span><span class="p">:</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="mi">180</span><span class="p">)</span><span class="o">%</span><span class="mi">360</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="p">(</span><span class="n">right</span><span class="o">+</span><span class="mi">180</span><span class="p">)</span><span class="o">%</span><span class="mi">360</span><span class="o">-</span><span class="mi">180</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">left</span><span class="o">%</span><span class="mi">360</span><span class="p">,</span> <span class="n">right</span><span class="o">%</span><span class="mi">360</span>
    <span class="k">if</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="n">right</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot crop over right border of longitude range&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LongitudeConstraintError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">left</span> <span class="o">&lt;=</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_time_rng_constraint"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.get_time_rng_constraint">[docs]</a><span class="k">def</span> <span class="nf">get_time_rng_constraint</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create iris.Constraint for data extraction along time axis</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start : :obj:`Timestamp` or :obj:` str`</span>
<span class="sd">        start time of desired subset. If string, it must be convertible </span>
<span class="sd">        into :class:`pandas.Timestamp` (e.g. &quot;2012-1-1&quot;)</span>
<span class="sd">    stop : :obj:`Timestamp` or :obj:` str`</span>
<span class="sd">        start time of desired subset. If string, it must be convertible </span>
<span class="sd">        into :class:`pandas.Timestamp` (e.g. &quot;2012-1-1&quot;)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.Constraint</span>
<span class="sd">        iris Constraint instance that can, e.g., be used as input for</span>
<span class="sd">        :func:`pyaerocom.griddeddata.GriddedData.extract`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">):</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
        
    <span class="n">t_lower</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">PartialDateTime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">start</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                                        <span class="n">month</span><span class="o">=</span><span class="n">start</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                        <span class="n">day</span><span class="o">=</span><span class="n">start</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">t_upper</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">PartialDateTime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">stop</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                                        <span class="n">month</span><span class="o">=</span><span class="n">stop</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                        <span class="n">day</span><span class="o">=</span><span class="n">stop</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cell</span><span class="p">:</span> <span class="n">t_lower</span> <span class="o">&lt;=</span> <span class="n">cell</span> <span class="o">&lt;=</span> <span class="n">t_upper</span><span class="p">)</span></div>

<div class="viewcode-block" id="to_time_series_griesie"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.to_time_series_griesie">[docs]</a><span class="k">def</span> <span class="nf">to_time_series_griesie</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;zdust&#39;</span><span class="p">],</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;small helper routine to convert data from the object</span>
<span class="sd">    pyaerocom.io.ReadGridded.interpolate to the obs data dictionary</span>
<span class="sd">    containing the pandas timeseries</span>

<span class="sd">    FOR TESTING ONLY!&quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)):</span>
        <span class="n">_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_dict</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">lats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">_dict</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">lons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_name</span><span class="p">:</span>
            <span class="n">_dict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>

<span class="c1"># TODO: Review and move into test-suite</span>
<div class="viewcode-block" id="griesie_dataframe_testing"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.griesie_dataframe_testing">[docs]</a><span class="k">def</span> <span class="nf">griesie_dataframe_testing</span><span class="p">(</span><span class="n">model_data</span><span class="p">,</span> <span class="n">obs_data</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;testing routine to create a scatterplot using a pandas data frame&quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">pyaerocom.io</span> <span class="k">as</span> <span class="nn">pio</span>
    <span class="kn">import</span> <span class="nn">pyaerocom</span> <span class="k">as</span> <span class="nn">pa</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

    <span class="n">obs_data_as_series</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">to_timeseries</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">startdate</span><span class="p">,</span> 
                                                <span class="n">end_date</span><span class="o">=</span><span class="n">enddate</span><span class="p">,</span> 
                                                <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    <span class="n">obs_lats</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">latitude</span>
    <span class="n">obs_lons</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">longitude</span>
    <span class="n">obs_lats</span><span class="o">=</span><span class="p">[</span><span class="n">obs_data_as_series</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_data_as_series</span><span class="p">))]</span>
    <span class="n">obs_lons</span><span class="o">=</span><span class="p">[</span><span class="n">obs_data_as_series</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_data_as_series</span><span class="p">))]</span>
    <span class="n">obs_names</span><span class="o">=</span><span class="p">[</span><span class="n">obs_data_as_series</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;station_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_data_as_series</span><span class="p">))]</span>
    <span class="n">model_station_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">interpolate</span><span class="p">([(</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="n">obs_lats</span><span class="p">),(</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="n">obs_lons</span><span class="p">)])</span>
    <span class="n">times_as_dt64</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">cftime_to_datetime64</span><span class="p">(</span><span class="n">model_station_data</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
    <span class="n">model_data_as_series</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">to_time_series_griesie</span><span class="p">(</span><span class="n">model_station_data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">obs_lats</span><span class="p">,</span> <span class="n">obs_lons</span><span class="p">,</span> <span class="n">times_as_dt64</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">obs_lats</span><span class="p">)</span></div>
    <span class="c1"># # single station</span>
    <span class="c1"># df = pd.DataFrame(obs_data_as_series[1][&#39;zdust&#39;], columns=[&#39;obs&#39;])</span>
    <span class="c1"># df[&#39;model&#39;] = model_data_as_series[1][&#39;zdust&#39;]</span>
    <span class="c1"># # remove points where any of the df is NaN</span>
    <span class="c1"># #df = df.dropna(axis=0, how=&#39;any&#39;)</span>
    <span class="c1"># correlation = df.corr(method=&#39;pearson&#39;)</span>
    <span class="c1"># plot = df.plot.scatter(&#39;obs&#39;,&#39;model&#39;)</span>
    <span class="c1"># df.show()</span>

<span class="c1"># TODO: review and move into test-suite</span>
<div class="viewcode-block" id="griesie_xarray_to_timeseries"><a class="viewcode-back" href="../../api.html#pyaerocom.helpers.griesie_xarray_to_timeseries">[docs]</a><span class="k">def</span> <span class="nf">griesie_xarray_to_timeseries</span><span class="p">(</span><span class="n">xarray_obj</span><span class="p">,</span> <span class="n">obs_lats</span><span class="p">,</span> <span class="n">obs_lons</span><span class="p">,</span> 
                                 <span class="n">vars_to_retrieve</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;od550_aer&#39;</span><span class="p">],</span> 
                                 <span class="n">debug_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;test routine to colocate xarray object&quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">debug_mode</span><span class="p">:</span>
        <span class="n">max_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_lats</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_index</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_index</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">xarray_col</span> <span class="o">=</span> <span class="n">xarray_obj</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">obs_lats</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> 
                                    <span class="n">longitude</span><span class="o">=</span><span class="n">obs_lons</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> 
                                    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># _dict[&#39;latitude&#39;] = obs_lats[index]</span>
        <span class="c1"># _dict[&#39;longitude&#39;] = obs_lons[index]</span>
        <span class="n">_dict</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">(</span><span class="n">xarray_col</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">])</span>
        <span class="n">_dict</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">(</span><span class="n">xarray_col</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">])</span>

        <span class="c1">#data_frame = xarray_col.to_dataframe()</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_to_retrieve</span><span class="p">:</span>
            <span class="c1"># _dict[var] = pd.Series(data_frame[var])</span>
            <span class="c1"># _dict[var] = xarray_col[var].to_series()</span>
            <span class="n">_dict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">xarray_col</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">xarray_col</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> 
                                   <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">TS_TYPE_TO_PANDAS_FREQ</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">PANDAS_FREQ_TO_TS_TYPE</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">TS_TYPE_TO_NUMPY_FREQ</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">NUMPY_FREQ_TO_TS_TYPE</span><span class="p">)</span>

    <span class="n">isrange</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, met.no.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/language_data.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>